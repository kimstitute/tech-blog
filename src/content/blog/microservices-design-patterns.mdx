---
title: "å¾®æœåŠ¡è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µæ·±åº¦è§£æ"
description: "æ·±å…¥æ¢è®¨å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒè®¾è®¡æ¨¡å¼ã€å®ç°åŸç†å’Œæœ€ä½³å®è·µï¼Œç»“åˆå®é™…é¡¹ç›®ç»éªŒåˆ†äº«å¾®æœåŠ¡ç³»ç»Ÿè®¾è®¡å’Œæ²»ç†è¦ç‚¹ã€‚"
pubDate: 2024-12-28
updatedDate: 2024-12-28
tags: ["microservices", "design-patterns", "architecture", "spring-cloud", "distributed", "interview", "best-practices"]
categories: ["middleware"]
subject: "å¾®æœåŠ¡æ¶æ„"
draft: false
featured: true
author: "Gerrad Zhang"
location: "æ­¦æ±‰ï¼Œä¸­å›½"
---

## ğŸ¤” é—®é¢˜èƒŒæ™¯ä¸æŠ€æœ¯æ¼”è¿›

### æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

éšç€ä¸šåŠ¡å¤æ‚åº¦çš„å¢é•¿ï¼Œå•ä½“åº”ç”¨é¢ä¸´è¯¸å¤šæŒ‘æˆ˜ï¼Œå¾®æœåŠ¡æ¶æ„åº”è¿è€Œç”Ÿï¼š

- **å•ä½“åº”ç”¨ç“¶é¢ˆ**ï¼šä»£ç åº“åºå¤§ï¼Œéƒ¨ç½²å›°éš¾ï¼ŒæŠ€æœ¯æ ˆå›ºåŒ–
- **å›¢é˜Ÿåä½œé—®é¢˜**ï¼šå¤šå›¢é˜Ÿå¼€å‘åŒä¸€ä¸ªåº”ç”¨ï¼Œä»£ç å†²çªé¢‘ç¹
- **æ‰©å±•æ€§é™åˆ¶**ï¼šæ— æ³•é’ˆå¯¹ç‰¹å®šæ¨¡å—è¿›è¡Œç‹¬ç«‹æ‰©å±•
- **æŠ€æœ¯å€ºåŠ¡ç§¯ç´¯**ï¼šå†å²ä»£ç éš¾ä»¥é‡æ„ï¼Œæ–°æŠ€æœ¯éš¾ä»¥å¼•å…¥
- **æ•…éšœå½±å“èŒƒå›´å¤§**ï¼šä¸€ä¸ªæ¨¡å—çš„é—®é¢˜å¯èƒ½å¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒ

### æ²¡æœ‰å¾®æœåŠ¡æ¶æ„æ—¶æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

ä¼ ç»Ÿå•ä½“åº”ç”¨çš„å…¸å‹æ¶æ„ï¼š

```java
// ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼šæ‰€æœ‰åŠŸèƒ½åœ¨ä¸€ä¸ªåº”ç”¨ä¸­
@SpringBootApplication
public class MonolithApplication {
    
    @RestController
    public class OrderController {
        
        @Autowired
        private OrderService orderService;
        
        @Autowired
        private InventoryService inventoryService;
        
        @Autowired
        private PaymentService paymentService;
        
        @PostMapping("/orders")
        public ResponseEntity<Order> createOrder(@RequestBody CreateOrderRequest request) {
            // æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨åŒä¸€ä¸ªåº”ç”¨ä¸­
            Order order = orderService.createOrder(request);
            inventoryService.deductStock(request.getProductId(), request.getQuantity());
            paymentService.processPayment(order.getPaymentInfo());
            
            return ResponseEntity.ok(order);
        }
    }
}
```

**å•ä½“æ¶æ„çš„é—®é¢˜**ï¼š
- ä»£ç è€¦åˆåº¦é«˜ï¼Œéš¾ä»¥ç»´æŠ¤
- éƒ¨ç½²å¿…é¡»æ•´ä½“è¿›è¡Œ
- æŠ€æœ¯æ ˆç»Ÿä¸€ï¼Œæ— æ³•çµæ´»é€‰æ‹©
- å•ç‚¹æ•…éšœé£é™©
- å›¢é˜Ÿå¼€å‘æ•ˆç‡ä½

### æŠ€æœ¯æ¼”è¿›çš„å†å²è„‰ç»œ

å¾®æœåŠ¡æ¶æ„çš„å‘å±•å†ç¨‹ï¼š

1. **SOAæ—¶ä»£**ï¼ˆ2000-2005ï¼‰ï¼šé¢å‘æœåŠ¡æ¶æ„ï¼Œé‡é‡çº§ESB
2. **WebæœåŠ¡å…´èµ·**ï¼ˆ2005-2010ï¼‰ï¼šSOAPã€REST APIæ ‡å‡†åŒ–
3. **å¾®æœåŠ¡æ¦‚å¿µå½¢æˆ**ï¼ˆ2010-2015ï¼‰ï¼šNetflixã€Amazonç­‰å…¬å¸å®è·µ
4. **ç”Ÿæ€å·¥å…·å®Œå–„**ï¼ˆ2015-2020ï¼‰ï¼šSpring Cloudã€Kubernetesç­‰
5. **Service Meshæ—¶ä»£**ï¼ˆ2020è‡³ä»Šï¼‰ï¼šIstioã€Linkerdç­‰åŸºç¡€è®¾æ–½å±‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µä¸åŸç†

### å¾®æœåŠ¡æ¶æ„æ ¸å¿ƒåŸåˆ™

å¾®æœåŠ¡æ¶æ„éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

```java
/**
 * å¾®æœåŠ¡è®¾è®¡åŸåˆ™
 */
public class MicroservicesPrinciples {
    
    /**
     * å•ä¸€èŒè´£åŸåˆ™ - æ¯ä¸ªæœåŠ¡åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
     */
    public void singleResponsibility() {
        // ç”¨æˆ·æœåŠ¡åªå¤„ç†ç”¨æˆ·ç›¸å…³ä¸šåŠ¡
        // è®¢å•æœåŠ¡åªå¤„ç†è®¢å•ç›¸å…³ä¸šåŠ¡
        // æ”¯ä»˜æœåŠ¡åªå¤„ç†æ”¯ä»˜ç›¸å…³ä¸šåŠ¡
    }
    
    /**
     * æœåŠ¡è‡ªæ²»åŸåˆ™ - æœåŠ¡æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®å­˜å‚¨å’Œä¸šåŠ¡é€»è¾‘
     */
    public void serviceAutonomy() {
        // æ¯ä¸ªæœåŠ¡æœ‰è‡ªå·±çš„æ•°æ®åº“
        // æœåŠ¡é—´é€šè¿‡APIé€šä¿¡ï¼Œä¸ç›´æ¥è®¿é—®å…¶ä»–æœåŠ¡çš„æ•°æ®åº“
    }
    
    /**
     * å»ä¸­å¿ƒåŒ–åŸåˆ™ - é¿å…å•ç‚¹æ•…éšœå’Œæ€§èƒ½ç“¶é¢ˆ
     */
    public void decentralization() {
        // æ•°æ®ç®¡ç†å»ä¸­å¿ƒåŒ–
        // æ²»ç†å»ä¸­å¿ƒåŒ–
        // æŠ€æœ¯æ ˆå»ä¸­å¿ƒåŒ–
    }
    
    /**
     * æ•…éšœéš”ç¦»åŸåˆ™ - ä¸€ä¸ªæœåŠ¡çš„æ•…éšœä¸åº”è¯¥å½±å“å…¶ä»–æœåŠ¡
     */
    public void faultIsolation() {
        // æœåŠ¡é—´é€šè¿‡ç½‘ç»œé€šä¿¡
        // å®ç°ç†”æ–­ã€é™çº§æœºåˆ¶
        // å¼‚æ­¥å¤„ç†å‡å°‘ä¾èµ–
    }
}
```

### å¾®æœåŠ¡æ‹†åˆ†ç­–ç•¥

å¦‚ä½•åˆç†æ‹†åˆ†å¾®æœåŠ¡æ˜¯æ¶æ„è®¾è®¡çš„å…³é”®ï¼š

```java
/**
 * å¾®æœåŠ¡æ‹†åˆ†ç­–ç•¥
 */
public class ServiceDecomposition {
    
    /**
     * æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ† (Business Capability)
     */
    public void byBusinessCapability() {
        // ç”¨æˆ·ç®¡ç†æœåŠ¡ï¼šæ³¨å†Œã€ç™»å½•ã€ä¸ªäººä¿¡æ¯
        // å•†å“ç®¡ç†æœåŠ¡ï¼šå•†å“ä¿¡æ¯ã€åº“å­˜ç®¡ç†
        // è®¢å•ç®¡ç†æœåŠ¡ï¼šè®¢å•åˆ›å»ºã€çŠ¶æ€è·Ÿè¸ª
        // æ”¯ä»˜æœåŠ¡ï¼šæ”¯ä»˜å¤„ç†ã€è´¦å•ç®¡ç†
    }
    
    /**
     * æŒ‰æ•°æ®æ‹†åˆ† (Data-driven)
     */
    public void byData() {
        // æ¯ä¸ªæœåŠ¡ç®¡ç†è‡ªå·±çš„æ•°æ®
        // é¿å…è·¨æœåŠ¡çš„æ•°æ®äº‹åŠ¡
    }
    
    /**
     * æŒ‰å›¢é˜Ÿæ‹†åˆ† (Team-oriented)
     */
    public void byTeam() {
        // åº·å¨å®šå¾‹ï¼šç»„ç»‡æ¶æ„å†³å®šç³»ç»Ÿæ¶æ„
        // ä¸€ä¸ªå›¢é˜Ÿè´Ÿè´£ä¸€ä¸ªæˆ–å‡ ä¸ªç›¸å…³æœåŠ¡
    }
    
    /**
     * æŒ‰æŠ€æœ¯æ ˆæ‹†åˆ† (Technology-driven)
     */
    public void byTechnology() {
        // ä¸åŒæœåŠ¡å¯ä»¥ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆ
        // Javaã€Pythonã€Goç­‰æ··åˆä½¿ç”¨
    }
}
```

## ğŸ”§ å®ç°åŸç†ä¸æºç åˆ†æ

### æœåŠ¡æ³¨å†Œä¸å‘ç°

æœåŠ¡æ³¨å†Œä¸å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„çš„åŸºç¡€ï¼š

```java
/**
 * æœåŠ¡æ³¨å†Œä¸å‘ç°å®ç°
 */
@SpringBootApplication
@EnableEurekaServer
public class ServiceRegistryApplication {
    public static void main(String[] args) {
        SpringApplication.run(ServiceRegistryApplication.class, args);
    }
}

@RestController
@EnableEurekaClient
public class UserServiceController {
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    @Autowired
    private LoadBalancerClient loadBalancer;
    
    /**
     * æœåŠ¡å‘ç°ç¤ºä¾‹
     */
    @GetMapping("/user/{id}/orders")
    public List<Order> getUserOrders(@PathVariable Long id) {
        // 1. é€šè¿‡æœåŠ¡å‘ç°è·å–è®¢å•æœåŠ¡å®ä¾‹
        ServiceInstance instance = loadBalancer.choose("order-service");
        
        if (instance == null) {
            throw new ServiceUnavailableException("Order service not available");
        }
        
        // 2. æ„å»ºè¯·æ±‚URL
        String url = String.format("http://%s:%d/orders/user/%d", 
            instance.getHost(), instance.getPort(), id);
        
        // 3. å‘èµ·HTTPè¯·æ±‚
        RestTemplate restTemplate = new RestTemplate();
        List<Order> orders = restTemplate.exchange(url, HttpMethod.GET, null, 
            new ParameterizedTypeReference<List<Order>>() {}).getBody();
        
        return orders;
    }
    
    /**
     * ä½¿ç”¨Feignç®€åŒ–æœåŠ¡è°ƒç”¨
     */
    @Autowired
    private OrderServiceClient orderServiceClient;
    
    @GetMapping("/user/{id}/orders/feign")
    public List<Order> getUserOrdersWithFeign(@PathVariable Long id) {
        return orderServiceClient.getOrdersByUserId(id);
    }
}

/**
 * Feignå®¢æˆ·ç«¯å®šä¹‰
 */
@FeignClient(name = "order-service", fallback = OrderServiceFallback.class)
public interface OrderServiceClient {
    
    @GetMapping("/orders/user/{userId}")
    List<Order> getOrdersByUserId(@PathVariable("userId") Long userId);
    
    @PostMapping("/orders")
    Order createOrder(@RequestBody CreateOrderRequest request);
}

/**
 * æœåŠ¡é™çº§å®ç°
 */
@Component
public class OrderServiceFallback implements OrderServiceClient {
    
    @Override
    public List<Order> getOrdersByUserId(Long userId) {
        // è¿”å›ç©ºåˆ—è¡¨æˆ–ç¼“å­˜æ•°æ®
        return Collections.emptyList();
    }
    
    @Override
    public Order createOrder(CreateOrderRequest request) {
        // è¿”å›é»˜è®¤å“åº”æˆ–æŠ›å‡ºå¼‚å¸¸
        throw new ServiceUnavailableException("Order service is currently unavailable");
    }
}
```

### APIç½‘å…³æ¨¡å¼

APIç½‘å…³ä½œä¸ºå¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ï¼š

```java
/**
 * Spring Cloud Gatewayé…ç½®
 */
@Configuration
public class GatewayConfig {
    
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            // ç”¨æˆ·æœåŠ¡è·¯ç”±
            .route("user-service", r -> r.path("/api/users/**")
                .filters(f -> f
                    .stripPrefix(1)
                    .addRequestHeader("X-Gateway", "Spring-Cloud-Gateway")
                    .circuitBreaker(config -> config
                        .setName("user-service-cb")
                        .setFallbackUri("forward:/fallback/user")))
                .uri("lb://user-service"))
            
            // è®¢å•æœåŠ¡è·¯ç”±
            .route("order-service", r -> r.path("/api/orders/**")
                .filters(f -> f
                    .stripPrefix(1)
                    .retry(config -> config
                        .setRetries(3)
                        .setMethods(HttpMethod.GET)
                        .setBackoff(Duration.ofMillis(100), Duration.ofMillis(1000), 2, true)))
                .uri("lb://order-service"))
            
            // æ”¯ä»˜æœåŠ¡è·¯ç”±
            .route("payment-service", r -> r.path("/api/payments/**")
                .filters(f -> f
                    .stripPrefix(1)
                    .requestRateLimiter(config -> config
                        .setRateLimiter(redisRateLimiter())
                        .setKeyResolver(userKeyResolver())))
                .uri("lb://payment-service"))
            
            .build();
    }
    
    @Bean
    public RedisRateLimiter redisRateLimiter() {
        return new RedisRateLimiter(10, 20, 1);
    }
    
    @Bean
    public KeyResolver userKeyResolver() {
        return exchange -> {
            String userId = exchange.getRequest().getHeaders().getFirst("X-User-ID");
            return Mono.just(userId != null ? userId : "anonymous");
        };
    }
}

/**
 * å…¨å±€è¿‡æ»¤å™¨ - è®¤è¯æˆæƒ
 */
@Component
public class AuthenticationGlobalFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private JwtTokenUtil jwtTokenUtil;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        
        // è·³è¿‡è®¤è¯çš„è·¯å¾„
        if (isPublicPath(request.getPath().value())) {
            return chain.filter(exchange);
        }
        
        // æå–JWT token
        String token = extractToken(request);
        if (token == null) {
            return unauthorizedResponse(exchange);
        }
        
        try {
            // éªŒè¯token
            Claims claims = jwtTokenUtil.parseToken(token);
            
            // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
            ServerHttpRequest modifiedRequest = request.mutate()
                .header("X-User-ID", claims.getSubject())
                .header("X-User-Roles", String.join(",", getRoles(claims)))
                .build();
            
            return chain.filter(exchange.mutate().request(modifiedRequest).build());
            
        } catch (Exception e) {
            return unauthorizedResponse(exchange);
        }
    }
    
    @Override
    public int getOrder() {
        return -100; // é«˜ä¼˜å…ˆçº§
    }
    
    private boolean isPublicPath(String path) {
        return path.startsWith("/api/auth/") || path.startsWith("/api/public/");
    }
}
```

### åˆ†å¸ƒå¼é…ç½®ç®¡ç†

é…ç½®ä¸­å¿ƒå®ç°åŠ¨æ€é…ç½®ç®¡ç†ï¼š

```java
/**
 * Spring Cloud Config Server
 */
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}

/**
 * é…ç½®å®¢æˆ·ç«¯ä½¿ç”¨
 */
@RestController
@RefreshScope
public class ConfigClientController {
    
    @Value("${app.feature.enabled:false}")
    private boolean featureEnabled;
    
    @Value("${app.message:Hello}")
    private String message;
    
    @GetMapping("/config")
    public Map<String, Object> getConfig() {
        Map<String, Object> config = new HashMap<>();
        config.put("featureEnabled", featureEnabled);
        config.put("message", message);
        return config;
    }
}

/**
 * é…ç½®å˜æ›´ç›‘å¬
 */
@Component
public class ConfigChangeListener {
    
    @EventListener
    public void handleConfigChange(RefreshRemoteApplicationEvent event) {
        log.info("Configuration changed for services: {}", event.getDestinationService());
        
        // å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œé…ç½®å˜æ›´åçš„é€»è¾‘
        // æ¯”å¦‚åˆ·æ–°ç¼“å­˜ã€é‡æ–°åˆå§‹åŒ–ç»„ä»¶ç­‰
    }
    
    @EventListener
    public void handleEnvironmentChange(EnvironmentChangeEvent event) {
        log.info("Environment properties changed: {}", event.getKeys());
        
        // å¤„ç†ç¯å¢ƒå˜é‡å˜æ›´
        for (String key : event.getKeys()) {
            log.info("Property {} changed", key);
        }
    }
}
```

### åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

å®ç°è¯·æ±‚çš„å…¨é“¾è·¯è¿½è¸ªï¼š

```java
/**
 * Sleuthé…ç½®
 */
@Configuration
public class TracingConfig {
    
    @Bean
    public Sender sender() {
        return OkHttpSender.create("http://zipkin-server:9411/api/v2/spans");
    }
    
    @Bean
    public AsyncReporter<Span> spanReporter() {
        return AsyncReporter.create(sender());
    }
    
    @Bean
    public Tracing tracing() {
        return Tracing.newBuilder()
            .localServiceName("user-service")
            .spanReporter(spanReporter())
            .sampler(Sampler.create(1.0f)) // 100%é‡‡æ ·
            .build();
    }
}

/**
 * è‡ªå®šä¹‰é“¾è·¯è¿½è¸ª
 */
@Service
public class UserService {
    
    @Autowired
    private Tracing tracing;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private OrderServiceClient orderServiceClient;
    
    @NewSpan("user-service-get-user-with-orders")
    public UserWithOrders getUserWithOrders(@SpanTag("userId") Long userId) {
        // 1. è·å–ç”¨æˆ·ä¿¡æ¯
        Span userSpan = tracing.tracer().nextSpan()
            .name("get-user-from-db")
            .tag("userId", String.valueOf(userId))
            .start();
        
        try (Tracer.SpanInScope ws = tracing.tracer().withSpanInScope(userSpan)) {
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("User not found: " + userId));
            
            userSpan.tag("user.found", "true");
            
            // 2. è·å–ç”¨æˆ·è®¢å•
            List<Order> orders = getUserOrders(userId);
            
            return new UserWithOrders(user, orders);
            
        } catch (Exception e) {
            userSpan.tag("error", e.getMessage());
            throw e;
        } finally {
            userSpan.end();
        }
    }
    
    @NewSpan("get-user-orders")
    private List<Order> getUserOrders(@SpanTag("userId") Long userId) {
        // è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„span
        return orderServiceClient.getOrdersByUserId(userId);
    }
}

/**
 * é“¾è·¯è¿½è¸ªæ‹¦æˆªå™¨
 */
@Component
public class TracingInterceptor implements HandlerInterceptor {
    
    @Autowired
    private Tracing tracing;
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        Span span = tracing.tracer().nextSpan()
            .name(request.getMethod() + " " + request.getRequestURI())
            .tag("http.method", request.getMethod())
            .tag("http.url", request.getRequestURL().toString())
            .tag("user.agent", request.getHeader("User-Agent"))
            .start();
        
        request.setAttribute("currentSpan", span);
        
        try (Tracer.SpanInScope ws = tracing.tracer().withSpanInScope(span)) {
            return true;
        }
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, 
                               Object handler, Exception ex) {
        Span span = (Span) request.getAttribute("currentSpan");
        if (span != null) {
            span.tag("http.status_code", String.valueOf(response.getStatus()));
            if (ex != null) {
                span.tag("error", ex.getMessage());
            }
            span.end();
        }
    }
}
```

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ä¸ä»£ç ç¤ºä¾‹

### ç”µå•†å¾®æœåŠ¡æ¶æ„è®¾è®¡

è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿï¼š

```java
/**
 * ç”¨æˆ·æœåŠ¡
 */
@RestController
@RequestMapping("/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }
    
    @PostMapping
    public ResponseEntity<User> createUser(@RequestBody @Valid CreateUserRequest request) {
        User user = userService.createUser(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(user);
    }
    
    @PutMapping("/{id}")
    public ResponseEntity<User> updateUser(@PathVariable Long id, 
                                          @RequestBody @Valid UpdateUserRequest request) {
        User user = userService.updateUser(id, request);
        return ResponseEntity.ok(user);
    }
}

/**
 * å•†å“æœåŠ¡
 */
@RestController
@RequestMapping("/products")
public class ProductController {
    
    @Autowired
    private ProductService productService;
    
    @GetMapping
    public ResponseEntity<Page<Product>> getProducts(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(required = false) String category,
            @RequestParam(required = false) String keyword) {
        
        ProductSearchCriteria criteria = ProductSearchCriteria.builder()
            .category(category)
            .keyword(keyword)
            .build();
        
        Pageable pageable = PageRequest.of(page, size);
        Page<Product> products = productService.searchProducts(criteria, pageable);
        
        return ResponseEntity.ok(products);
    }
    
    @GetMapping("/{id}")
    public ResponseEntity<Product> getProduct(@PathVariable Long id) {
        Product product = productService.findById(id);
        return ResponseEntity.ok(product);
    }
    
    @PostMapping
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Product> createProduct(@RequestBody @Valid CreateProductRequest request) {
        Product product = productService.createProduct(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(product);
    }
}

/**
 * è®¢å•æœåŠ¡
 */
@RestController
@RequestMapping("/orders")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping
    public ResponseEntity<OrderResponse> createOrder(
            @RequestBody @Valid CreateOrderRequest request,
            @RequestHeader("X-User-ID") Long userId) {
        
        OrderResponse response = orderService.createOrder(userId, request);
        return ResponseEntity.status(HttpStatus.CREATED).body(response);
    }
    
    @GetMapping("/user/{userId}")
    public ResponseEntity<List<Order>> getUserOrders(@PathVariable Long userId) {
        List<Order> orders = orderService.getOrdersByUserId(userId);
        return ResponseEntity.ok(orders);
    }
    
    @GetMapping("/{id}")
    public ResponseEntity<Order> getOrder(@PathVariable Long id) {
        Order order = orderService.findById(id);
        return ResponseEntity.ok(order);
    }
    
    @PutMapping("/{id}/status")
    public ResponseEntity<Void> updateOrderStatus(
            @PathVariable Long id,
            @RequestBody @Valid UpdateOrderStatusRequest request) {
        
        orderService.updateOrderStatus(id, request.getStatus());
        return ResponseEntity.noContent().build();
    }
}
```

### å¾®æœåŠ¡é—´é€šä¿¡æ¨¡å¼

å®ç°ä¸åŒçš„æœåŠ¡é—´é€šä¿¡æ–¹å¼ï¼š

```java
/**
 * åŒæ­¥é€šä¿¡ - REST API
 */
@Service
public class OrderService {
    
    @Autowired
    private UserServiceClient userServiceClient;
    
    @Autowired
    private ProductServiceClient productServiceClient;
    
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    @Transactional
    public OrderResponse createOrder(Long userId, CreateOrderRequest request) {
        // 1. éªŒè¯ç”¨æˆ·
        User user = userServiceClient.getUser(userId);
        if (user == null) {
            throw new UserNotFoundException("User not found: " + userId);
        }
        
        // 2. éªŒè¯å•†å“
        Product product = productServiceClient.getProduct(request.getProductId());
        if (product == null) {
            throw new ProductNotFoundException("Product not found: " + request.getProductId());
        }
        
        // 3. æ£€æŸ¥åº“å­˜
        boolean stockAvailable = inventoryServiceClient.checkStock(
            request.getProductId(), request.getQuantity());
        if (!stockAvailable) {
            throw new InsufficientStockException("Insufficient stock");
        }
        
        // 4. åˆ›å»ºè®¢å•
        Order order = Order.builder()
            .userId(userId)
            .productId(request.getProductId())
            .quantity(request.getQuantity())
            .amount(product.getPrice().multiply(BigDecimal.valueOf(request.getQuantity())))
            .status(OrderStatus.CREATED)
            .build();
        
        order = orderRepository.save(order);
        
        // 5. æ‰£å‡åº“å­˜
        inventoryServiceClient.deductStock(request.getProductId(), request.getQuantity());
        
        return OrderResponse.from(order);
    }
}

/**
 * å¼‚æ­¥é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ—
 */
@Service
public class EventDrivenOrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private OrderRepository orderRepository;
    
    public OrderResponse createOrderAsync(Long userId, CreateOrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆå¾…å¤„ç†çŠ¶æ€ï¼‰
        Order order = Order.builder()
            .userId(userId)
            .productId(request.getProductId())
            .quantity(request.getQuantity())
            .status(OrderStatus.PENDING)
            .build();
        
        order = orderRepository.save(order);
        
        // 2. å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        OrderCreatedEvent event = OrderCreatedEvent.builder()
            .orderId(order.getId())
            .userId(userId)
            .productId(request.getProductId())
            .quantity(request.getQuantity())
            .build();
        
        rabbitTemplate.convertAndSend("order.exchange", "order.created", event);
        
        return OrderResponse.from(order);
    }
    
    /**
     * å¤„ç†åº“å­˜æ‰£å‡ç»“æœ
     */
    @RabbitListener(queues = "inventory.deducted")
    public void handleInventoryDeducted(InventoryDeductedEvent event) {
        Order order = orderRepository.findById(event.getOrderId())
            .orElseThrow(() -> new OrderNotFoundException("Order not found"));
        
        if (event.isSuccess()) {
            order.setStatus(OrderStatus.CONFIRMED);
            
            // å‘å¸ƒè®¢å•ç¡®è®¤äº‹ä»¶
            OrderConfirmedEvent confirmedEvent = OrderConfirmedEvent.builder()
                .orderId(order.getId())
                .userId(order.getUserId())
                .amount(order.getAmount())
                .build();
            
            rabbitTemplate.convertAndSend("order.exchange", "order.confirmed", confirmedEvent);
        } else {
            order.setStatus(OrderStatus.CANCELLED);
            order.setCancelReason("Insufficient stock");
        }
        
        orderRepository.save(order);
    }
}
```

### å¾®æœåŠ¡ç›‘æ§ä¸æ²»ç†

å®ç°å…¨é¢çš„å¾®æœåŠ¡ç›‘æ§ï¼š

```java
/**
 * å¥åº·æ£€æŸ¥
 */
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Autowired
    private DataSource dataSource;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Override
    public Health health() {
        Health.Builder builder = Health.up();
        
        // æ£€æŸ¥æ•°æ®åº“è¿æ¥
        try {
            Connection connection = dataSource.getConnection();
            connection.close();
            builder.withDetail("database", "UP");
        } catch (Exception e) {
            builder.down().withDetail("database", "DOWN: " + e.getMessage());
        }
        
        // æ£€æŸ¥Redisè¿æ¥
        try {
            redisTemplate.opsForValue().get("health-check");
            builder.withDetail("redis", "UP");
        } catch (Exception e) {
            builder.withDetail("redis", "DOWN: " + e.getMessage());
        }
        
        // æ£€æŸ¥å¤–éƒ¨æœåŠ¡ä¾èµ–
        builder.withDetail("external-services", checkExternalServices());
        
        return builder.build();
    }
    
    private Map<String, String> checkExternalServices() {
        Map<String, String> services = new HashMap<>();
        
        // æ£€æŸ¥ç”¨æˆ·æœåŠ¡
        try {
            userServiceClient.healthCheck();
            services.put("user-service", "UP");
        } catch (Exception e) {
            services.put("user-service", "DOWN");
        }
        
        // æ£€æŸ¥æ”¯ä»˜æœåŠ¡
        try {
            paymentServiceClient.healthCheck();
            services.put("payment-service", "UP");
        } catch (Exception e) {
            services.put("payment-service", "DOWN");
        }
        
        return services;
    }
}

/**
 * æ€§èƒ½ç›‘æ§
 */
@Component
public class PerformanceMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Timer.Sample sample;
    
    public PerformanceMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.sample = Timer.start(meterRegistry);
    }
    
    @EventListener
    public void handleHttpRequest(HttpRequestEvent event) {
        Timer.builder("http.requests")
            .tag("method", event.getMethod())
            .tag("uri", event.getUri())
            .tag("status", String.valueOf(event.getStatus()))
            .register(meterRegistry)
            .record(event.getDuration(), TimeUnit.MILLISECONDS);
    }
    
    @EventListener
    public void handleServiceCall(ServiceCallEvent event) {
        Timer.builder("service.calls")
            .tag("service", event.getServiceName())
            .tag("method", event.getMethodName())
            .tag("success", String.valueOf(event.isSuccess()))
            .register(meterRegistry)
            .record(event.getDuration(), TimeUnit.MILLISECONDS);
    }
    
    @Scheduled(fixedRate = 60000)
    public void collectSystemMetrics() {
        // JVMå†…å­˜ä½¿ç”¨æƒ…å†µ
        Runtime runtime = Runtime.getRuntime();
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        long usedMemory = totalMemory - freeMemory;
        
        Gauge.builder("jvm.memory.used")
            .register(meterRegistry, () -> usedMemory);
        
        Gauge.builder("jvm.memory.total")
            .register(meterRegistry, () -> totalMemory);
        
        // çº¿ç¨‹æ•°
        ThreadMXBean threadBean = ManagementFactory.getThreadMXBean();
        Gauge.builder("jvm.threads.live")
            .register(meterRegistry, () -> threadBean.getThreadCount());
    }
}
```

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜ç²¾è®²

### 1. å¾®æœåŠ¡æ¶æ„æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
**ä¼˜ç‚¹**ï¼š
- æŠ€æœ¯æ ˆå¤šæ ·åŒ–ï¼Œå›¢é˜Ÿè‡ªä¸»é€‰æ‹©
- ç‹¬ç«‹éƒ¨ç½²ï¼Œå¿«é€Ÿè¿­ä»£
- æ•…éšœéš”ç¦»ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§
- å›¢é˜Ÿç‹¬ç«‹å¼€å‘ï¼Œæé«˜æ•ˆç‡

**ç¼ºç‚¹**ï¼š
- åˆ†å¸ƒå¼ç³»ç»Ÿå¤æ‚æ€§
- ç½‘ç»œå»¶è¿Ÿå’Œæ•…éšœ
- æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜
- è¿ç»´å¤æ‚åº¦å¢åŠ 

### 2. å¦‚ä½•æ‹†åˆ†å¾®æœåŠ¡ï¼Ÿæœ‰å“ªäº›åŸåˆ™ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
æ‹†åˆ†åŸåˆ™ï¼š
- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæœåŠ¡åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
- **é«˜å†…èšä½è€¦åˆ**ï¼šæœåŠ¡å†…éƒ¨ç´§å¯†ç›¸å…³ï¼ŒæœåŠ¡é—´æ¾æ•£è€¦åˆ
- **æ•°æ®ç‹¬ç«‹**ï¼šæ¯ä¸ªæœåŠ¡ç®¡ç†è‡ªå·±çš„æ•°æ®
- **å›¢é˜Ÿè§„æ¨¡**ï¼šéµå¾ªåº·å¨å®šå¾‹ï¼ŒæŒ‰å›¢é˜Ÿç»„ç»‡æ‹†åˆ†

**é¢è¯•æŠ€å·§**ï¼šç»“åˆDDDé¢†åŸŸé©±åŠ¨è®¾è®¡è¯´æ˜ã€‚

### 3. å¾®æœåŠ¡é—´å¦‚ä½•é€šä¿¡ï¼Ÿå„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **åŒæ­¥é€šä¿¡**ï¼šREST APIã€RPC
  - ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚ï¼Œå®æ—¶æ€§å¥½
  - ç¼ºç‚¹ï¼šè€¦åˆåº¦é«˜ï¼Œæ€§èƒ½å½±å“å¤§
- **å¼‚æ­¥é€šä¿¡**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶é©±åŠ¨
  - ä¼˜ç‚¹ï¼šè§£è€¦ï¼Œæ€§èƒ½å¥½ï¼Œå¯é æ€§é«˜
  - ç¼ºç‚¹ï¼šå¤æ‚æ€§å¢åŠ ï¼Œæœ€ç»ˆä¸€è‡´æ€§

### 4. å¦‚ä½•ä¿è¯å¾®æœåŠ¡çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼š2PCã€TCCã€Saga
- **äº‹ä»¶é©±åŠ¨**ï¼šæœ€ç»ˆä¸€è‡´æ€§
- **è¡¥å¿æœºåˆ¶**ï¼šä¸šåŠ¡å±‚é¢çš„æ•°æ®ä¿®å¤
- **å¹‚ç­‰è®¾è®¡**ï¼šé˜²æ­¢é‡å¤æ“ä½œ

### 5. å¾®æœåŠ¡çš„æœåŠ¡æ²»ç†åŒ…æ‹¬å“ªäº›æ–¹é¢ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **æœåŠ¡æ³¨å†Œå‘ç°**ï¼šEurekaã€Consul
- **è´Ÿè½½å‡è¡¡**ï¼šRibbonã€å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
- **ç†”æ–­é™çº§**ï¼šHystrixã€Resilience4j
- **APIç½‘å…³**ï¼šç»Ÿä¸€å…¥å£ã€è®¤è¯æˆæƒ
- **é…ç½®ç®¡ç†**ï¼šé›†ä¸­é…ç½®ã€åŠ¨æ€æ›´æ–°
- **ç›‘æ§å‘Šè­¦**ï¼šé“¾è·¯è¿½è¸ªã€æ€§èƒ½ç›‘æ§

### 6. å¦‚ä½•å¤„ç†å¾®æœåŠ¡çš„æ•…éšœå’Œé™çº§ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **ç†”æ–­å™¨æ¨¡å¼**ï¼šé˜²æ­¢æ•…éšœä¼ æ’­
- **èˆ±å£æ¨¡å¼**ï¼šèµ„æºéš”ç¦»
- **è¶…æ—¶æ§åˆ¶**ï¼šé¿å…é•¿æ—¶é—´ç­‰å¾…
- **é‡è¯•æœºåˆ¶**ï¼šæŒ‡æ•°é€€é¿é‡è¯•
- **é™çº§ç­–ç•¥**ï¼šæä¾›å¤‡ç”¨æ–¹æ¡ˆ

### 7. å¾®æœåŠ¡çš„éƒ¨ç½²ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **è“ç»¿éƒ¨ç½²**ï¼šé›¶åœæœºéƒ¨ç½²
- **æ»šåŠ¨éƒ¨ç½²**ï¼šé€æ­¥æ›¿æ¢å®ä¾‹
- **é‡‘ä¸é›€éƒ¨ç½²**ï¼šå°æµé‡éªŒè¯
- **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDocker + Kubernetes

### 8. å¦‚ä½•è®¾è®¡å¾®æœåŠ¡çš„APIï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **RESTfulè®¾è®¡**ï¼šéµå¾ªRESTåŸåˆ™
- **ç‰ˆæœ¬ç®¡ç†**ï¼šAPIç‰ˆæœ¬å…¼å®¹æ€§
- **å¹‚ç­‰æ€§**ï¼šç¡®ä¿æ“ä½œå¯é‡å¤
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€é”™è¯¯ç å’Œæ ¼å¼
- **æ–‡æ¡£åŒ–**ï¼šSwagger/OpenAPI

## âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### å¾®æœåŠ¡æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

```java
@Component
public class MicroserviceOptimizer {
    
    /**
     * è¿æ¥æ± ä¼˜åŒ–
     */
    @Bean
    public RestTemplate restTemplate() {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(5000);
        factory.setReadTimeout(10000);
        
        // è¿æ¥æ± é…ç½®
        PoolingHttpClientConnectionManager connectionManager = 
            new PoolingHttpClientConnectionManager();
        connectionManager.setMaxTotal(200);
        connectionManager.setDefaultMaxPerRoute(20);
        
        CloseableHttpClient httpClient = HttpClients.custom()
            .setConnectionManager(connectionManager)
            .build();
        
        factory.setHttpClient(httpClient);
        return new RestTemplate(factory);
    }
    
    /**
     * ç¼“å­˜ä¼˜åŒ–
     */
    @Cacheable(value = "users", key = "#id")
    public User getUser(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    /**
     * å¼‚æ­¥å¤„ç†ä¼˜åŒ–
     */
    @Async
    public CompletableFuture<Void> processOrderAsync(Order order) {
        // å¼‚æ­¥å¤„ç†éå…³é”®ä¸šåŠ¡
        return CompletableFuture.runAsync(() -> {
            sendOrderNotification(order);
            updateAnalytics(order);
        });
    }
}
```

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

1. **æœåŠ¡é›ªå´©**ï¼šå®ç°ç†”æ–­å™¨å’Œé™æµ
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„
3. **æ€§èƒ½ç“¶é¢ˆ**ï¼šä¼˜åŒ–æœåŠ¡è°ƒç”¨é“¾è·¯
4. **è¿ç»´å¤æ‚**ï¼šä½¿ç”¨å®¹å™¨åŒ–å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²

## ğŸ“š æ€»ç»“ä¸æŠ€æœ¯å¯¹æ¯”

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

å¾®æœåŠ¡æ¶æ„æ˜¯ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿçš„é‡è¦æ¨¡å¼ï¼š

1. **åˆç†æ‹†åˆ†**ï¼šåŸºäºä¸šåŠ¡é¢†åŸŸå’Œå›¢é˜Ÿç»“æ„
2. **æœåŠ¡æ²»ç†**ï¼šå®Œå–„çš„æ³¨å†Œå‘ç°ã€ç›‘æ§å‘Šè­¦
3. **é€šä¿¡æœºåˆ¶**ï¼šé€‰æ‹©åˆé€‚çš„åŒæ­¥/å¼‚æ­¥é€šä¿¡æ–¹å¼
4. **å®¹é”™è®¾è®¡**ï¼šå®ç°ç†”æ–­ã€é™çº§ã€é‡è¯•æœºåˆ¶

### æ¶æ„æ¨¡å¼å¯¹æ¯”

| æ¶æ„ | å¤æ‚åº¦ | å¯æ‰©å±•æ€§ | å¼€å‘æ•ˆç‡ | è¿ç»´æˆæœ¬ |
|------|--------|----------|----------|----------|
| å•ä½“åº”ç”¨ | ä½ | ä½ | é«˜ï¼ˆåˆæœŸï¼‰ | ä½ |
| å¾®æœåŠ¡ | é«˜ | é«˜ | ä¸­ | é«˜ |
| æœåŠ¡ç½‘æ ¼ | å¾ˆé«˜ | å¾ˆé«˜ | ä¸­ | å¾ˆé«˜ |

### æŒç»­å­¦ä¹ å»ºè®®

1. **æ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º**ï¼šCAPã€BASEç­‰
2. **å®è·µå¾®æœåŠ¡æŠ€æœ¯æ ˆ**ï¼šSpring Cloudã€Kubernetesç­‰
3. **å…³æ³¨æœåŠ¡ç½‘æ ¼å‘å±•**ï¼šIstioã€Linkerdç­‰æ–°æŠ€æœ¯
4. **å­¦ä¹ DevOpså®è·µ**ï¼šCI/CDã€ç›‘æ§è¿ç»´ç­‰

å¾®æœåŠ¡æ¶æ„ä¸æ˜¯é“¶å¼¹ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡è§„æ¨¡å’Œå›¢é˜Ÿèƒ½åŠ›é€‰æ‹©åˆé€‚çš„æ¶æ„æ¨¡å¼ã€‚ 