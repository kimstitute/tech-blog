---
title: "é«˜å¹¶å‘ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–å®è·µæ·±åº¦è§£æ"
description: "æ·±å…¥æ¢è®¨é«˜å¹¶å‘ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæŠ€æœ¯å’Œå®è·µæ–¹æ³•ï¼Œç»“åˆå®é™…é¡¹ç›®ç»éªŒåˆ†äº«ç³»ç»Ÿæ¶æ„è®¾è®¡ã€æ€§èƒ½è°ƒä¼˜å’Œç›‘æ§è¦ç‚¹ã€‚"
pubDate: 2024-12-28
updatedDate: 2024-12-28
tags: ["performance", "optimization", "high-concurrency", "scalability", "architecture", "interview", "best-practices"]
categories: ["middleware"]
subject: "ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–"
draft: false
featured: true
author: "Gerrad Zhang"
location: "æ­¦æ±‰ï¼Œä¸­å›½"
---

## ğŸ¤” é—®é¢˜èƒŒæ™¯ä¸æŠ€æœ¯æ¼”è¿›

### æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨ç°ä»£äº’è”ç½‘åº”ç”¨ä¸­ï¼Œç³»ç»Ÿæ€§èƒ½é—®é¢˜æ˜¯åˆ¶çº¦ä¸šåŠ¡å‘å±•çš„å…³é”®ç“¶é¢ˆï¼š

- **é«˜å¹¶å‘å‹åŠ›**ï¼šç”¨æˆ·é‡æ¿€å¢ï¼Œç³»ç»Ÿéœ€è¦æ”¯æ’‘æ›´é«˜çš„QPSå’ŒTPS
- **å“åº”æ—¶é—´è¦æ±‚**ï¼šç”¨æˆ·ä½“éªŒè¦æ±‚æ¯«ç§’çº§å“åº”ï¼Œå»¶è¿Ÿç›´æ¥å½±å“ä¸šåŠ¡è½¬åŒ–
- **èµ„æºåˆ©ç”¨æ•ˆç‡**ï¼šæœ‰é™çš„ç¡¬ä»¶èµ„æºéœ€è¦æ”¯æ’‘æ›´å¤§çš„ä¸šåŠ¡é‡
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šé«˜è´Ÿè½½ä¸‹ç³»ç»Ÿå®¹æ˜“å‡ºç°é›ªå´©ã€æ­»é”ç­‰é—®é¢˜
- **æˆæœ¬æ§åˆ¶**ï¼šåœ¨ä¿è¯æ€§èƒ½çš„åŒæ—¶æ§åˆ¶åŸºç¡€è®¾æ–½æˆæœ¬

### æ²¡æœ‰æ€§èƒ½ä¼˜åŒ–æ—¶æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

æ—©æœŸç³»ç»Ÿé€šå¸¸é‡‡ç”¨ç®€å•ç²—æš´çš„æ‰©å®¹æ–¹å¼ï¼š

```java
// ä¼ ç»Ÿåšæ³•ï¼šåŒæ­¥å¤„ç†ï¼Œå•çº¿ç¨‹æ‰§è¡Œ
@RestController
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping("/order")
    public ResponseEntity<String> createOrder(@RequestBody OrderRequest request) {
        // åŒæ­¥å¤„ç†æ‰€æœ‰æ­¥éª¤
        Order order = orderService.createOrder(request);
        inventoryService.deductStock(request.getProductId(), request.getQuantity());
        paymentService.processPayment(order);
        notificationService.sendNotification(order);
        
        return ResponseEntity.ok("Order created: " + order.getId());
    }
}
```

**ä¼ ç»Ÿæ–¹æ¡ˆçš„é—®é¢˜**ï¼š
- çº¿æ€§æ‰©å®¹æˆæœ¬é«˜æ˜‚
- å•ç‚¹ç“¶é¢ˆéš¾ä»¥çªç ´
- èµ„æºåˆ©ç”¨ç‡ä½ä¸‹
- ç³»ç»Ÿå“åº”æ—¶é—´é•¿
- æ— æ³•åº”å¯¹çªå‘æµé‡

### æŠ€æœ¯æ¼”è¿›çš„å†å²è„‰ç»œ

æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯çš„å‘å±•å†ç¨‹ï¼š

1. **å•æœºä¼˜åŒ–æ—¶ä»£**ï¼ˆ1990-2000ï¼‰ï¼šCPUã€å†…å­˜ã€ç£ç›˜IOä¼˜åŒ–
2. **é›†ç¾¤åŒ–æ—¶ä»£**ï¼ˆ2000-2005ï¼‰ï¼šè´Ÿè½½å‡è¡¡ã€æ•°æ®åº“ä¸»ä»å¤åˆ¶
3. **åˆ†å¸ƒå¼æ¶æ„**ï¼ˆ2005-2010ï¼‰ï¼šSOAã€åˆ†å¸ƒå¼ç¼“å­˜ã€CDN
4. **å¾®æœåŠ¡æ—¶ä»£**ï¼ˆ2010-2015ï¼‰ï¼šæœåŠ¡æ‹†åˆ†ã€å¼‚æ­¥å¤„ç†ã€æ¶ˆæ¯é˜Ÿåˆ—
5. **äº‘åŸç”Ÿæ—¶ä»£**ï¼ˆ2015-2020ï¼‰ï¼šå®¹å™¨åŒ–ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€Service Mesh
6. **æ™ºèƒ½åŒ–æ—¶ä»£**ï¼ˆ2020è‡³ä»Šï¼‰ï¼šAIé©±åŠ¨ä¼˜åŒ–ã€è¾¹ç¼˜è®¡ç®—ã€Serverless

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µä¸åŸç†

### æ€§èƒ½ä¼˜åŒ–çš„å…³é”®æŒ‡æ ‡

æ€§èƒ½ä¼˜åŒ–éœ€è¦å…³æ³¨çš„æ ¸å¿ƒæŒ‡æ ‡ï¼š

```java
public class PerformanceMetrics {
    // ååé‡æŒ‡æ ‡
    private long qps;           // æ¯ç§’æŸ¥è¯¢æ•°
    private long tps;           // æ¯ç§’äº‹åŠ¡æ•°
    private long rps;           // æ¯ç§’è¯·æ±‚æ•°
    
    // å»¶è¿ŸæŒ‡æ ‡
    private long avgLatency;    // å¹³å‡å»¶è¿Ÿ
    private long p95Latency;    // 95åˆ†ä½å»¶è¿Ÿ
    private long p99Latency;    // 99åˆ†ä½å»¶è¿Ÿ
    
    // èµ„æºåˆ©ç”¨ç‡
    private double cpuUsage;    // CPUä½¿ç”¨ç‡
    private double memoryUsage; // å†…å­˜ä½¿ç”¨ç‡
    private double diskIO;      // ç£ç›˜IO
    private double networkIO;   // ç½‘ç»œIO
    
    // é”™è¯¯ç‡
    private double errorRate;   // é”™è¯¯ç‡
    private long timeoutCount;  // è¶…æ—¶æ¬¡æ•°
}
```

### æ€§èƒ½ä¼˜åŒ–çš„åŸºæœ¬åŸåˆ™

**1. å‡å°‘ä¸å¿…è¦çš„å·¥ä½œ**
```java
// é¿å…é‡å¤è®¡ç®—
@Service
public class ProductService {
    
    @Cacheable("products")
    public Product getProduct(Long id) {
        return productRepository.findById(id);
    }
    
    // æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“è®¿é—®
    public List<Product> getProducts(List<Long> ids) {
        return productRepository.findAllById(ids);
    }
}
```

**2. å¹¶è¡ŒåŒ–å¤„ç†**
```java
// å¼‚æ­¥å¹¶è¡Œå¤„ç†
@Service
public class OrderProcessingService {
    
    @Async
    public CompletableFuture<Void> processOrderAsync(Order order) {
        return CompletableFuture.allOf(
            updateInventory(order),
            processPayment(order),
            sendNotification(order)
        );
    }
}
```

**3. èµ„æºæ± åŒ–å¤ç”¨**
```java
// è¿æ¥æ± é…ç½®
@Configuration
public class DataSourceConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setMaximumPoolSize(20);
        config.setMinimumIdle(5);
        config.setConnectionTimeout(30000);
        return new HikariDataSource(config);
    }
}
```

## ğŸ”§ å®ç°åŸç†ä¸æºç åˆ†æ

### JVMæ€§èƒ½è°ƒä¼˜

JVMè°ƒä¼˜æ˜¯æ€§èƒ½ä¼˜åŒ–çš„åŸºç¡€ï¼š

```bash
# ç”Ÿäº§ç¯å¢ƒJVMå‚æ•°é…ç½®
java -Xms4g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+UnlockExperimentalVMOptions \
     -XX:+UseStringDeduplication \
     -XX:+PrintGCDetails \
     -XX:+PrintGCTimeStamps \
     -Xloggc:gc.log \
     -jar application.jar
```

**å…³é”®å‚æ•°è§£æ**ï¼š
```java
public class JVMOptimization {
    
    /**
     * å †å†…å­˜ä¼˜åŒ–
     */
    public void heapOptimization() {
        // -Xms: åˆå§‹å †å¤§å°ï¼Œå»ºè®®ä¸-Xmxç›¸åŒé¿å…åŠ¨æ€æ‰©å®¹
        // -Xmx: æœ€å¤§å †å¤§å°ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„70-80%
        // -XX:NewRatio: æ–°ç”Ÿä»£ä¸è€å¹´ä»£æ¯”ä¾‹ï¼Œé»˜è®¤1:2
        // -XX:SurvivorRatio: Edenä¸Survivoræ¯”ä¾‹ï¼Œé»˜è®¤8:1:1
    }
    
    /**
     * åƒåœ¾æ”¶é›†å™¨é€‰æ‹©
     */
    public void gcOptimization() {
        // G1GC: é€‚åˆå¤§å †å†…å­˜ï¼Œä½å»¶è¿Ÿè¦æ±‚
        // ParallelGC: é€‚åˆååé‡ä¼˜å…ˆåœºæ™¯
        // ZGC/Shenandoah: è¶…ä½å»¶è¿Ÿè¦æ±‚
    }
}
```

### æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

æ•°æ®åº“å¾€å¾€æ˜¯æ€§èƒ½ç“¶é¢ˆçš„å…³é”®ï¼š

```java
@Repository
public class OptimizedUserRepository {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    /**
     * æ‰¹é‡æ’å…¥ä¼˜åŒ–
     */
    public void batchInsertUsers(List<User> users) {
        String sql = "INSERT INTO users (name, email, age) VALUES (?, ?, ?)";
        
        jdbcTemplate.batchUpdate(sql, new BatchPreparedStatementSetter() {
            @Override
            public void setValues(PreparedStatement ps, int i) throws SQLException {
                User user = users.get(i);
                ps.setString(1, user.getName());
                ps.setString(2, user.getEmail());
                ps.setInt(3, user.getAge());
            }
            
            @Override
            public int getBatchSize() {
                return users.size();
            }
        });
    }
    
    /**
     * åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
     */
    @Query(value = "SELECT * FROM users WHERE id > :lastId ORDER BY id LIMIT :size", 
           nativeQuery = true)
    List<User> findUsersWithCursorPagination(@Param("lastId") Long lastId, 
                                            @Param("size") int size);
    
    /**
     * ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
     */
    @Query("SELECT u FROM User u WHERE u.email = :email AND u.status = :status")
    Optional<User> findByEmailAndStatus(@Param("email") String email, 
                                       @Param("status") UserStatus status);
}
```

### ç¼“å­˜å±‚æ¬¡ä¼˜åŒ–

å¤šçº§ç¼“å­˜æ¶æ„æå‡ç³»ç»Ÿæ€§èƒ½ï¼š

```java
@Service
public class MultiLevelCacheService {
    
    // L1: æœ¬åœ°ç¼“å­˜
    private final Cache<String, Object> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .recordStats()
        .build();
    
    // L2: Redisåˆ†å¸ƒå¼ç¼“å­˜
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // L3: æ•°æ®åº“
    @Autowired
    private UserRepository userRepository;
    
    /**
     * å¤šçº§ç¼“å­˜æŸ¥è¯¢
     */
    public User getUser(Long userId) {
        String key = "user:" + userId;
        
        // 1. æŸ¥è¯¢L1ç¼“å­˜
        User user = (User) localCache.getIfPresent(key);
        if (user != null) {
            return user;
        }
        
        // 2. æŸ¥è¯¢L2ç¼“å­˜
        user = (User) redisTemplate.opsForValue().get(key);
        if (user != null) {
            localCache.put(key, user);
            return user;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        user = userRepository.findById(userId).orElse(null);
        if (user != null) {
            // å¼‚æ­¥å›å¡«ç¼“å­˜
            CompletableFuture.runAsync(() -> {
                redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS);
                localCache.put(key, user);
            });
        }
        
        return user;
    }
    
    /**
     * ç¼“å­˜é¢„çƒ­
     */
    @PostConstruct
    public void warmupCache() {
        // é¢„çƒ­çƒ­ç‚¹æ•°æ®
        List<Long> hotUserIds = getHotUserIds();
        hotUserIds.parallelStream().forEach(this::getUser);
    }
}
```

### å¼‚æ­¥å¤„ç†ä¼˜åŒ–

å¼‚æ­¥å¤„ç†æå‡ç³»ç»Ÿååé‡ï¼š

```java
@Service
public class AsyncOrderService {
    
    @Autowired
    private ThreadPoolTaskExecutor taskExecutor;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * å¼‚æ­¥è®¢å•å¤„ç†
     */
    public CompletableFuture<OrderResult> processOrderAsync(OrderRequest request) {
        // 1. å¿«é€Ÿåˆ›å»ºè®¢å•
        CompletableFuture<Order> orderFuture = CompletableFuture.supplyAsync(() -> {
            return createOrderSync(request);
        }, taskExecutor);
        
        // 2. å¹¶è¡Œå¤„ç†å„ä¸ªæ­¥éª¤
        CompletableFuture<Void> inventoryFuture = orderFuture.thenCompose(order -> 
            deductInventoryAsync(order));
        
        CompletableFuture<Void> paymentFuture = orderFuture.thenCompose(order -> 
            processPaymentAsync(order));
        
        CompletableFuture<Void> notificationFuture = orderFuture.thenCompose(order -> 
            sendNotificationAsync(order));
        
        // 3. ç­‰å¾…æ‰€æœ‰æ­¥éª¤å®Œæˆ
        return CompletableFuture.allOf(inventoryFuture, paymentFuture, notificationFuture)
            .thenApply(v -> new OrderResult(orderFuture.join(), true));
    }
    
    /**
     * æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
     */
    public void processOrderWithMQ(OrderRequest request) {
        // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
        OrderMessage message = new OrderMessage(request);
        rabbitTemplate.convertAndSend("order.exchange", "order.created", message);
    }
    
    @RabbitListener(queues = "order.processing.queue")
    public void handleOrderProcessing(OrderMessage message) {
        // å¼‚æ­¥å¤„ç†è®¢å•
        processOrderSync(message.getOrderRequest());
    }
}
```

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ä¸ä»£ç ç¤ºä¾‹

### ç”µå•†ç§’æ€ç³»ç»Ÿä¼˜åŒ–

ç§’æ€ç³»ç»Ÿæ˜¯é«˜å¹¶å‘ä¼˜åŒ–çš„å…¸å‹åœºæ™¯ï¼š

```java
@Service
public class SeckillService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    private static final String SECKILL_STOCK_KEY = "seckill:stock:";
    private static final String SECKILL_USER_KEY = "seckill:user:";
    
    /**
     * ç§’æ€é¢„å¤„ç†ï¼šåº“å­˜é¢„çƒ­
     */
    @PostConstruct
    public void preloadSeckillStock() {
        List<SeckillProduct> products = getSeckillProducts();
        for (SeckillProduct product : products) {
            String stockKey = SECKILL_STOCK_KEY + product.getId();
            redisTemplate.opsForValue().set(stockKey, product.getStock());
        }
    }
    
    /**
     * ç§’æ€æ¥å£ä¼˜åŒ–
     */
    public SeckillResult seckill(Long productId, Long userId) {
        String stockKey = SECKILL_STOCK_KEY + productId;
        String userKey = SECKILL_USER_KEY + productId + ":" + userId;
        
        // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»å‚ä¸è¿‡ç§’æ€
        if (redisTemplate.hasKey(userKey)) {
            return SeckillResult.fail("ç”¨æˆ·å·²å‚ä¸è¿‡ç§’æ€");
        }
        
        // 2. åŸå­æ€§æ‰£å‡åº“å­˜
        Long stock = redisTemplate.opsForValue().decrement(stockKey);
        if (stock < 0) {
            // åº“å­˜ä¸è¶³ï¼Œæ¢å¤åº“å­˜
            redisTemplate.opsForValue().increment(stockKey);
            return SeckillResult.fail("åº“å­˜ä¸è¶³");
        }
        
        // 3. è®°å½•ç”¨æˆ·å‚ä¸
        redisTemplate.opsForValue().set(userKey, "1", 24, TimeUnit.HOURS);
        
        // 4. å¼‚æ­¥åˆ›å»ºè®¢å•
        SeckillOrder order = new SeckillOrder(productId, userId);
        rabbitTemplate.convertAndSend("seckill.order.queue", order);
        
        return SeckillResult.success("ç§’æ€æˆåŠŸ");
    }
    
    /**
     * Luaè„šæœ¬ä¿è¯åŸå­æ€§
     */
    public SeckillResult seckillWithLua(Long productId, Long userId) {
        String luaScript = 
            "local stockKey = KEYS[1] " +
            "local userKey = KEYS[2] " +
            "local userId = ARGV[1] " +
            "if redis.call('exists', userKey) == 1 then " +
            "  return -1 " +
            "end " +
            "local stock = redis.call('get', stockKey) " +
            "if tonumber(stock) <= 0 then " +
            "  return 0 " +
            "end " +
            "redis.call('decr', stockKey) " +
            "redis.call('setex', userKey, 86400, userId) " +
            "return 1";
        
        String stockKey = SECKILL_STOCK_KEY + productId;
        String userKey = SECKILL_USER_KEY + productId + ":" + userId;
        
        Long result = redisTemplate.execute(new DefaultRedisScript<>(luaScript, Long.class),
            Arrays.asList(stockKey, userKey), userId.toString());
        
        if (result == -1) {
            return SeckillResult.fail("ç”¨æˆ·å·²å‚ä¸è¿‡ç§’æ€");
        } else if (result == 0) {
            return SeckillResult.fail("åº“å­˜ä¸è¶³");
        } else {
            // å¼‚æ­¥åˆ›å»ºè®¢å•
            SeckillOrder order = new SeckillOrder(productId, userId);
            rabbitTemplate.convertAndSend("seckill.order.queue", order);
            return SeckillResult.success("ç§’æ€æˆåŠŸ");
        }
    }
}
```

### æœç´¢ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–

æœç´¢ç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š

```java
@Service
public class SearchService {
    
    @Autowired
    private ElasticsearchRestTemplate elasticsearchTemplate;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * æœç´¢ç»“æœç¼“å­˜ä¼˜åŒ–
     */
    public SearchResult search(SearchRequest request) {
        // 1. ç”Ÿæˆç¼“å­˜é”®
        String cacheKey = generateCacheKey(request);
        
        // 2. æŸ¥è¯¢ç¼“å­˜
        SearchResult cachedResult = (SearchResult) redisTemplate.opsForValue().get(cacheKey);
        if (cachedResult != null) {
            return cachedResult;
        }
        
        // 3. æ„å»ºESæŸ¥è¯¢
        BoolQueryBuilder queryBuilder = QueryBuilders.boolQuery();
        
        // å…³é”®è¯æœç´¢
        if (StringUtils.hasText(request.getKeyword())) {
            queryBuilder.must(QueryBuilders.multiMatchQuery(request.getKeyword())
                .field("title", 2.0f)  // æ ‡é¢˜æƒé‡æ›´é«˜
                .field("content", 1.0f)
                .type(MultiMatchQueryBuilder.Type.BEST_FIELDS));
        }
        
        // è¿‡æ»¤æ¡ä»¶
        if (request.getCategoryId() != null) {
            queryBuilder.filter(QueryBuilders.termQuery("categoryId", request.getCategoryId()));
        }
        
        // 4. æ‰§è¡Œæœç´¢
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(queryBuilder)
            .withPageable(PageRequest.of(request.getPage(), request.getSize()))
            .withSort(SortBuilders.scoreSort().order(SortOrder.DESC))
            .withHighlightFields(new HighlightBuilder.Field("title"), 
                               new HighlightBuilder.Field("content"))
            .build();
        
        SearchHits<Product> searchHits = elasticsearchTemplate.search(searchQuery, Product.class);
        
        // 5. æ„å»ºç»“æœ
        SearchResult result = buildSearchResult(searchHits, request);
        
        // 6. ç¼“å­˜ç»“æœ
        redisTemplate.opsForValue().set(cacheKey, result, 10, TimeUnit.MINUTES);
        
        return result;
    }
    
    /**
     * æœç´¢å»ºè®®ä¼˜åŒ–
     */
    public List<String> getSuggestions(String keyword) {
        String cacheKey = "suggestions:" + keyword;
        
        @SuppressWarnings("unchecked")
        List<String> cached = (List<String>) redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }
        
        // ä½¿ç”¨ESçš„completion suggester
        CompletionSuggestionBuilder suggestionBuilder = 
            SuggestBuilders.completionSuggestion("suggest").prefix(keyword).size(10);
        
        SuggestBuilder suggestBuilder = new SuggestBuilder().addSuggestion("suggestions", suggestionBuilder);
        
        SearchRequest searchRequest = new SearchRequest("products")
            .source(new SearchSourceBuilder().suggest(suggestBuilder));
        
        // æ‰§è¡Œå»ºè®®æŸ¥è¯¢
        List<String> suggestions = executeSuggestionQuery(searchRequest);
        
        // ç¼“å­˜å»ºè®®ç»“æœ
        redisTemplate.opsForValue().set(cacheKey, suggestions, 1, TimeUnit.HOURS);
        
        return suggestions;
    }
}
```

### æ¥å£é™æµå’Œé™çº§

ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§çš„å…³é”®æªæ–½ï¼š

```java
@Component
public class RateLimitingService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * ä»¤ç‰Œæ¡¶é™æµç®—æ³•
     */
    public boolean tryAcquire(String key, int permits, int capacity, int refillRate) {
        String luaScript = 
            "local key = KEYS[1] " +
            "local capacity = tonumber(ARGV[1]) " +
            "local permits = tonumber(ARGV[2]) " +
            "local interval = tonumber(ARGV[3]) " +
            "local current_time = tonumber(ARGV[4]) " +
            
            "local bucket = redis.call('HMGET', key, 'tokens', 'last_refill') " +
            "local tokens = tonumber(bucket[1]) or capacity " +
            "local last_refill = tonumber(bucket[2]) or current_time " +
            
            "local elapsed = current_time - last_refill " +
            "local new_tokens = math.min(capacity, tokens + elapsed * interval / 1000) " +
            
            "if new_tokens >= permits then " +
            "  new_tokens = new_tokens - permits " +
            "  redis.call('HMSET', key, 'tokens', new_tokens, 'last_refill', current_time) " +
            "  redis.call('EXPIRE', key, 3600) " +
            "  return 1 " +
            "else " +
            "  redis.call('HMSET', key, 'tokens', new_tokens, 'last_refill', current_time) " +
            "  redis.call('EXPIRE', key, 3600) " +
            "  return 0 " +
            "end";
        
        Long result = redisTemplate.execute(new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(key), 
            String.valueOf(capacity), 
            String.valueOf(permits), 
            String.valueOf(refillRate),
            String.valueOf(System.currentTimeMillis()));
        
        return result != null && result == 1;
    }
    
    /**
     * æ»‘åŠ¨çª—å£é™æµ
     */
    public boolean slidingWindowLimit(String key, int limit, int windowSize) {
        long currentTime = System.currentTimeMillis();
        long windowStart = currentTime - windowSize * 1000L;
        
        String luaScript = 
            "local key = KEYS[1] " +
            "local window_start = ARGV[1] " +
            "local current_time = ARGV[2] " +
            "local limit = tonumber(ARGV[3]) " +
            
            "redis.call('ZREMRANGEBYSCORE', key, 0, window_start) " +
            "local current_count = redis.call('ZCARD', key) " +
            
            "if current_count < limit then " +
            "  redis.call('ZADD', key, current_time, current_time) " +
            "  redis.call('EXPIRE', key, " + windowSize + ") " +
            "  return 1 " +
            "else " +
            "  return 0 " +
            "end";
        
        Long result = redisTemplate.execute(new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(key),
            String.valueOf(windowStart),
            String.valueOf(currentTime),
            String.valueOf(limit));
        
        return result != null && result == 1;
    }
}

@Component
public class CircuitBreakerService {
    
    private final Map<String, CircuitBreakerState> circuitBreakers = new ConcurrentHashMap<>();
    
    /**
     * ç†”æ–­å™¨å®ç°
     */
    public <T> T executeWithCircuitBreaker(String serviceName, Supplier<T> operation, Supplier<T> fallback) {
        CircuitBreakerState state = circuitBreakers.computeIfAbsent(serviceName, 
            k -> new CircuitBreakerState());
        
        if (state.getState() == CircuitState.OPEN) {
            // ç†”æ–­å™¨æ‰“å¼€ï¼Œç›´æ¥è¿”å›é™çº§ç»“æœ
            return fallback.get();
        }
        
        try {
            T result = operation.get();
            state.recordSuccess();
            return result;
        } catch (Exception e) {
            state.recordFailure();
            if (state.shouldOpenCircuit()) {
                state.openCircuit();
            }
            return fallback.get();
        }
    }
}
```

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜ç²¾è®²

### 1. å¦‚ä½•è¯†åˆ«ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
é€šè¿‡å¤šç»´åº¦ç›‘æ§å’Œåˆ†æå·¥å…·ï¼š
- **APMå·¥å…·**ï¼šApplication Performance Monitoring
- **ç³»ç»Ÿç›‘æ§**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- **æ•°æ®åº“ç›‘æ§**ï¼šæ…¢æŸ¥è¯¢ã€è¿æ¥æ•°ã€é”ç­‰å¾…
- **ç¼“å­˜ç›‘æ§**ï¼šå‘½ä¸­ç‡ã€å»¶è¿Ÿã€å†…å­˜ä½¿ç”¨

**æ‰©å±•è¦ç‚¹**ï¼š
```java
// æ€§èƒ½ç›‘æ§å…³é”®æŒ‡æ ‡
1. å“åº”æ—¶é—´ï¼šå¹³å‡å“åº”æ—¶é—´ã€P95ã€P99
2. ååé‡ï¼šQPSã€TPS
3. é”™è¯¯ç‡ï¼š4xxã€5xxé”™è¯¯æ¯”ä¾‹
4. èµ„æºåˆ©ç”¨ç‡ï¼šCPUã€å†…å­˜ã€ç£ç›˜IOã€ç½‘ç»œIO
```

### 2. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æœ‰å“ªäº›ç­–ç•¥ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆç†åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šé¿å…å…¨è¡¨æ‰«æï¼Œä¼˜åŒ–SQLè¯­å¥
- **è¯»å†™åˆ†ç¦»**ï¼šä¸»åº“å†™å…¥ï¼Œä»åº“è¯»å–
- **åˆ†åº“åˆ†è¡¨**ï¼šæ°´å¹³æ‹†åˆ†å’Œå‚ç›´æ‹†åˆ†
- **è¿æ¥æ± ä¼˜åŒ–**ï¼šåˆç†é…ç½®è¿æ¥æ± å‚æ•°

**é¢è¯•æŠ€å·§**ï¼šç»“åˆå…·ä½“çš„SQLä¼˜åŒ–æ¡ˆä¾‹è¯´æ˜ã€‚

### 3. ç¼“å­˜åœ¨æ€§èƒ½ä¼˜åŒ–ä¸­çš„ä½œç”¨ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **å‡å°‘æ•°æ®åº“å‹åŠ›**ï¼šç¼“å­˜çƒ­ç‚¹æ•°æ®
- **æå‡å“åº”é€Ÿåº¦**ï¼šå†…å­˜è®¿é—®æ¯”ç£ç›˜å¿«
- **åº”å¯¹çªå‘æµé‡**ï¼šç¼“å­˜å¯ä»¥æ‰¿å—æ›´é«˜å¹¶å‘
- **é™ä½ç³»ç»Ÿæˆæœ¬**ï¼šå‡å°‘æ•°æ®åº“æœåŠ¡å™¨éœ€æ±‚

### 4. å¦‚ä½•è®¾è®¡é«˜å¹¶å‘ç³»ç»Ÿæ¶æ„ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **æ°´å¹³æ‰©å±•**ï¼šé€šè¿‡å¢åŠ æœåŠ¡å™¨æ•°é‡æå‡æ€§èƒ½
- **å¼‚æ­¥å¤„ç†**ï¼šå°†è€—æ—¶æ“ä½œå¼‚æ­¥åŒ–
- **ç¼“å­˜ç­–ç•¥**ï¼šå¤šçº§ç¼“å­˜æ¶æ„
- **è´Ÿè½½å‡è¡¡**ï¼šåˆç†åˆ†é…è¯·æ±‚
- **å¾®æœåŠ¡æ‹†åˆ†**ï¼šæŒ‰ä¸šåŠ¡åŸŸæ‹†åˆ†æœåŠ¡

### 5. JVMè°ƒä¼˜çš„å…³é”®å‚æ•°æœ‰å“ªäº›ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **å †å†…å­˜**ï¼š-Xmsã€-Xmxè®¾ç½®å †å¤§å°
- **åƒåœ¾æ”¶é›†å™¨**ï¼šé€‰æ‹©åˆé€‚çš„GCç®—æ³•
- **æ–°ç”Ÿä»£**ï¼š-XX:NewRatioæ§åˆ¶æ–°ç”Ÿä»£æ¯”ä¾‹
- **GCæ—¥å¿—**ï¼šå¼€å¯GCæ—¥å¿—åˆ†ææ€§èƒ½

### 6. å¦‚ä½•å¤„ç†ç³»ç»Ÿçš„é›ªå´©é—®é¢˜ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **ç†”æ–­å™¨**ï¼šé˜²æ­¢æ•…éšœä¼ æ’­
- **é™æµ**ï¼šæ§åˆ¶è¯·æ±‚æµé‡
- **é™çº§**ï¼šæä¾›å¤‡ç”¨æ–¹æ¡ˆ
- **è¶…æ—¶è®¾ç½®**ï¼šé¿å…é•¿æ—¶é—´ç­‰å¾…
- **éš”ç¦»**ï¼šèµ„æºéš”ç¦»å’Œæ•…éšœéš”ç¦»

### 7. å¼‚æ­¥å¤„ç†çš„ä¼˜ç¼ºç‚¹ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
**ä¼˜ç‚¹**ï¼š
- æé«˜ç³»ç»Ÿååé‡
- æ”¹å–„ç”¨æˆ·ä½“éªŒ
- æ›´å¥½çš„èµ„æºåˆ©ç”¨

**ç¼ºç‚¹**ï¼š
- å¢åŠ ç³»ç»Ÿå¤æ‚æ€§
- é”™è¯¯å¤„ç†å›°éš¾
- æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜

### 8. æ€§èƒ½æµ‹è¯•çš„æ–¹æ³•å’Œå·¥å…·ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **å‹åŠ›æµ‹è¯•**ï¼šJMeterã€LoadRunner
- **åŸºå‡†æµ‹è¯•**ï¼šABã€Wrk
- **ç›‘æ§å·¥å…·**ï¼šPrometheusã€Grafana
- **APMå·¥å…·**ï¼šSkyWalkingã€Pinpoint

## âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

```java
@Component
public class PerformanceOptimizer {
    
    /**
     * æ‰¹é‡æ“ä½œä¼˜åŒ–
     */
    public void batchProcessing() {
        // é¿å…åœ¨å¾ªç¯ä¸­è¿›è¡Œæ•°æ®åº“æ“ä½œ
        List<User> users = userRepository.findAll();
        users.forEach(user -> {
            // å¤„ç†é€»è¾‘
            processUser(user);
        });
        
        // æ‰¹é‡æ›´æ–°
        userRepository.saveAll(users);
    }
    
    /**
     * è¿æ¥æ± ä¼˜åŒ–
     */
    @Bean
    public DataSource optimizedDataSource() {
        HikariConfig config = new HikariConfig();
        config.setMaximumPoolSize(20);          // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);               // æœ€å°ç©ºé—²è¿æ¥
        config.setConnectionTimeout(30000);     // è¿æ¥è¶…æ—¶
        config.setIdleTimeout(600000);          // ç©ºé—²è¶…æ—¶
        config.setMaxLifetime(1800000);         // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
        return new HikariDataSource(config);
    }
}
```

### å¸¸è§æ€§èƒ½é™·é˜±

1. **N+1æŸ¥è¯¢é—®é¢˜**ï¼šä½¿ç”¨JOINæˆ–æ‰¹é‡æŸ¥è¯¢è§£å†³
2. **å†…å­˜æ³„æ¼**ï¼šåŠæ—¶é‡Šæ”¾èµ„æºï¼Œé¿å…é™æ€é›†åˆæŒæœ‰å¯¹è±¡
3. **é¢‘ç¹GC**ï¼šä¼˜åŒ–å¯¹è±¡åˆ›å»ºï¼Œä½¿ç”¨å¯¹è±¡æ± 
4. **é”ç«äº‰**ï¼šå‡å°‘é”çš„ç²’åº¦å’ŒæŒæœ‰æ—¶é—´

### ç›‘æ§å’Œå‘Šè­¦

```java
@Component
public class PerformanceMonitor {
    
    private final MeterRegistry meterRegistry;
    
    @EventListener
    public void handleSlowQuery(SlowQueryEvent event) {
        // è®°å½•æ…¢æŸ¥è¯¢
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("database.query.slow")
            .tag("sql", event.getSql())
            .register(meterRegistry));
    }
    
    @Scheduled(fixedRate = 60000)
    public void collectMetrics() {
        // æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
        Runtime runtime = Runtime.getRuntime();
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        long usedMemory = totalMemory - freeMemory;
        
        Gauge.builder("jvm.memory.used")
            .register(meterRegistry, () -> usedMemory);
    }
}
```

## ğŸ“š æ€»ç»“ä¸æŠ€æœ¯å¯¹æ¯”

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

é«˜å¹¶å‘ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§å·¥ç¨‹ï¼š

1. **å…¨é“¾è·¯ä¼˜åŒ–**ï¼šä»å‰ç«¯åˆ°åç«¯ï¼Œä»åº”ç”¨åˆ°åŸºç¡€è®¾æ–½
2. **ç›‘æ§é©±åŠ¨**ï¼šåŸºäºæ•°æ®è¿›è¡Œä¼˜åŒ–å†³ç­–
3. **æ¸è¿›å¼ä¼˜åŒ–**ï¼šå…ˆè§£å†³ä¸»è¦ç“¶é¢ˆï¼Œå†ä¼˜åŒ–ç»†èŠ‚
4. **æƒè¡¡å–èˆ**ï¼šåœ¨æ€§èƒ½ã€å¤æ‚æ€§ã€æˆæœ¬é—´æ‰¾å¹³è¡¡

### ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | æ•ˆæœ | å¤æ‚åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|------|----------|
| ç¼“å­˜ | é«˜ | ä¸­ | ä½ | è¯»å¤šå†™å°‘ |
| å¼‚æ­¥å¤„ç† | é«˜ | é«˜ | ä¸­ | è€—æ—¶æ“ä½œ |
| æ•°æ®åº“ä¼˜åŒ– | ä¸­ | ä¸­ | ä½ | æ•°æ®å¯†é›† |
| æ°´å¹³æ‰©å±• | é«˜ | é«˜ | é«˜ | é«˜å¹¶å‘ |

### æŒç»­å­¦ä¹ å»ºè®®

1. **æ·±å…¥ç†è§£ç³»ç»ŸåŸç†**ï¼šæ“ä½œç³»ç»Ÿã€ç½‘ç»œã€æ•°æ®åº“ç­‰
2. **å®è·µæ€§èƒ½æµ‹è¯•**ï¼šå­¦ä¹ ä½¿ç”¨å„ç§æ€§èƒ½æµ‹è¯•å·¥å…·
3. **å…³æ³¨æ–°æŠ€æœ¯å‘å±•**ï¼šäº‘åŸç”Ÿã€è¾¹ç¼˜è®¡ç®—ç­‰æ–°è¶‹åŠ¿
4. **åŸ¹å…»ç³»ç»Ÿæ€ç»´**ï¼šä»å…¨å±€è§’åº¦æ€è€ƒæ€§èƒ½ä¼˜åŒ–

æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ç»“åˆä¸šåŠ¡ç‰¹ç‚¹å’ŒæŠ€æœ¯å‘å±•ï¼Œä¸æ–­è°ƒæ•´å’Œæ”¹è¿›ä¼˜åŒ–ç­–ç•¥ã€‚ 