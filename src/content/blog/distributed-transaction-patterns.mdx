---
title: "åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼ä¸å®ç°æ–¹æ¡ˆæ·±åº¦è§£æ"
description: "æ·±å…¥æ¢è®¨åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒç†è®ºã€å®ç°æ¨¡å¼å’Œè§£å†³æ–¹æ¡ˆï¼Œç»“åˆå®é™…é¡¹ç›®ç»éªŒåˆ†äº«åˆ†å¸ƒå¼ç³»ç»Ÿä¸­äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯çš„æœ€ä½³å®è·µã€‚"
pubDate: 2024-12-28
updatedDate: 2024-12-28
tags: ["distributed-transaction", "consistency", "microservices", "saga", "tcc", "interview", "best-practices"]
categories: ["middleware"]
subject: "åˆ†å¸ƒå¼äº‹åŠ¡"
draft: false
featured: true
author: "Gerrad Zhang"
location: "æ­¦æ±‰ï¼Œä¸­å›½"
---

## ğŸ¤” é—®é¢˜èƒŒæ™¯ä¸æŠ€æœ¯æ¼”è¿›

### æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œäº‹åŠ¡å¤„ç†é¢ä¸´å‰æ‰€æœªæœ‰çš„æŒ‘æˆ˜ï¼š

- **è·¨æœåŠ¡äº‹åŠ¡**ï¼šä¸€ä¸ªä¸šåŠ¡æ“ä½œæ¶‰åŠå¤šä¸ªå¾®æœåŠ¡ï¼Œéœ€è¦ä¿è¯å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
- **æ•°æ®ä¸€è‡´æ€§**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¦‚ä½•ä¿è¯æ•°æ®çš„ACIDç‰¹æ€§
- **ç½‘ç»œä¸å¯é **ï¼šç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€æ•…éšœå¯¼è‡´çš„ä¸ç¡®å®šæ€§
- **æ€§èƒ½ä¸ä¸€è‡´æ€§æƒè¡¡**ï¼šå¼ºä¸€è‡´æ€§å¾€å¾€æ„å‘³ç€æ€§èƒ½æŸå¤±
- **å¤æ‚æ€§ç®¡ç†**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°å’Œç»´æŠ¤å¤æ‚åº¦é«˜

### æ²¡æœ‰åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆæ—¶æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

æ—©æœŸå•ä½“åº”ç”¨é€šå¸¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼š

```java
// ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼šæ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
@Transactional
public void transferMoney(Long fromAccount, Long toAccount, BigDecimal amount) {
    // åœ¨åŒä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­æ‰§è¡Œ
    Account from = accountRepository.findById(fromAccount);
    Account to = accountRepository.findById(toAccount);
    
    if (from.getBalance().compareTo(amount) < 0) {
        throw new InsufficientBalanceException();
    }
    
    from.setBalance(from.getBalance().subtract(amount));
    to.setBalance(to.getBalance().add(amount));
    
    accountRepository.save(from);
    accountRepository.save(to);
    
    // è®°å½•è½¬è´¦æ—¥å¿—
    TransferLog log = new TransferLog(fromAccount, toAccount, amount);
    transferLogRepository.save(log);
}
```

**ä¼ ç»Ÿæ–¹æ¡ˆçš„é—®é¢˜**ï¼š
- æ— æ³•è·¨è¶ŠæœåŠ¡è¾¹ç•Œ
- æ•°æ®åº“æˆä¸ºå•ç‚¹ç“¶é¢ˆ
- éš¾ä»¥æ°´å¹³æ‰©å±•
- æœåŠ¡é—´è€¦åˆåº¦é«˜

### æŠ€æœ¯æ¼”è¿›çš„å†å²è„‰ç»œ

åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆçš„å‘å±•å†ç¨‹ï¼š

1. **ä¸¤é˜¶æ®µæäº¤æ—¶ä»£**ï¼ˆ1980-1990ï¼‰ï¼š2PCåè®®ï¼Œå¼ºä¸€è‡´æ€§ä½†æ€§èƒ½å·®
2. **ä¸‰é˜¶æ®µæäº¤æ”¹è¿›**ï¼ˆ1990-2000ï¼‰ï¼š3PCè§£å†³éƒ¨åˆ†2PCé—®é¢˜
3. **è¡¥å¿æ¨¡å¼å…´èµ·**ï¼ˆ2000-2010ï¼‰ï¼šSagaæ¨¡å¼ï¼Œæœ€ç»ˆä¸€è‡´æ€§
4. **å¾®æœåŠ¡æ¶æ„**ï¼ˆ2010-2015ï¼‰ï¼šTCCã€æ¶ˆæ¯äº‹åŠ¡ç­‰æ¨¡å¼
5. **äº‘åŸç”Ÿæ—¶ä»£**ï¼ˆ2015-2020ï¼‰ï¼šäº‹ä»¶é©±åŠ¨ã€CQRS+Event Sourcing
6. **ç°ä»£åŒ–æ–¹æ¡ˆ**ï¼ˆ2020è‡³ä»Šï¼‰ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶ã€Serverlessäº‹åŠ¡

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µä¸åŸç†

### åˆ†å¸ƒå¼äº‹åŠ¡çš„ACIDæŒ‘æˆ˜

åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¼ ç»ŸACIDç‰¹æ€§é¢ä¸´æŒ‘æˆ˜ï¼š

```java
public class DistributedACID {
    
    /**
     * åŸå­æ€§ (Atomicity) - åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æŒ‘æˆ˜
     */
    public void atomicityChallenge() {
        // è·¨æœåŠ¡çš„æ“ä½œå¦‚ä½•ä¿è¯å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥ï¼Ÿ
        orderService.createOrder(order);        // æœåŠ¡A
        inventoryService.deductStock(product);   // æœåŠ¡B  
        paymentService.processPayment(payment);  // æœåŠ¡C
        // å¦‚æœæœåŠ¡Cå¤±è´¥ï¼Œå¦‚ä½•å›æ»šæœåŠ¡Aå’ŒBçš„æ“ä½œï¼Ÿ
    }
    
    /**
     * ä¸€è‡´æ€§ (Consistency) - æ•°æ®ä¸€è‡´æ€§ä¿è¯
     */
    public void consistencyChallenge() {
        // ä¸åŒæœåŠ¡çš„æ•°æ®å¦‚ä½•ä¿æŒä¸€è‡´ï¼Ÿ
        // å¼ºä¸€è‡´æ€§ vs æœ€ç»ˆä¸€è‡´æ€§çš„æƒè¡¡
    }
    
    /**
     * éš”ç¦»æ€§ (Isolation) - å¹¶å‘æ§åˆ¶
     */
    public void isolationChallenge() {
        // åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„é”æœºåˆ¶
        // è·¨æœåŠ¡çš„äº‹åŠ¡éš”ç¦»çº§åˆ«
    }
    
    /**
     * æŒä¹…æ€§ (Durability) - æ•°æ®æŒä¹…åŒ–
     */
    public void durabilityChallenge() {
        // æ¶ˆæ¯ä¸¢å¤±ã€ç½‘ç»œåˆ†åŒºå¯¹æŒä¹…æ€§çš„å½±å“
    }
}
```

### CAPå®šç†ä¸BASEç†è®º

**CAPå®šç†**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåªèƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§ä¸­çš„ä¸¤ä¸ª
- **Consistencyï¼ˆä¸€è‡´æ€§ï¼‰**ï¼šæ‰€æœ‰èŠ‚ç‚¹åŒæ—¶çœ‹åˆ°ç›¸åŒæ•°æ®
- **Availabilityï¼ˆå¯ç”¨æ€§ï¼‰**ï¼šç³»ç»ŸæŒç»­å¯ç”¨
- **Partition toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰**ï¼šç½‘ç»œåˆ†åŒºæ—¶ç³»ç»Ÿç»§ç»­å·¥ä½œ

**BASEç†è®º**ï¼šCAPçš„å®è·µåº”ç”¨
- **Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰**ï¼šå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§
- **Soft stateï¼ˆè½¯çŠ¶æ€ï¼‰**ï¼šå…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€
- **Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰**ï¼šç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®å‰¯æœ¬æœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€

## ğŸ”§ å®ç°åŸç†ä¸æºç åˆ†æ

### ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰å®ç°

2PCæ˜¯æœ€ç»å…¸çš„åˆ†å¸ƒå¼äº‹åŠ¡åè®®ï¼š

```java
@Component
public class TwoPhaseCommitCoordinator {
    
    private final List<TransactionParticipant> participants;
    private final TransactionLogger transactionLogger;
    
    /**
     * ä¸¤é˜¶æ®µæäº¤å®ç°
     */
    public boolean executeTransaction(String transactionId, List<TransactionOperation> operations) {
        // é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ (Prepare Phase)
        boolean allPrepared = preparePhase(transactionId, operations);
        
        if (allPrepared) {
            // é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µ (Commit Phase)
            return commitPhase(transactionId);
        } else {
            // é˜¶æ®µ2ï¼šå›æ»šé˜¶æ®µ (Abort Phase)
            return abortPhase(transactionId);
        }
    }
    
    /**
     * å‡†å¤‡é˜¶æ®µï¼šè¯¢é—®æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å¯ä»¥æäº¤
     */
    private boolean preparePhase(String transactionId, List<TransactionOperation> operations) {
        transactionLogger.logTransactionStart(transactionId);
        
        for (int i = 0; i < participants.size(); i++) {
            TransactionParticipant participant = participants.get(i);
            TransactionOperation operation = operations.get(i);
            
            try {
                // å‘é€å‡†å¤‡è¯·æ±‚
                PrepareResult result = participant.prepare(transactionId, operation);
                transactionLogger.logPrepareResult(transactionId, participant.getId(), result);
                
                if (result != PrepareResult.YES) {
                    // æœ‰å‚ä¸è€…æ— æ³•æäº¤ï¼Œè®°å½•å¹¶è¿”å›å¤±è´¥
                    transactionLogger.logTransactionAbort(transactionId, "Participant " + participant.getId() + " voted NO");
                    return false;
                }
            } catch (Exception e) {
                // ç½‘ç»œå¼‚å¸¸æˆ–å‚ä¸è€…æ•…éšœ
                transactionLogger.logTransactionAbort(transactionId, "Participant " + participant.getId() + " failed: " + e.getMessage());
                return false;
            }
        }
        
        transactionLogger.logAllPrepared(transactionId);
        return true;
    }
    
    /**
     * æäº¤é˜¶æ®µï¼šé€šçŸ¥æ‰€æœ‰å‚ä¸è€…æäº¤äº‹åŠ¡
     */
    private boolean commitPhase(String transactionId) {
        boolean allCommitted = true;
        
        for (TransactionParticipant participant : participants) {
            try {
                participant.commit(transactionId);
                transactionLogger.logCommitResult(transactionId, participant.getId(), true);
            } catch (Exception e) {
                // æäº¤é˜¶æ®µå¤±è´¥ï¼Œè®°å½•ä½†ç»§ç»­ï¼ˆå› ä¸ºå·²ç»å†³å®šæäº¤ï¼‰
                transactionLogger.logCommitResult(transactionId, participant.getId(), false);
                allCommitted = false;
            }
        }
        
        transactionLogger.logTransactionCommit(transactionId, allCommitted);
        return allCommitted;
    }
    
    /**
     * å›æ»šé˜¶æ®µï¼šé€šçŸ¥æ‰€æœ‰å‚ä¸è€…å›æ»šäº‹åŠ¡
     */
    private boolean abortPhase(String transactionId) {
        for (TransactionParticipant participant : participants) {
            try {
                participant.abort(transactionId);
                transactionLogger.logAbortResult(transactionId, participant.getId(), true);
            } catch (Exception e) {
                transactionLogger.logAbortResult(transactionId, participant.getId(), false);
            }
        }
        
        transactionLogger.logTransactionAbort(transactionId, "Coordinator decision");
        return true;
    }
}

/**
 * äº‹åŠ¡å‚ä¸è€…æ¥å£
 */
public interface TransactionParticipant {
    String getId();
    PrepareResult prepare(String transactionId, TransactionOperation operation);
    void commit(String transactionId);
    void abort(String transactionId);
}

/**
 * äº‹åŠ¡å‚ä¸è€…å®ç°ç¤ºä¾‹
 */
@Service
public class OrderServiceParticipant implements TransactionParticipant {
    
    @Autowired
    private OrderRepository orderRepository;
    
    private final Map<String, Order> preparedOrders = new ConcurrentHashMap<>();
    
    @Override
    public PrepareResult prepare(String transactionId, TransactionOperation operation) {
        try {
            CreateOrderOperation orderOp = (CreateOrderOperation) operation;
            
            // æ£€æŸ¥ä¸šåŠ¡è§„åˆ™
            if (!validateOrder(orderOp.getOrder())) {
                return PrepareResult.NO;
            }
            
            // é¢„ç•™èµ„æºï¼ˆä½†ä¸æäº¤ï¼‰
            Order order = orderOp.getOrder();
            preparedOrders.put(transactionId, order);
            
            return PrepareResult.YES;
        } catch (Exception e) {
            return PrepareResult.NO;
        }
    }
    
    @Override
    public void commit(String transactionId) {
        Order order = preparedOrders.remove(transactionId);
        if (order != null) {
            orderRepository.save(order);
        }
    }
    
    @Override
    public void abort(String transactionId) {
        preparedOrders.remove(transactionId);
    }
}
```

### TCCï¼ˆTry-Confirm-Cancelï¼‰æ¨¡å¼

TCCæ˜¯ä¸€ç§è¡¥å¿å‹äº‹åŠ¡æ¨¡å¼ï¼š

```java
@Service
public class TCCTransactionManager {
    
    @Autowired
    private List<TCCParticipant> participants;
    
    @Autowired
    private TransactionRepository transactionRepository;
    
    /**
     * TCCäº‹åŠ¡æ‰§è¡Œ
     */
    public TCCResult executeTransaction(String businessId, TCCContext context) {
        String transactionId = generateTransactionId();
        
        // åˆ›å»ºäº‹åŠ¡è®°å½•
        TCCTransaction transaction = new TCCTransaction(transactionId, businessId, TCCStatus.TRYING);
        transactionRepository.save(transaction);
        
        try {
            // Tryé˜¶æ®µï¼šå°è¯•æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            boolean trySuccess = tryPhase(transactionId, context);
            
            if (trySuccess) {
                // Confirmé˜¶æ®µï¼šç¡®è®¤æ‰§è¡Œ
                transaction.setStatus(TCCStatus.CONFIRMING);
                transactionRepository.save(transaction);
                
                boolean confirmSuccess = confirmPhase(transactionId, context);
                transaction.setStatus(confirmSuccess ? TCCStatus.CONFIRMED : TCCStatus.CONFIRM_FAILED);
                transactionRepository.save(transaction);
                
                return new TCCResult(confirmSuccess, transactionId);
            } else {
                // Cancelé˜¶æ®µï¼šå–æ¶ˆæ‰§è¡Œ
                transaction.setStatus(TCCStatus.CANCELLING);
                transactionRepository.save(transaction);
                
                cancelPhase(transactionId, context);
                transaction.setStatus(TCCStatus.CANCELLED);
                transactionRepository.save(transaction);
                
                return new TCCResult(false, transactionId);
            }
        } catch (Exception e) {
            // å¼‚å¸¸æƒ…å†µä¸‹å–æ¶ˆäº‹åŠ¡
            cancelPhase(transactionId, context);
            transaction.setStatus(TCCStatus.CANCELLED);
            transactionRepository.save(transaction);
            
            return new TCCResult(false, transactionId);
        }
    }
    
    /**
     * Tryé˜¶æ®µï¼šé¢„ç•™èµ„æº
     */
    private boolean tryPhase(String transactionId, TCCContext context) {
        for (TCCParticipant participant : participants) {
            try {
                boolean result = participant.tryExecute(transactionId, context);
                if (!result) {
                    // å¦‚æœæœ‰å‚ä¸è€…Tryå¤±è´¥ï¼Œéœ€è¦Cancelå·²ç»TryæˆåŠŸçš„å‚ä¸è€…
                    cancelPreviousParticipants(transactionId, context, participant);
                    return false;
                }
            } catch (Exception e) {
                cancelPreviousParticipants(transactionId, context, participant);
                return false;
            }
        }
        return true;
    }
    
    /**
     * Confirmé˜¶æ®µï¼šç¡®è®¤æ‰§è¡Œ
     */
    private boolean confirmPhase(String transactionId, TCCContext context) {
        boolean allConfirmed = true;
        
        for (TCCParticipant participant : participants) {
            try {
                participant.confirmExecute(transactionId, context);
            } catch (Exception e) {
                allConfirmed = false;
                // Confirmå¤±è´¥éœ€è¦è®°å½•ï¼Œä½†ä¸èƒ½Cancelï¼ˆå› ä¸ºå¯èƒ½å·²ç»æœ‰å‰¯ä½œç”¨ï¼‰
                log.error("Confirm failed for participant: " + participant.getClass().getSimpleName(), e);
            }
        }
        
        return allConfirmed;
    }
    
    /**
     * Cancelé˜¶æ®µï¼šå–æ¶ˆæ‰§è¡Œ
     */
    private void cancelPhase(String transactionId, TCCContext context) {
        for (TCCParticipant participant : participants) {
            try {
                participant.cancelExecute(transactionId, context);
            } catch (Exception e) {
                // Cancelå¤±è´¥éœ€è¦è®°å½•å¹¶å¯èƒ½éœ€è¦äººå·¥å¹²é¢„
                log.error("Cancel failed for participant: " + participant.getClass().getSimpleName(), e);
            }
        }
    }
}

/**
 * TCCå‚ä¸è€…æ¥å£
 */
public interface TCCParticipant {
    boolean tryExecute(String transactionId, TCCContext context);
    void confirmExecute(String transactionId, TCCContext context);
    void cancelExecute(String transactionId, TCCContext context);
}

/**
 * åº“å­˜æœåŠ¡TCCå®ç°
 */
@Service
public class InventoryTCCService implements TCCParticipant {
    
    @Autowired
    private InventoryRepository inventoryRepository;
    
    @Autowired
    private InventoryReservationRepository reservationRepository;
    
    @Override
    public boolean tryExecute(String transactionId, TCCContext context) {
        InventoryDeductRequest request = context.getInventoryRequest();
        
        // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
        Inventory inventory = inventoryRepository.findByProductId(request.getProductId());
        if (inventory.getAvailableStock() < request.getQuantity()) {
            return false;
        }
        
        // é¢„ç•™åº“å­˜ï¼ˆå†»ç»“ï¼‰
        InventoryReservation reservation = new InventoryReservation(
            transactionId, 
            request.getProductId(), 
            request.getQuantity()
        );
        reservationRepository.save(reservation);
        
        // æ›´æ–°å¯ç”¨åº“å­˜
        inventory.setAvailableStock(inventory.getAvailableStock() - request.getQuantity());
        inventory.setReservedStock(inventory.getReservedStock() + request.getQuantity());
        inventoryRepository.save(inventory);
        
        return true;
    }
    
    @Override
    public void confirmExecute(String transactionId, TCCContext context) {
        InventoryReservation reservation = reservationRepository.findByTransactionId(transactionId);
        if (reservation != null) {
            // ç¡®è®¤æ‰£å‡ï¼šå°†é¢„ç•™åº“å­˜è½¬ä¸ºå·²æ‰£å‡
            Inventory inventory = inventoryRepository.findByProductId(reservation.getProductId());
            inventory.setReservedStock(inventory.getReservedStock() - reservation.getQuantity());
            inventory.setTotalStock(inventory.getTotalStock() - reservation.getQuantity());
            inventoryRepository.save(inventory);
            
            // åˆ é™¤é¢„ç•™è®°å½•
            reservationRepository.delete(reservation);
        }
    }
    
    @Override
    public void cancelExecute(String transactionId, TCCContext context) {
        InventoryReservation reservation = reservationRepository.findByTransactionId(transactionId);
        if (reservation != null) {
            // å–æ¶ˆæ‰£å‡ï¼šæ¢å¤å¯ç”¨åº“å­˜
            Inventory inventory = inventoryRepository.findByProductId(reservation.getProductId());
            inventory.setAvailableStock(inventory.getAvailableStock() + reservation.getQuantity());
            inventory.setReservedStock(inventory.getReservedStock() - reservation.getQuantity());
            inventoryRepository.save(inventory);
            
            // åˆ é™¤é¢„ç•™è®°å½•
            reservationRepository.delete(reservation);
        }
    }
}
```

### Sagaæ¨¡å¼å®ç°

Sagaæ˜¯ä¸€ç§é•¿äº‹åŠ¡å¤„ç†æ¨¡å¼ï¼š

```java
@Component
public class SagaOrchestrator {
    
    @Autowired
    private SagaDefinitionRegistry sagaRegistry;
    
    @Autowired
    private SagaInstanceRepository sagaInstanceRepository;
    
    @Autowired
    private MessagePublisher messagePublisher;
    
    /**
     * å¯åŠ¨Sagaäº‹åŠ¡
     */
    public String startSaga(String sagaType, Object sagaData) {
        SagaDefinition definition = sagaRegistry.getDefinition(sagaType);
        SagaInstance instance = new SagaInstance(UUID.randomUUID().toString(), sagaType, sagaData);
        
        sagaInstanceRepository.save(instance);
        
        // æ‰§è¡Œç¬¬ä¸€ä¸ªæ­¥éª¤
        executeNextStep(instance, definition);
        
        return instance.getId();
    }
    
    /**
     * æ‰§è¡Œä¸‹ä¸€ä¸ªæ­¥éª¤
     */
    private void executeNextStep(SagaInstance instance, SagaDefinition definition) {
        if (instance.getCurrentStep() < definition.getSteps().size()) {
            SagaStep step = definition.getSteps().get(instance.getCurrentStep());
            
            try {
                // å‘é€å‘½ä»¤æ¶ˆæ¯
                SagaCommand command = step.buildCommand(instance.getData());
                messagePublisher.publish(step.getCommandTopic(), command);
                
                // æ›´æ–°å®ä¾‹çŠ¶æ€
                instance.setStatus(SagaStatus.EXECUTING);
                instance.addExecutedStep(step.getName());
                sagaInstanceRepository.save(instance);
                
            } catch (Exception e) {
                // æ‰§è¡Œå¤±è´¥ï¼Œå¼€å§‹è¡¥å¿
                startCompensation(instance, definition);
            }
        } else {
            // æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæˆ
            instance.setStatus(SagaStatus.COMPLETED);
            sagaInstanceRepository.save(instance);
        }
    }
    
    /**
     * å¤„ç†æ­¥éª¤æ‰§è¡Œç»“æœ
     */
    @EventListener
    public void handleStepResult(SagaStepResultEvent event) {
        SagaInstance instance = sagaInstanceRepository.findById(event.getSagaId());
        SagaDefinition definition = sagaRegistry.getDefinition(instance.getType());
        
        if (event.isSuccess()) {
            // æ­¥éª¤æ‰§è¡ŒæˆåŠŸï¼Œç»§ç»­ä¸‹ä¸€æ­¥
            instance.setCurrentStep(instance.getCurrentStep() + 1);
            sagaInstanceRepository.save(instance);
            executeNextStep(instance, definition);
        } else {
            // æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œå¼€å§‹è¡¥å¿
            startCompensation(instance, definition);
        }
    }
    
    /**
     * å¼€å§‹è¡¥å¿æµç¨‹
     */
    private void startCompensation(SagaInstance instance, SagaDefinition definition) {
        instance.setStatus(SagaStatus.COMPENSATING);
        sagaInstanceRepository.save(instance);
        
        // é€†åºæ‰§è¡Œè¡¥å¿æ“ä½œ
        List<String> executedSteps = instance.getExecutedSteps();
        for (int i = executedSteps.size() - 1; i >= 0; i--) {
            String stepName = executedSteps.get(i);
            SagaStep step = definition.getStepByName(stepName);
            
            try {
                // å‘é€è¡¥å¿å‘½ä»¤
                SagaCompensationCommand compensationCommand = step.buildCompensationCommand(instance.getData());
                messagePublisher.publish(step.getCompensationTopic(), compensationCommand);
            } catch (Exception e) {
                // è¡¥å¿å¤±è´¥ï¼Œè®°å½•é”™è¯¯
                log.error("Compensation failed for step: " + stepName, e);
            }
        }
        
        instance.setStatus(SagaStatus.COMPENSATED);
        sagaInstanceRepository.save(instance);
    }
}

/**
 * Sagaå®šä¹‰
 */
public class OrderSagaDefinition extends SagaDefinition {
    
    public OrderSagaDefinition() {
        super("ORDER_SAGA");
        
        // å®šä¹‰Sagaæ­¥éª¤
        addStep(new SagaStep("CREATE_ORDER")
            .commandTopic("order.create")
            .compensationTopic("order.cancel")
            .commandBuilder(this::buildCreateOrderCommand)
            .compensationBuilder(this::buildCancelOrderCommand));
            
        addStep(new SagaStep("DEDUCT_INVENTORY")
            .commandTopic("inventory.deduct")
            .compensationTopic("inventory.restore")
            .commandBuilder(this::buildDeductInventoryCommand)
            .compensationBuilder(this::buildRestoreInventoryCommand));
            
        addStep(new SagaStep("PROCESS_PAYMENT")
            .commandTopic("payment.process")
            .compensationTopic("payment.refund")
            .commandBuilder(this::buildProcessPaymentCommand)
            .compensationBuilder(this::buildRefundPaymentCommand));
    }
    
    private CreateOrderCommand buildCreateOrderCommand(Object sagaData) {
        OrderSagaData data = (OrderSagaData) sagaData;
        return new CreateOrderCommand(data.getOrderId(), data.getCustomerId(), data.getItems());
    }
    
    private CancelOrderCommand buildCancelOrderCommand(Object sagaData) {
        OrderSagaData data = (OrderSagaData) sagaData;
        return new CancelOrderCommand(data.getOrderId());
    }
}
```

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ä¸ä»£ç ç¤ºä¾‹

### ç”µå•†è®¢å•åˆ†å¸ƒå¼äº‹åŠ¡

ç”µå•†ä¸‹å•æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„å…¸å‹åœºæ™¯ï¼š

```java
@Service
public class OrderTransactionService {
    
    @Autowired
    private TCCTransactionManager tccManager;
    
    @Autowired
    private SagaOrchestrator sagaOrchestrator;
    
    @Autowired
    private MessageTransactionManager messageTransactionManager;
    
    /**
     * ä½¿ç”¨TCCæ¨¡å¼å¤„ç†è®¢å•
     */
    public OrderResult createOrderWithTCC(CreateOrderRequest request) {
        TCCContext context = new TCCContext();
        context.setOrderRequest(request);
        context.setInventoryRequest(new InventoryDeductRequest(request.getProductId(), request.getQuantity()));
        context.setPaymentRequest(new PaymentRequest(request.getCustomerId(), request.getAmount()));
        
        TCCResult result = tccManager.executeTransaction(request.getOrderId(), context);
        
        return new OrderResult(result.isSuccess(), result.getTransactionId());
    }
    
    /**
     * ä½¿ç”¨Sagaæ¨¡å¼å¤„ç†è®¢å•
     */
    public String createOrderWithSaga(CreateOrderRequest request) {
        OrderSagaData sagaData = new OrderSagaData(request);
        return sagaOrchestrator.startSaga("ORDER_SAGA", sagaData);
    }
    
    /**
     * ä½¿ç”¨æ¶ˆæ¯äº‹åŠ¡å¤„ç†è®¢å•
     */
    public void createOrderWithMessage(CreateOrderRequest request) {
        messageTransactionManager.executeInTransaction(() -> {
            // 1. åˆ›å»ºæœ¬åœ°è®¢å•
            Order order = createLocalOrder(request);
            
            // 2. å‘é€æ¶ˆæ¯åˆ°å…¶ä»–æœåŠ¡
            OrderCreatedEvent event = new OrderCreatedEvent(order);
            messagePublisher.publish("order.created", event);
            
            return order;
        });
    }
}

/**
 * æ¶ˆæ¯äº‹åŠ¡ç®¡ç†å™¨
 */
@Component
public class MessageTransactionManager {
    
    @Autowired
    private DataSource dataSource;
    
    @Autowired
    private MessagePublisher messagePublisher;
    
    /**
     * æœ¬åœ°æ¶ˆæ¯è¡¨æ¨¡å¼
     */
    @Transactional
    public <T> T executeInTransaction(Supplier<T> businessOperation) {
        // 1. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
        T result = businessOperation.get();
        
        // 2. å°†æ¶ˆæ¯ä¿å­˜åˆ°æœ¬åœ°æ¶ˆæ¯è¡¨
        List<OutboxEvent> events = messagePublisher.getPendingEvents();
        for (OutboxEvent event : events) {
            outboxEventRepository.save(event);
        }
        
        return result;
    }
    
    /**
     * å¼‚æ­¥å‘é€æ¶ˆæ¯
     */
    @Scheduled(fixedDelay = 5000)
    public void sendPendingMessages() {
        List<OutboxEvent> pendingEvents = outboxEventRepository.findPendingEvents();
        
        for (OutboxEvent event : pendingEvents) {
            try {
                messagePublisher.publishEvent(event);
                event.setStatus(EventStatus.SENT);
                outboxEventRepository.save(event);
            } catch (Exception e) {
                event.incrementRetryCount();
                if (event.getRetryCount() > MAX_RETRY_COUNT) {
                    event.setStatus(EventStatus.FAILED);
                }
                outboxEventRepository.save(event);
            }
        }
    }
}

/**
 * è®¢å•æœåŠ¡æ¶ˆæ¯å¤„ç†
 */
@Component
public class OrderEventHandler {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private InventoryService inventoryService;
    
    /**
     * å¤„ç†åº“å­˜æ‰£å‡ç»“æœ
     */
    @RabbitListener(queues = "inventory.deducted")
    public void handleInventoryDeducted(InventoryDeductedEvent event) {
        if (event.isSuccess()) {
            // åº“å­˜æ‰£å‡æˆåŠŸï¼Œç»§ç»­å¤„ç†æ”¯ä»˜
            PaymentRequest paymentRequest = new PaymentRequest(event.getOrderId(), event.getAmount());
            paymentService.processPayment(paymentRequest);
        } else {
            // åº“å­˜æ‰£å‡å¤±è´¥ï¼Œå–æ¶ˆè®¢å•
            orderService.cancelOrder(event.getOrderId());
        }
    }
    
    /**
     * å¤„ç†æ”¯ä»˜ç»“æœ
     */
    @RabbitListener(queues = "payment.processed")
    public void handlePaymentProcessed(PaymentProcessedEvent event) {
        if (event.isSuccess()) {
            // æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å®Œæˆ
            orderService.completeOrder(event.getOrderId());
        } else {
            // æ”¯ä»˜å¤±è´¥ï¼Œæ¢å¤åº“å­˜å¹¶å–æ¶ˆè®¢å•
            inventoryService.restoreStock(event.getOrderId());
            orderService.cancelOrder(event.getOrderId());
        }
    }
}
```

### åˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶é›†æˆ

ä½¿ç”¨Seataç­‰åˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶ï¼š

```java
@Configuration
public class SeataConfig {
    
    @Bean
    public GlobalTransactionScanner globalTransactionScanner() {
        return new GlobalTransactionScanner("order-service", "default");
    }
}

@Service
public class SeataOrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    
    /**
     * ä½¿ç”¨Seata ATæ¨¡å¼
     */
    @GlobalTransactional(rollbackFor = Exception.class)
    public void createOrderWithSeata(CreateOrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order(request);
        orderMapper.insert(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        InventoryDeductRequest inventoryRequest = new InventoryDeductRequest(
            request.getProductId(), request.getQuantity());
        inventoryServiceClient.deductInventory(inventoryRequest);
        
        // 3. å¤„ç†æ”¯ä»˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        PaymentRequest paymentRequest = new PaymentRequest(
            request.getCustomerId(), request.getAmount());
        paymentServiceClient.processPayment(paymentRequest);
        
        // ä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½ä¼šè‡ªåŠ¨å›æ»š
    }
    
    /**
     * ä½¿ç”¨Seata TCCæ¨¡å¼
     */
    @GlobalTransactional
    public void createOrderWithSeataTCC(CreateOrderRequest request) {
        // Seataä¼šè‡ªåŠ¨ç®¡ç†TCCçš„ä¸‰ä¸ªé˜¶æ®µ
        inventoryTCCService.deductInventory(null, request.getProductId(), request.getQuantity());
        paymentTCCService.processPayment(null, request.getCustomerId(), request.getAmount());
    }
}

/**
 * Seata TCCå‚ä¸è€…
 */
@LocalTCC
public interface InventoryTCCService {
    
    @TwoPhaseBusinessAction(name = "deductInventory", commitMethod = "commitDeduct", rollbackMethod = "rollbackDeduct")
    boolean deductInventory(BusinessActionContext context, 
                           @BusinessActionContextParameter("productId") Long productId,
                           @BusinessActionContextParameter("quantity") Integer quantity);
    
    boolean commitDeduct(BusinessActionContext context);
    
    boolean rollbackDeduct(BusinessActionContext context);
}

@Service
public class InventoryTCCServiceImpl implements InventoryTCCService {
    
    @Override
    public boolean deductInventory(BusinessActionContext context, Long productId, Integer quantity) {
        // Tryé˜¶æ®µï¼šé¢„ç•™åº“å­˜
        return inventoryService.reserveInventory(productId, quantity);
    }
    
    @Override
    public boolean commitDeduct(BusinessActionContext context) {
        // Confirmé˜¶æ®µï¼šç¡®è®¤æ‰£å‡
        Long productId = (Long) context.getActionContext("productId");
        Integer quantity = (Integer) context.getActionContext("quantity");
        return inventoryService.confirmDeduct(productId, quantity);
    }
    
    @Override
    public boolean rollbackDeduct(BusinessActionContext context) {
        // Cancelé˜¶æ®µï¼šé‡Šæ”¾é¢„ç•™
        Long productId = (Long) context.getActionContext("productId");
        Integer quantity = (Integer) context.getActionContext("quantity");
        return inventoryService.releaseReservation(productId, quantity);
    }
}
```

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜ç²¾è®²

### 1. åˆ†å¸ƒå¼äº‹åŠ¡æœ‰å“ªäº›è§£å†³æ–¹æ¡ˆï¼Ÿå„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **2PC/3PC**ï¼šå¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½å·®ã€é˜»å¡ä¸¥é‡
- **TCC**ï¼šæ€§èƒ½å¥½ï¼Œä½†ä¸šåŠ¡ä¾µå…¥æ€§å¼º
- **Saga**ï¼šé€‚åˆé•¿äº‹åŠ¡ï¼Œä½†åªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- **æ¶ˆæ¯äº‹åŠ¡**ï¼šæ€§èƒ½å¥½ï¼Œä½†å®ç°å¤æ‚
- **ATæ¨¡å¼**ï¼šä¸šåŠ¡æ— ä¾µå…¥ï¼Œä½†ä¾èµ–ä¸­é—´ä»¶

**æ‰©å±•è¦ç‚¹**ï¼š
```java
// æ–¹æ¡ˆå¯¹æ¯”
2PC: å¼ºä¸€è‡´æ€§ï¼ŒåŒæ­¥é˜»å¡ï¼Œå•ç‚¹æ•…éšœ
TCC: æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸šåŠ¡ä¾µå…¥ï¼Œå®ç°å¤æ‚
Saga: æœ€ç»ˆä¸€è‡´æ€§ï¼Œè¡¥å¿å¤æ‚ï¼Œé€‚åˆé•¿äº‹åŠ¡
æ¶ˆæ¯äº‹åŠ¡: æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¼‚æ­¥å¤„ç†ï¼Œæ¶ˆæ¯å¯é æ€§
```

### 2. CAPå®šç†åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­å¦‚ä½•åº”ç”¨ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **CPç³»ç»Ÿ**ï¼šé€‰æ‹©ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œå¦‚2PC
- **APç³»ç»Ÿ**ï¼šé€‰æ‹©å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œå¦‚Saga
- **CAç³»ç»Ÿ**ï¼šåªåœ¨å•æœºæˆ–æ— ç½‘ç»œåˆ†åŒºæ—¶å¯èƒ½

**é¢è¯•æŠ€å·§**ï¼šç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯è¯´æ˜é€‰æ‹©åŸå› ã€‚

### 3. ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿå¦‚ä½•ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„å¹‚ç­‰æ€§ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
å¹‚ç­‰æ€§æ˜¯æŒ‡å¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œçš„ç»“æœç›¸åŒã€‚ä¿è¯æ–¹æ³•ï¼š
- **å”¯ä¸€æ€§çº¦æŸ**ï¼šæ•°æ®åº“å±‚é¢é˜²é‡
- **çŠ¶æ€æœº**ï¼šåŸºäºçŠ¶æ€è½¬æ¢
- **åˆ†å¸ƒå¼é”**ï¼šé˜²æ­¢å¹¶å‘é‡å¤æ‰§è¡Œ
- **æ¶ˆæ¯å»é‡**ï¼šåŸºäºæ¶ˆæ¯IDå»é‡

### 4. Sagaæ¨¡å¼çš„è¡¥å¿ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **å‘åæ¢å¤**ï¼šæ‰§è¡Œè¡¥å¿æ“ä½œæ’¤é”€å·²å®Œæˆçš„æ­¥éª¤
- **å‘å‰æ¢å¤**ï¼šé‡è¯•å¤±è´¥çš„æ­¥éª¤ç›´åˆ°æˆåŠŸ
- **æ··åˆç­–ç•¥**ï¼šæ ¹æ®æ­¥éª¤ç‰¹æ€§é€‰æ‹©ä¸åŒç­–ç•¥

### 5. åˆ†å¸ƒå¼äº‹åŠ¡ä¸­å¦‚ä½•å¤„ç†ç½‘ç»œåˆ†åŒºï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **è¶…æ—¶æœºåˆ¶**ï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- **é‡è¯•ç­–ç•¥**ï¼šæŒ‡æ•°é€€é¿é‡è¯•
- **ç†”æ–­å™¨**ï¼šé˜²æ­¢çº§è”æ•…éšœ
- **é™çº§æ–¹æ¡ˆ**ï¼šæä¾›å¤‡ç”¨å¤„ç†é€»è¾‘

### 6. æœ¬åœ°æ¶ˆæ¯è¡¨æ¨¡å¼çš„å®ç°åŸç†ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
1. ä¸šåŠ¡æ“ä½œå’Œæ¶ˆæ¯å†™å…¥åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­
2. å¼‚æ­¥ä»»åŠ¡æ‰«ææ¶ˆæ¯è¡¨å‘é€æ¶ˆæ¯
3. æ¶ˆæ¯å‘é€æˆåŠŸåæ›´æ–°çŠ¶æ€
4. æ”¯æŒé‡è¯•å’Œå¤±è´¥å¤„ç†

### 7. å¦‚ä½•é€‰æ‹©åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
è€ƒè™‘å› ç´ ï¼š
- **ä¸€è‡´æ€§è¦æ±‚**ï¼šå¼ºä¸€è‡´æ€§é€‰2PCï¼Œæœ€ç»ˆä¸€è‡´æ€§é€‰Saga
- **æ€§èƒ½è¦æ±‚**ï¼šé«˜æ€§èƒ½é€‰TCCæˆ–æ¶ˆæ¯äº‹åŠ¡
- **ä¸šåŠ¡å¤æ‚åº¦**ï¼šç®€å•ä¸šåŠ¡é€‰ATæ¨¡å¼
- **æŠ€æœ¯æ ˆ**ï¼šè€ƒè™‘ç°æœ‰æŠ€æœ¯æ ˆçš„å…¼å®¹æ€§

### 8. åˆ†å¸ƒå¼äº‹åŠ¡çš„ç›‘æ§å’Œè¿ç»´ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **äº‹åŠ¡çŠ¶æ€ç›‘æ§**ï¼šè·Ÿè¸ªäº‹åŠ¡æ‰§è¡ŒçŠ¶æ€
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§äº‹åŠ¡æ‰§è¡Œæ—¶é—´å’ŒæˆåŠŸç‡
- **å¼‚å¸¸å‘Šè­¦**ï¼šäº‹åŠ¡å¤±è´¥ã€è¶…æ—¶å‘Šè­¦
- **æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§

## âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### åˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–

```java
@Component
public class TransactionOptimizer {
    
    /**
     * å¼‚æ­¥åŒ–ä¼˜åŒ–
     */
    public void asyncOptimization() {
        // å°†éå…³é”®æ­¥éª¤å¼‚æ­¥åŒ–
        CompletableFuture.runAsync(() -> {
            notificationService.sendOrderNotification(order);
        });
        
        // ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦
        messagePublisher.publish("order.analytics", new OrderAnalyticsEvent(order));
    }
    
    /**
     * æ‰¹é‡å¤„ç†ä¼˜åŒ–
     */
    @Scheduled(fixedDelay = 1000)
    public void batchProcessing() {
        List<PendingTransaction> transactions = getPendingTransactions();
        if (!transactions.isEmpty()) {
            // æ‰¹é‡æäº¤äº‹åŠ¡
            batchCommitTransactions(transactions);
        }
    }
    
    /**
     * è¶…æ—¶æ§åˆ¶
     */
    @GlobalTransactional(timeoutMills = 30000)
    public void transactionWithTimeout() {
        // è®¾ç½®åˆç†çš„äº‹åŠ¡è¶…æ—¶æ—¶é—´
    }
}
```

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

1. **é•¿äº‹åŠ¡é—®é¢˜**ï¼šæ‹†åˆ†ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡
2. **æ­»é”é—®é¢˜**ï¼šç»Ÿä¸€èµ„æºè®¿é—®é¡ºåº
3. **æ•°æ®å€¾æ–œ**ï¼šåˆç†çš„åˆ†ç‰‡ç­–ç•¥
4. **è¡¥å¿å¤±è´¥**ï¼šäººå·¥å¹²é¢„æœºåˆ¶

### ç›‘æ§å’Œå‘Šè­¦

```java
@Component
public class TransactionMonitor {
    
    @EventListener
    public void handleTransactionEvent(TransactionEvent event) {
        // è®°å½•äº‹åŠ¡æŒ‡æ ‡
        transactionMetrics.record(event);
        
        // æ£€æŸ¥å¼‚å¸¸æƒ…å†µ
        if (event.getDuration() > SLOW_TRANSACTION_THRESHOLD) {
            alertService.sendSlowTransactionAlert(event);
        }
    }
}
```

## ğŸ“š æ€»ç»“ä¸æŠ€æœ¯å¯¹æ¯”

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜ï¼š

1. **ç†è§£æƒè¡¡**ï¼šåœ¨ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€æ€§èƒ½é—´æ‰¾å¹³è¡¡
2. **é€‰æ‹©åˆé€‚æ–¹æ¡ˆ**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©äº‹åŠ¡æ¨¡å¼
3. **å…³æ³¨è¿ç»´**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶
4. **æŒç»­ä¼˜åŒ–**ï¼šåŸºäºä¸šåŠ¡å‘å±•è°ƒæ•´äº‹åŠ¡ç­–ç•¥

### æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| æ–¹æ¡ˆ | ä¸€è‡´æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|--------|----------|
| 2PC | å¼ºä¸€è‡´ | ä½ | ä¸­ | å¼ºä¸€è‡´æ€§è¦æ±‚ |
| TCC | æœ€ç»ˆä¸€è‡´ | é«˜ | é«˜ | é«˜æ€§èƒ½è¦æ±‚ |
| Saga | æœ€ç»ˆä¸€è‡´ | é«˜ | ä¸­ | é•¿äº‹åŠ¡å¤„ç† |
| æ¶ˆæ¯äº‹åŠ¡ | æœ€ç»ˆä¸€è‡´ | é«˜ | ä¸­ | å¼‚æ­¥å¤„ç† |
| ATæ¨¡å¼ | å¼ºä¸€è‡´ | ä¸­ | ä½ | ä¸šåŠ¡æ— ä¾µå…¥ |

### æŒç»­å­¦ä¹ å»ºè®®

1. **æ·±å…¥ç†è§£åˆ†å¸ƒå¼ç†è®º**ï¼šCAPã€BASEã€ACIDç­‰
2. **å®è·µä¸åŒäº‹åŠ¡æ¨¡å¼**ï¼šåœ¨é¡¹ç›®ä¸­å°è¯•å„ç§æ–¹æ¡ˆ
3. **å…³æ³¨ä¸­é—´ä»¶å‘å±•**ï¼šSeataã€DTMç­‰æ–°æŠ€æœ¯
4. **å­¦ä¹ ç›¸å…³æŠ€æœ¯**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼é”ç­‰

åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¸€ä¸ªå¤æ‚ä½†é‡è¦çš„æŠ€æœ¯é¢†åŸŸï¼Œéœ€è¦ç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯ï¼Œåœ¨ä¸€è‡´æ€§ã€æ€§èƒ½å’Œå¤æ‚åº¦ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹ã€‚ 