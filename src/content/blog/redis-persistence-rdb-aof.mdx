---
title: "RedisæŒä¹…åŒ–æœºåˆ¶RDBä¸AOFæ·±åº¦è§£æ"
description: "æ·±å…¥æ¢è®¨Redisä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆRDBå¿«ç…§å’ŒAOFæ—¥å¿—çš„å®ç°åŸç†ã€æ€§èƒ½å¯¹æ¯”å’Œæœ€ä½³å®è·µã€‚æŒæ¡æ•°æ®æ¢å¤ç­–ç•¥ã€æ··åˆæŒä¹…åŒ–é…ç½®å’Œç”Ÿäº§ç¯å¢ƒä¼˜åŒ–æŠ€å·§ã€‚"
pubDate: 2024-12-28
updatedDate: 2024-12-28
tags: ["redis", "persistence", "rdb", "aof", "data-recovery", "performance", "interview"]
categories: ["database"]
subject: "ç¼“å­˜æŠ€æœ¯"
draft: false
featured: true
author: "Gerrad Zhang"
location: "æ­¦æ±‰ï¼Œä¸­å›½"
---

## ğŸ¤” é—®é¢˜èƒŒæ™¯ä¸æŠ€æœ¯æ¼”è¿›

### æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

Redisä½œä¸ºå†…å­˜æ•°æ®åº“ï¼Œé¢ä¸´**æ•°æ®æŒä¹…åŒ–**çš„æ ¸å¿ƒæŒ‘æˆ˜ï¼š

- **æœåŠ¡å™¨é‡å¯æ•°æ®ä¸¢å¤±**ï¼šå†…å­˜ä¸­çš„æ•°æ®åœ¨è¿›ç¨‹ç»“æŸæ—¶å…¨éƒ¨ä¸¢å¤±
- **ç³»ç»Ÿæ•…éšœæ•°æ®æ¢å¤**ï¼šç¡¬ä»¶æ•…éšœã€æ–­ç”µç­‰æ„å¤–æƒ…å†µä¸‹çš„æ•°æ®ä¿æŠ¤
- **æ•°æ®å¤‡ä»½ä¸è¿ç§»**ï¼šéœ€è¦å°†Redisæ•°æ®å¤‡ä»½åˆ°å…¶ä»–ç³»ç»Ÿæˆ–è¿ç§»åˆ°æ–°æœåŠ¡å™¨
- **é«˜å¯ç”¨æ€§è¦æ±‚**ï¼šç”Ÿäº§ç¯å¢ƒè¦æ±‚99.9%ä»¥ä¸Šçš„æ•°æ®å¯é æ€§

```java
// æ•°æ®ä¸¢å¤±é—®é¢˜ç¤ºä¾‹
public class DataLossScenario {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void demonstrateDataLossProblem() {
        // å­˜å‚¨é‡è¦çš„ç”¨æˆ·ä¼šè¯ä¿¡æ¯
        redisTemplate.opsForValue().set("session:user123", userSessionData);
        redisTemplate.opsForValue().set("cart:user123", shoppingCartData);
        redisTemplate.opsForHash().putAll("user:profile:123", userProfileData);
        
        // å‡è®¾æ­¤æ—¶RedisæœåŠ¡å™¨çªç„¶é‡å¯...
        // æ²¡æœ‰æŒä¹…åŒ–æœºåˆ¶ï¼Œæ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ï¼
        
        // ç”¨æˆ·å†æ¬¡è®¿é—®æ—¶
        Object session = redisTemplate.opsForValue().get("session:user123");
        if (session == null) {
            // ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
            // è´­ç‰©è½¦æ•°æ®ä¸¢å¤±
            // ç”¨æˆ·ä½“éªŒä¸¥é‡å—æŸ
            log.error("ç”¨æˆ·ä¼šè¯æ•°æ®ä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ç™»å½•");
        }
    }
}
```

### æ²¡æœ‰è¿™ä¸ªæŠ€æœ¯æ—¶æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

åœ¨RedisæŒä¹…åŒ–æœºåˆ¶å‡ºç°ä¹‹å‰ï¼Œå¼€å‘è€…ä¸»è¦é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¿è¯æ•°æ®å®‰å…¨ï¼š

**1. å®šæœŸæ•°æ®å¯¼å‡º**
```bash
# æ‰‹åŠ¨å¤‡ä»½Redisæ•°æ®
redis-cli --rdb /backup/redis-backup.rdb
```
- **é—®é¢˜**ï¼šå¤‡ä»½é—´éš”å†…çš„æ•°æ®ä»å¯èƒ½ä¸¢å¤±ï¼Œæ“ä½œå¤æ‚

**2. åŒå†™æœºåˆ¶**
```java
// åŒæ—¶å†™å…¥Rediså’Œæ•°æ®åº“
public void saveUserData(User user) {
    // å†™å…¥æ•°æ®åº“
    userRepository.save(user);
    // å†™å…¥Redisç¼“å­˜
    redisTemplate.opsForValue().set("user:" + user.getId(), user);
}
```
- **é—®é¢˜**ï¼šæ•°æ®ä¸€è‡´æ€§éš¾ä»¥ä¿è¯ï¼Œæ€§èƒ½å¼€é”€å¤§

**3. ä¸»ä»å¤åˆ¶**
- é€šè¿‡å¤šä¸ªRediså®ä¾‹äº’ç›¸å¤‡ä»½
- **é—®é¢˜**ï¼šä»ç„¶æ˜¯å†…å­˜å­˜å‚¨ï¼Œä¸»èŠ‚ç‚¹æ•…éšœæ—¶æ•°æ®ä¸¢å¤±

**4. å¤–éƒ¨æŒä¹…åŒ–æœåŠ¡**
- ä½¿ç”¨ä¸“é—¨çš„æŒä¹…åŒ–æœåŠ¡å®šæœŸåŒæ­¥æ•°æ®
- **é—®é¢˜**ï¼šæ¶æ„å¤æ‚ï¼Œå®æ—¶æ€§å·®

### æŠ€æœ¯æ¼”è¿›çš„å†å²è„‰ç»œ

**2009å¹´**: Redis 1.0å‘å¸ƒ
- ä»…æ”¯æŒåŸºæœ¬çš„RDBå¿«ç…§åŠŸèƒ½
- é€šè¿‡SAVEå‘½ä»¤æ‰‹åŠ¨åˆ›å»ºå¿«ç…§

**2010å¹´**: RDBè‡ªåŠ¨åŒ–
- å¼•å…¥BGSAVEåå°ä¿å­˜æœºåˆ¶
- æ”¯æŒé…ç½®è‡ªåŠ¨å¿«ç…§ç­–ç•¥

**2011å¹´**: AOFæ—¥å¿—å¼•å…¥
- Redis 2.0å¼•å…¥AOFï¼ˆAppend Only Fileï¼‰
- æä¾›æ›´å¥½çš„æ•°æ®å®‰å…¨æ€§

**2012-2014å¹´**: AOFä¼˜åŒ–
- AOFé‡å†™æœºåˆ¶
- AOFæ–‡ä»¶å‹ç¼©å’Œæ€§èƒ½ä¼˜åŒ–

**2016å¹´**: æ··åˆæŒä¹…åŒ–
- Redis 4.0å¼•å…¥RDB+AOFæ··åˆæ¨¡å¼
- ç»“åˆä¸¤ç§æ–¹æ¡ˆçš„ä¼˜åŠ¿

**2018å¹´è‡³ä»Š**: æ€§èƒ½æŒç»­ä¼˜åŒ–
- å¤šçº¿ç¨‹AOFå†™å…¥
- æ›´é«˜æ•ˆçš„åºåˆ—åŒ–ç®—æ³•
- äº‘åŸç”ŸæŒä¹…åŒ–æ”¯æŒ 

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µä¸åŸç†

### RDBå¿«ç…§æŒä¹…åŒ–

**RDBï¼ˆRedis Databaseï¼‰**æ˜¯Redisçš„é»˜è®¤æŒä¹…åŒ–æ–¹å¼ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®é›†å¿«ç…§ä¿å­˜åˆ°ç£ç›˜ã€‚

```java
/**
 * RDBæŒä¹…åŒ–æœºåˆ¶åˆ†æ
 */
public class RDBPersistenceAnalysis {
    
    /**
     * RDBå¿«ç…§åŸç†
     */
    public void analyzeRDBMechanism() {
        /*
         * RDBå·¥ä½œåŸç†ï¼š
         * 1. åˆ›å»ºå­è¿›ç¨‹æ‰§è¡Œå¿«ç…§æ“ä½œ
         * 2. å­è¿›ç¨‹å°†å†…å­˜æ•°æ®å†™å…¥ä¸´æ—¶RDBæ–‡ä»¶
         * 3. å†™å…¥å®Œæˆåæ›¿æ¢æ—§çš„RDBæ–‡ä»¶
         * 4. ä¸»è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
         * 
         * æ ¸å¿ƒç‰¹ç‚¹ï¼š
         * - å…¨é‡å¤‡ä»½ï¼šä¿å­˜æŸä¸ªæ—¶é—´ç‚¹çš„å®Œæ•´æ•°æ®é›†
         * - äºŒè¿›åˆ¶æ ¼å¼ï¼šç´§å‡‘é«˜æ•ˆçš„å­˜å‚¨æ ¼å¼
         * - åŸå­æ“ä½œï¼šè¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥
         * - éé˜»å¡ï¼šä½¿ç”¨fork()åˆ›å»ºå­è¿›ç¨‹ï¼Œä¸å½±å“ä¸»è¿›ç¨‹
         */
    }
    
    /**
     * RDBè§¦å‘æ¡ä»¶
     */
    public void analyzeRDBTriggers() {
        /*
         * è‡ªåŠ¨è§¦å‘æ¡ä»¶ï¼ˆredis.confé…ç½®ï¼‰ï¼š
         * save 900 1     # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–
         * save 300 10    # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–  
         * save 60 10000  # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–
         * 
         * æ‰‹åŠ¨è§¦å‘å‘½ä»¤ï¼š
         * SAVE    - åŒæ­¥ä¿å­˜ï¼Œé˜»å¡RedisæœåŠ¡
         * BGSAVE  - åå°ä¿å­˜ï¼Œä¸é˜»å¡æœåŠ¡
         * 
         * å…¶ä»–è§¦å‘åœºæ™¯ï¼š
         * - æ‰§è¡ŒFLUSHALLå‘½ä»¤
         * - Redisæ­£å¸¸å…³é—­
         * - ä¸»ä»å¤åˆ¶æ—¶ï¼ˆå…¨é‡åŒæ­¥ï¼‰
         */
    }
    
    /**
     * RDBæ–‡ä»¶æ ¼å¼
     */
    public void analyzeRDBFormat() {
        /*
         * RDBæ–‡ä»¶ç»“æ„ï¼š
         * 
         * +-------+-------------+-----------+-----------+-----+
         * | REDIS | RDB-VERSION | SELECT-DB | KEY-VALUE | EOF |
         * +-------+-------------+-----------+-----------+-----+
         * 
         * è¯¦ç»†æ ¼å¼ï¼š
         * 1. æ–‡ä»¶å¤´ï¼šREDIS + ç‰ˆæœ¬å·
         * 2. æ•°æ®åº“é€‰æ‹©ï¼šSELECT DBå‘½ä»¤
         * 3. é”®å€¼å¯¹ï¼šç±»å‹ + é”® + å€¼ + è¿‡æœŸæ—¶é—´
         * 4. æ–‡ä»¶å°¾ï¼šEOFæ ‡è®° + CRC64æ ¡éªŒ
         * 
         * æ•°æ®ç¼–ç ä¼˜åŒ–ï¼š
         * - æ•´æ•°ï¼šä½¿ç”¨å˜é•¿ç¼–ç 
         * - å­—ç¬¦ä¸²ï¼šLZFå‹ç¼©ç®—æ³•
         * - åˆ—è¡¨/é›†åˆï¼šç´§å‡‘å­˜å‚¨æ ¼å¼
         */
    }
}
```

### AOFæ—¥å¿—æŒä¹…åŒ–

**AOFï¼ˆAppend Only Fileï¼‰**é€šè¿‡è®°å½•RedisæœåŠ¡å™¨æ‰§è¡Œçš„å†™å‘½ä»¤æ¥å®ç°æŒä¹…åŒ–ã€‚

```java
/**
 * AOFæŒä¹…åŒ–æœºåˆ¶åˆ†æ
 */
public class AOFPersistenceAnalysis {
    
    /**
     * AOFå·¥ä½œåŸç†
     */
    public void analyzeAOFMechanism() {
        /*
         * AOFå·¥ä½œæµç¨‹ï¼š
         * 1. å®¢æˆ·ç«¯å‘é€å†™å‘½ä»¤
         * 2. Redisæ‰§è¡Œå†™å‘½ä»¤
         * 3. å°†å‘½ä»¤è¿½åŠ åˆ°AOFç¼“å†²åŒº
         * 4. æ ¹æ®ç­–ç•¥å°†ç¼“å†²åŒºå†…å®¹å†™å…¥AOFæ–‡ä»¶
         * 5. å®šæœŸå¯¹AOFæ–‡ä»¶è¿›è¡Œé‡å†™ä¼˜åŒ–
         * 
         * æ ¸å¿ƒç‰¹ç‚¹ï¼š
         * - å¢é‡å¤‡ä»½ï¼šåªè®°å½•å†™æ“ä½œå‘½ä»¤
         * - æ–‡æœ¬æ ¼å¼ï¼šå¯è¯»æ€§å¼ºï¼Œä¾¿äºåˆ†æ
         * - å®æ—¶æ€§å¥½ï¼šå¯é…ç½®ä¸åŒçš„åŒæ­¥ç­–ç•¥
         * - æ–‡ä»¶è¾ƒå¤§ï¼šåŒ…å«æ‰€æœ‰å†å²å†™å‘½ä»¤
         */
    }
    
    /**
     * AOFåŒæ­¥ç­–ç•¥
     */
    public void analyzeAOFSyncPolicy() {
        /*
         * appendfsyncé…ç½®é€‰é¡¹ï¼š
         * 
         * 1. alwaysï¼ˆæ€»æ˜¯åŒæ­¥ï¼‰
         *    - æ¯ä¸ªå†™å‘½ä»¤ç«‹å³åŒæ­¥åˆ°ç£ç›˜
         *    - æ•°æ®å®‰å…¨æ€§æœ€é«˜
         *    - æ€§èƒ½æœ€ä½
         *    - é€‚ç”¨ï¼šå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯
         * 
         * 2. everysecï¼ˆæ¯ç§’åŒæ­¥ï¼Œé»˜è®¤ï¼‰
         *    - æ¯ç§’å°†ç¼“å†²åŒºæ•°æ®åŒæ­¥åˆ°ç£ç›˜
         *    - å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§
         *    - æœ€å¤šä¸¢å¤±1ç§’æ•°æ®
         *    - é€‚ç”¨ï¼šå¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒ
         * 
         * 3. noï¼ˆæ“ä½œç³»ç»Ÿæ§åˆ¶ï¼‰
         *    - ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶åŒæ­¥
         *    - æ€§èƒ½æœ€é«˜
         *    - æ•°æ®å®‰å…¨æ€§æœ€ä½
         *    - é€‚ç”¨ï¼šå¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
         */
    }
    
    /**
     * AOFé‡å†™æœºåˆ¶
     */
    public void analyzeAOFRewrite() {
        /*
         * AOFé‡å†™åŸç†ï¼š
         * 
         * é—®é¢˜ï¼šAOFæ–‡ä»¶ä¼šæŒç»­å¢é•¿ï¼ŒåŒ…å«å¤§é‡å†—ä½™å‘½ä»¤
         * ä¾‹å¦‚ï¼š
         * SET counter 1
         * INCR counter
         * INCR counter
         * INCR counter
         * 
         * é‡å†™åï¼š
         * SET counter 4
         * 
         * é‡å†™è¿‡ç¨‹ï¼š
         * 1. åˆ›å»ºå­è¿›ç¨‹æ‰§è¡Œé‡å†™
         * 2. å­è¿›ç¨‹è¯»å–å½“å‰æ•°æ®åº“çŠ¶æ€
         * 3. ç”Ÿæˆæœ€å°‘çš„å‘½ä»¤é›†åˆ
         * 4. å†™å…¥æ–°çš„AOFæ–‡ä»¶
         * 5. åŸå­æ€§æ›¿æ¢æ—§æ–‡ä»¶
         * 
         * è§¦å‘æ¡ä»¶ï¼š
         * auto-aof-rewrite-percentage 100  # æ–‡ä»¶å¤§å°å¢é•¿100%
         * auto-aof-rewrite-min-size 64mb   # æœ€å°64MBæ‰é‡å†™
         */
    }
}
```

### æ··åˆæŒä¹…åŒ–æ¨¡å¼

**Redis 4.0+æ”¯æŒRDB+AOFæ··åˆæ¨¡å¼**ï¼Œç»“åˆä¸¤ç§æ–¹æ¡ˆçš„ä¼˜åŠ¿ï¼š

```java
/**
 * æ··åˆæŒä¹…åŒ–åˆ†æ
 */
public class HybridPersistenceAnalysis {
    
    /**
     * æ··åˆæ¨¡å¼åŸç†
     */
    public void analyzeHybridMode() {
        /*
         * æ··åˆæŒä¹…åŒ–å·¥ä½œæœºåˆ¶ï¼š
         * 
         * 1. AOFé‡å†™æ—¶ï¼Œå°†å½“å‰æ•°æ®ä»¥RDBæ ¼å¼å†™å…¥AOFæ–‡ä»¶å¤´éƒ¨
         * 2. åç»­çš„å†™å‘½ä»¤ä»¥AOFæ ¼å¼è¿½åŠ åˆ°æ–‡ä»¶å°¾éƒ¨
         * 3. æ¢å¤æ—¶å…ˆåŠ è½½RDBéƒ¨åˆ†ï¼Œå†é‡æ”¾AOFå‘½ä»¤
         * 
         * æ–‡ä»¶ç»“æ„ï¼š
         * +----------+----------+----------+
         * | RDBæ•°æ®  | AOFå‘½ä»¤  | AOFå‘½ä»¤  |
         * +----------+----------+----------+
         * 
         * ä¼˜åŠ¿ï¼š
         * - æ¢å¤é€Ÿåº¦å¿«ï¼šRDBæ ¼å¼åŠ è½½é€Ÿåº¦å¿«
         * - æ•°æ®å®‰å…¨æ€§é«˜ï¼šAOFä¿è¯æœ€æ–°æ•°æ®ä¸ä¸¢å¤±
         * - æ–‡ä»¶å¤§å°é€‚ä¸­ï¼šRDBå‹ç¼©ç‡é«˜
         * 
         * å¯ç”¨é…ç½®ï¼š
         * aof-use-rdb-preamble yes
         */
    }
}
``` 

## ğŸ”§ å®ç°åŸç†ä¸æºç åˆ†æ

### RDBæŒä¹…åŒ–æºç å®ç°

**RDBæŒä¹…åŒ–çš„æ ¸å¿ƒå®ç°ä½äº`rdb.c`æ–‡ä»¶ä¸­**ï¼š

```c
// Redis RDBæŒä¹…åŒ–æ ¸å¿ƒä»£ç åˆ†æ
/**
 * BGSAVEå‘½ä»¤å®ç° - åå°ä¿å­˜RDBæ–‡ä»¶
 */
int rdbSaveBackground(char *filename, rdbSaveInfo *rsi) {
    pid_t childpid;
    
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å­è¿›ç¨‹åœ¨æ‰§è¡Œ
    if (hasActiveChildProcess()) return C_ERR;
    
    // è®°å½•å¼€å§‹æ—¶é—´å’Œæ•°æ®åº“çŠ¶æ€
    server.dirty_before_bgsave = server.dirty;
    server.lastbgsave_try = time(NULL);
    openChildInfoPipe();
    
    // åˆ›å»ºå­è¿›ç¨‹
    if ((childpid = redisFork(CHILD_TYPE_RDB)) == 0) {
        /* å­è¿›ç¨‹ä»£ç  */
        int retval;
        
        // å…³é—­ç›‘å¬socketï¼Œå­è¿›ç¨‹ä¸å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
        closeListeningSockets(0);
        
        // è®¾ç½®è¿›ç¨‹æ ‡é¢˜
        redisSetProcTitle("redis-rdb-bgsave");
        
        // æ‰§è¡Œå®é™…çš„RDBä¿å­˜
        retval = rdbSave(filename, rsi);
        
        // å‘çˆ¶è¿›ç¨‹å‘é€ä¿å­˜ç»“æœ
        if (retval == C_OK) {
            sendChildCOWInfo(CHILD_TYPE_RDB, 1, "RDB");
        }
        
        // å­è¿›ç¨‹é€€å‡º
        exitFromChild((retval == C_OK) ? 0 : 1);
    } else {
        /* çˆ¶è¿›ç¨‹ä»£ç  */
        if (childpid == -1) {
            // forkå¤±è´¥å¤„ç†
            closeChildInfoPipe();
            server.lastbgsave_status = C_ERR;
            return C_ERR;
        }
        
        // è®°å½•å­è¿›ç¨‹ä¿¡æ¯
        server.rdb_child_pid = childpid;
        server.rdb_child_type = RDB_CHILD_TYPE_DISK;
        return C_OK;
    }
    return C_OK; /* unreached */
}

/**
 * RDBæ–‡ä»¶å†™å…¥æ ¸å¿ƒå‡½æ•°
 */
int rdbSave(char *filename, rdbSaveInfo *rsi) {
    char tmpfile[256];
    char cwd[MAXPATHLEN];
    FILE *fp = NULL;
    rio rdb;
    int error = 0;
    
    // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    snprintf(tmpfile, 256, "temp-%d.rdb", (int)getpid());
    fp = fopen(tmpfile, "w");
    if (!fp) return C_ERR;
    
    // åˆå§‹åŒ–RIOå¯¹è±¡ï¼ˆRedis I/OæŠ½è±¡å±‚ï¼‰
    rioInitWithFile(&rdb, fp);
    
    // å¯ç”¨æ ¡éªŒå’Œè®¡ç®—
    if (server.rdb_checksum)
        rdb.update_cksum = rioGenericUpdateChecksum;
    
    // å†™å…¥RDBæ–‡ä»¶å¤´
    if (rdbWriteRaw(&rdb, "REDIS", 5) == -1) goto werr;
    if (rdbSaveLen(&rdb, RDB_VERSION) == -1) goto werr;
    
    // å†™å…¥è¾…åŠ©ä¿¡æ¯
    if (rdbSaveInfoAuxFields(&rdb, flags, rsi) == -1) goto werr;
    
    // éå†æ‰€æœ‰æ•°æ®åº“
    for (j = 0; j < server.dbnum; j++) {
        redisDb *db = server.db + j;
        dict *d = db->dict;
        if (dictSize(d) == 0) continue;
        
        // å†™å…¥æ•°æ®åº“é€‰æ‹©æ ‡è®°
        if (rdbSaveType(&rdb, RDB_OPCODE_SELECTDB) == -1) goto werr;
        if (rdbSaveLen(&rdb, j) == -1) goto werr;
        
        // å†™å…¥æ•°æ®åº“å¤§å°ä¿¡æ¯
        uint64_t db_size, expires_size;
        db_size = dictSize(db->dict);
        expires_size = dictSize(db->expires);
        if (rdbSaveType(&rdb, RDB_OPCODE_RESIZEDB) == -1) goto werr;
        if (rdbSaveLen(&rdb, db_size) == -1) goto werr;
        if (rdbSaveLen(&rdb, expires_size) == -1) goto werr;
        
        // éå†å¹¶ä¿å­˜æ‰€æœ‰é”®å€¼å¯¹
        dictIterator *di = dictGetSafeIterator(d);
        dictEntry *de;
        while((de = dictNext(di)) != NULL) {
            sds keystr = dictGetKey(de);
            robj key, *o = dictGetVal(de);
            long long expire;
            
            // è·å–è¿‡æœŸæ—¶é—´
            expire = getExpire(db, &key);
            
            // ä¿å­˜é”®å€¼å¯¹
            if (rdbSaveKeyValuePair(&rdb, &key, o, expire) == -1) {
                dictReleaseIterator(di);
                goto werr;
            }
        }
        dictReleaseIterator(di);
    }
    
    // å†™å…¥EOFæ ‡è®°
    if (rdbSaveType(&rdb, RDB_OPCODE_EOF) == -1) goto werr;
    
    // å†™å…¥CRC64æ ¡éªŒå’Œ
    cksum = rdb.cksum;
    memrev64ifbe(&cksum);
    if (rioWrite(&rdb, &cksum, 8) == 0) goto werr;
    
    // åˆ·æ–°å¹¶å…³é—­æ–‡ä»¶
    if (fflush(fp) == EOF) goto werr;
    if (fsync(fileno(fp)) == -1) goto werr;
    if (fclose(fp) == EOF) goto werr;
    fp = NULL;
    
    // åŸå­æ€§æ›¿æ¢æ–‡ä»¶
    if (rename(tmpfile, filename) == -1) {
        unlink(tmpfile);
        return C_ERR;
    }
    
    return C_OK;

werr:
    // é”™è¯¯å¤„ç†
    if (fp) fclose(fp);
    unlink(tmpfile);
    return C_ERR;
}
```

### AOFæŒä¹…åŒ–æºç å®ç°

**AOFæŒä¹…åŒ–çš„æ ¸å¿ƒå®ç°ä½äº`aof.c`æ–‡ä»¶ä¸­**ï¼š

```c
// Redis AOFæŒä¹…åŒ–æ ¸å¿ƒä»£ç åˆ†æ
/**
 * AOFç¼“å†²åŒºå†™å…¥å‡½æ•°
 */
void feedAppendOnlyFile(int dictid, robj **argv, int argc) {
    sds buf = sdsempty();
    
    // å¦‚æœéœ€è¦åˆ‡æ¢æ•°æ®åº“
    if (dictid != server.aof_selected_db) {
        char seldb[64];
        
        snprintf(seldb, sizeof(seldb), "*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",
            (unsigned long)strlen(dictid_str), dictid_str);
        buf = sdscatlen(buf, seldb, strlen(seldb));
        server.aof_selected_db = dictid;
    }
    
    // å°†å‘½ä»¤è½¬æ¢ä¸ºRESPåè®®æ ¼å¼
    buf = catAppendOnlyGenericCommand(buf, argc, argv);
    
    // å†™å…¥AOFç¼“å†²åŒº
    if (sdslen(buf) > 0) {
        server.aof_buf = sdscatlen(server.aof_buf, buf, sdslen(buf));
        
        // å¦‚æœé…ç½®äº†alwaysåŒæ­¥ç­–ç•¥ï¼Œç«‹å³å†™å…¥ç£ç›˜
        if (server.aof_fsync == AOF_FSYNC_ALWAYS) {
            aof_background_fsync(server.aof_fd);
            server.aof_fsync_offset = server.aof_current_size;
            server.aof_last_fsync = server.unixtime;
        }
    }
    sdsfree(buf);
}

/**
 * AOFæ–‡ä»¶åŒæ­¥å‡½æ•°
 */
void flushAppendOnlyFile(int force) {
    ssize_t nwritten;
    int sync_in_progress = 0;
    mstime_t latency;
    
    // å¦‚æœç¼“å†²åŒºä¸ºç©ºï¼Œç›´æ¥è¿”å›
    if (sdslen(server.aof_buf) == 0) {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦fsync
        if (server.aof_fsync == AOF_FSYNC_EVERYSEC &&
            server.aof_fsync_offset != server.aof_current_size &&
            server.unixtime > server.aof_last_fsync &&
            !(sync_in_progress = aofFsyncInProgress())) {
            aof_background_fsync(server.aof_fd);
            server.aof_fsync_offset = server.aof_current_size;
            server.aof_last_fsync = server.unixtime;
        }
        return;
    }
    
    // æ£€æŸ¥fsyncæ˜¯å¦åœ¨è¿›è¡Œä¸­
    if (server.aof_fsync == AOF_FSYNC_EVERYSEC)
        sync_in_progress = aofFsyncInProgress();
    
    // å¦‚æœfsyncæ­£åœ¨è¿›è¡Œä¸”ä¸æ˜¯å¼ºåˆ¶å†™å…¥ï¼Œå»¶è¿Ÿå†™å…¥
    if (server.aof_fsync == AOF_FSYNC_EVERYSEC && !force) {
        if (sync_in_progress) {
            if (server.aof_flush_postponed_start == 0) {
                server.aof_flush_postponed_start = server.unixtime;
                return;
            } else if (server.unixtime - server.aof_flush_postponed_start < 2) {
                return;
            }
            server.aof_delayed_fsync++;
        }
    }
    
    // è®°å½•å»¶è¿Ÿ
    latencyStartMonitor(latency);
    
    // å†™å…¥AOFæ–‡ä»¶
    nwritten = aofWrite(server.aof_fd, server.aof_buf, sdslen(server.aof_buf));
    
    // è®°å½•å»¶è¿Ÿç»Ÿè®¡
    latencyEndMonitor(latency);
    latencyAddSampleIfNeeded("aof-write", latency);
    
    // é‡ç½®å»¶è¿Ÿå†™å…¥æ ‡è®°
    server.aof_flush_postponed_start = 0;
    
    // å¤„ç†å†™å…¥ç»“æœ
    if (nwritten != (ssize_t)sdslen(server.aof_buf)) {
        static time_t last_write_error_log = 0;
        int can_log = 0;
        
        // é”™è¯¯æ—¥å¿—é™æµ
        if ((server.unixtime - last_write_error_log) > AOF_WRITE_LOG_ERROR_RATE) {
            can_log = 1;
            last_write_error_log = server.unixtime;
        }
        
        if (nwritten == -1) {
            if (can_log) {
                serverLog(LL_WARNING, "Error writing to the AOF file: %s",
                    strerror(errno));
            }
        } else {
            if (can_log) {
                serverLog(LL_WARNING, "Short write while writing to "
                    "the AOF file: (nwritten=%lld, expected=%lld)",
                    (long long)nwritten, (long long)sdslen(server.aof_buf));
            }
        }
        
        // å¤„ç†å†™å…¥é”™è¯¯
        if (ftruncate(server.aof_fd, server.aof_current_size) == -1) {
            if (can_log) {
                serverLog(LL_WARNING, "Could not remove short write "
                    "from the append-only file. Redis may refuse "
                    "to load the AOF the next time it starts. "
                    "ftruncate: %s", strerror(errno));
            }
        } else {
            nwritten = -1;
        }
        
        // å¦‚æœæ— æ³•æ¢å¤ï¼Œé€€å‡ºæœåŠ¡å™¨
        if (nwritten == -1) {
            serverLog(LL_WARNING, "Exiting on error writing to the append-only file");
            exit(1);
        }
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    server.aof_current_size += nwritten;
    
    // æ¸…ç©ºç¼“å†²åŒº
    if ((sdslen(server.aof_buf) - nwritten) == 0) {
        sdsfree(server.aof_buf);
        server.aof_buf = sdsempty();
    } else {
        server.aof_buf = sdsrange(server.aof_buf, nwritten, -1);
    }
    
    // æ ¹æ®ç­–ç•¥æ‰§è¡Œfsync
    if (server.aof_no_fsync_on_rewrite && hasActiveChildProcess())
        return;
    
    if (server.aof_fsync == AOF_FSYNC_ALWAYS) {
        latencyStartMonitor(latency);
        redis_fsync(server.aof_fd);
        latencyEndMonitor(latency);
        latencyAddSampleIfNeeded("aof-fsync-always", latency);
        server.aof_fsync_offset = server.aof_current_size;
        server.aof_last_fsync = server.unixtime;
    } else if ((server.aof_fsync == AOF_FSYNC_EVERYSEC &&
                server.unixtime > server.aof_last_fsync)) {
        if (!sync_in_progress) {
            aof_background_fsync(server.aof_fd);
            server.aof_fsync_offset = server.aof_current_size;
            server.aof_last_fsync = server.unixtime;
        }
    }
}

/**
 * AOFé‡å†™å®ç°
 */
int rewriteAppendOnlyFileBackground(void) {
    pid_t childpid;
    
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å­è¿›ç¨‹åœ¨æ‰§è¡Œ
    if (hasActiveChildProcess()) return C_ERR;
    
    // åˆ›å»ºç®¡é“ç”¨äºçˆ¶å­è¿›ç¨‹é€šä¿¡
    if (aofCreatePipes() != C_OK) return C_ERR;
    
    openChildInfoPipe();
    if ((childpid = redisFork(CHILD_TYPE_AOF)) == 0) {
        /* å­è¿›ç¨‹ä»£ç  */
        char tmpfile[256];
        
        // å…³é—­ç›‘å¬socket
        closeListeningSockets(0);
        
        // è®¾ç½®è¿›ç¨‹æ ‡é¢˜
        redisSetProcTitle("redis-aof-rewrite");
        
        // ç”Ÿæˆä¸´æ—¶æ–‡ä»¶å
        snprintf(tmpfile, 256, "temp-rewriteaof-bg-%d.aof", (int)getpid());
        
        // æ‰§è¡ŒAOFé‡å†™
        if (rewriteAppendOnlyFile(tmpfile) == C_OK) {
            sendChildCOWInfo(CHILD_TYPE_AOF, 1, "AOF rewrite");
            exitFromChild(0);
        } else {
            exitFromChild(1);
        }
    } else {
        /* çˆ¶è¿›ç¨‹ä»£ç  */
        if (childpid == -1) {
            closeChildInfoPipe();
            return C_ERR;
        }
        
        // è®°å½•å­è¿›ç¨‹ä¿¡æ¯
        server.aof_child_pid = childpid;
        server.aof_rewrite_scheduled = 0;
        server.aof_rewrite_time_start = time(NULL);
        return C_OK;
    }
    return C_OK;
}
```

### æŒä¹…åŒ–æ€§èƒ½ä¼˜åŒ–æœºåˆ¶

```java
/**
 * RedisæŒä¹…åŒ–æ€§èƒ½ä¼˜åŒ–åˆ†æ
 */
public class PersistenceOptimization {
    
    /**
     * Copy-on-Writeä¼˜åŒ–
     */
    public void analyzeCOWOptimization() {
        /*
         * COWæœºåˆ¶åŸç†ï¼š
         * 
         * 1. fork()åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œçˆ¶å­è¿›ç¨‹å…±äº«ç›¸åŒçš„å†…å­˜é¡µ
         * 2. åªæœ‰å½“æŸä¸ªè¿›ç¨‹ä¿®æ”¹å†…å­˜é¡µæ—¶ï¼Œæ‰ä¼šå¤åˆ¶è¯¥é¡µ
         * 3. å¤§å¤§å‡å°‘äº†å†…å­˜ä½¿ç”¨å’Œforkæ—¶é—´
         * 
         * Redisä¸­çš„åº”ç”¨ï¼š
         * - RDBä¿å­˜ï¼šå­è¿›ç¨‹è¯»å–å…±äº«å†…å­˜ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†è¯·æ±‚
         * - AOFé‡å†™ï¼šå­è¿›ç¨‹ç”Ÿæˆæ–°AOFæ–‡ä»¶ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­è®°å½•æ–°å‘½ä»¤
         * 
         * ä¼˜åŒ–æ•ˆæœï¼š
         * - å†…å­˜ä½¿ç”¨ï¼šä»2å€å‡å°‘åˆ°1.xå€
         * - forkæ—¶é—´ï¼šä»O(n)å‡å°‘åˆ°O(1)
         * - æœåŠ¡å¯ç”¨æ€§ï¼šæŒä¹…åŒ–æœŸé—´ä¸é˜»å¡æœåŠ¡
         */
    }
    
    /**
     * å¤šçº¿ç¨‹ä¼˜åŒ–ï¼ˆRedis 6.0+ï¼‰
     */
    public void analyzeMultiThreadOptimization() {
        /*
         * Redis 6.0å¤šçº¿ç¨‹æ”¹è¿›ï¼š
         * 
         * 1. I/Oå¤šçº¿ç¨‹ï¼š
         *    - ç½‘ç»œI/Oä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†
         *    - å‘½ä»¤æ‰§è¡Œä»åœ¨ä¸»çº¿ç¨‹ï¼ˆä¿è¯å•çº¿ç¨‹è¯­ä¹‰ï¼‰
         *    - æå‡ç½‘ç»œååé‡
         * 
         * 2. AOFå¤šçº¿ç¨‹å†™å…¥ï¼š
         *    - AOFç¼“å†²åŒºå†™å…¥ä½¿ç”¨åå°çº¿ç¨‹
         *    - å‡å°‘ä¸»çº¿ç¨‹é˜»å¡æ—¶é—´
         *    - æå‡å†™å…¥æ€§èƒ½
         * 
         * é…ç½®å‚æ•°ï¼š
         * io-threads 4          # I/Oçº¿ç¨‹æ•°
         * io-threads-do-reads yes  # å¯ç”¨è¯»å¤šçº¿ç¨‹
         */
    }
}
``` 

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ä¸ä»£ç ç¤ºä¾‹

### æŒä¹…åŒ–é…ç½®æœ€ä½³å®è·µ

```java
/**
 * RedisæŒä¹…åŒ–é…ç½®ç®¡ç†
 */
@Configuration
@EnableConfigurationProperties(RedisProperties.class)
public class RedisPersistenceConfig {
    
    /**
     * ç”Ÿäº§ç¯å¢ƒRedisé…ç½®
     */
    @Bean
    @Primary
    public LettuceConnectionFactory redisConnectionFactory() {
        RedisStandaloneConfiguration config = new RedisStandaloneConfiguration();
        config.setHostName("redis.example.com");
        config.setPort(6379);
        config.setPassword("your_password");
        config.setDatabase(0);
        
        // è¿æ¥æ± é…ç½®
        GenericObjectPoolConfig<StatefulRedisConnection<String, String>> poolConfig = 
            new GenericObjectPoolConfig<>();
        poolConfig.setMaxTotal(20);
        poolConfig.setMaxIdle(10);
        poolConfig.setMinIdle(5);
        poolConfig.setTestOnBorrow(true);
        
        LettucePoolingClientConfiguration clientConfig = LettucePoolingClientConfiguration.builder()
            .poolConfig(poolConfig)
            .commandTimeout(Duration.ofSeconds(5))
            .shutdownTimeout(Duration.ofSeconds(3))
            .build();
        
        return new LettuceConnectionFactory(config, clientConfig);
    }
    
    /**
     * Redisæ¨¡æ¿é…ç½®
     */
    @Bean
    public RedisTemplate<String, Object> redisTemplate(LettuceConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // åºåˆ—åŒ–é…ç½®
        Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper om = new ObjectMapper();
        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        om.activateDefaultTyping(LazyInitTargetSource.class, ObjectMapper.DefaultTyping.NON_FINAL);
        serializer.setObjectMapper(om);
        
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        
        template.afterPropertiesSet();
        return template;
    }
}
```

### æŒä¹…åŒ–ç­–ç•¥é€‰æ‹©ä¸é…ç½®

```bash
# redis.conf ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹

# ==================== RDBé…ç½® ====================
# RDBè‡ªåŠ¨ä¿å­˜ç­–ç•¥
save 900 1      # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 300 10     # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 60 10000   # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜

# RDBæ–‡ä»¶é…ç½®
dbfilename dump.rdb                    # RDBæ–‡ä»¶å
dir /var/lib/redis                     # æ•°æ®æ–‡ä»¶ç›®å½•
rdbcompression yes                     # å¯ç”¨RDBå‹ç¼©
rdbchecksum yes                        # å¯ç”¨RDBæ ¡éªŒå’Œ
rdb-del-sync-files no                  # ä¿ç•™åŒæ­¥æ–‡ä»¶

# ==================== AOFé…ç½® ====================
# å¯ç”¨AOFæŒä¹…åŒ–
appendonly yes                         # å¼€å¯AOF
appendfilename "appendonly.aof"        # AOFæ–‡ä»¶å

# AOFåŒæ­¥ç­–ç•¥
appendfsync everysec                   # æ¯ç§’åŒæ­¥ï¼ˆæ¨èï¼‰
# appendfsync always                   # æ¯æ¬¡å†™å…¥åŒæ­¥ï¼ˆæœ€å®‰å…¨ä½†æœ€æ…¢ï¼‰
# appendfsync no                       # æ“ä½œç³»ç»Ÿæ§åˆ¶ï¼ˆæœ€å¿«ä½†æœ€ä¸å®‰å…¨ï¼‰

# AOFé‡å†™é…ç½®
auto-aof-rewrite-percentage 100        # æ–‡ä»¶å¤§å°å¢é•¿100%æ—¶é‡å†™
auto-aof-rewrite-min-size 64mb         # æœ€å°64MBæ‰è§¦å‘é‡å†™
aof-load-truncated yes                 # å…è®¸åŠ è½½æˆªæ–­çš„AOFæ–‡ä»¶

# æ··åˆæŒä¹…åŒ–ï¼ˆRedis 4.0+ï¼‰
aof-use-rdb-preamble yes               # å¯ç”¨æ··åˆæŒä¹…åŒ–

# ==================== æ€§èƒ½ä¼˜åŒ–é…ç½® ====================
# å†…å­˜ä¼˜åŒ–
maxmemory 2gb                          # æœ€å¤§å†…å­˜é™åˆ¶
maxmemory-policy allkeys-lru           # å†…å­˜æ·˜æ±°ç­–ç•¥

# åå°ä¿å­˜ä¼˜åŒ–
stop-writes-on-bgsave-error yes        # RDBä¿å­˜å¤±è´¥æ—¶åœæ­¢å†™å…¥
rdbcompression yes                     # å¯ç”¨RDBå‹ç¼©
lazyfree-lazy-eviction yes             # å¼‚æ­¥åˆ é™¤è¿‡æœŸkey
lazyfree-lazy-expire yes               # å¼‚æ­¥åˆ é™¤æ·˜æ±°key
lazyfree-lazy-server-del yes           # å¼‚æ­¥åˆ é™¤æœåŠ¡å™¨åˆ é™¤

# ç½‘ç»œä¼˜åŒ–
tcp-keepalive 300                      # TCP keepaliveæ—¶é—´
timeout 0                              # å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´ï¼ˆ0=ç¦ç”¨ï¼‰
```

### æ•°æ®æ¢å¤å®æˆ˜æ¡ˆä¾‹

```java
/**
 * Redisæ•°æ®æ¢å¤æœåŠ¡
 */
@Service
@Slf4j
public class RedisRecoveryService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * ä»RDBæ–‡ä»¶æ¢å¤æ•°æ®
     */
    public boolean recoverFromRDB(String rdbFilePath) {
        try {
            log.info("å¼€å§‹ä»RDBæ–‡ä»¶æ¢å¤æ•°æ®: {}", rdbFilePath);
            
            // 1. åœæ­¢RedisæœåŠ¡
            // systemctl stop redis
            
            // 2. å¤‡ä»½å½“å‰æ•°æ®
            backupCurrentData();
            
            // 3. æ›¿æ¢RDBæ–‡ä»¶
            Path sourcePath = Paths.get(rdbFilePath);
            Path targetPath = Paths.get("/var/lib/redis/dump.rdb");
            Files.copy(sourcePath, targetPath, StandardCopyOption.REPLACE_EXISTING);
            
            // 4. å¯åŠ¨RedisæœåŠ¡
            // systemctl start redis
            
            // 5. éªŒè¯æ•°æ®æ¢å¤
            return validateRecovery();
            
        } catch (Exception e) {
            log.error("RDBæ•°æ®æ¢å¤å¤±è´¥", e);
            return false;
        }
    }
    
    /**
     * ä»AOFæ–‡ä»¶æ¢å¤æ•°æ®
     */
    public boolean recoverFromAOF(String aofFilePath) {
        try {
            log.info("å¼€å§‹ä»AOFæ–‡ä»¶æ¢å¤æ•°æ®: {}", aofFilePath);
            
            // 1. æ£€æŸ¥AOFæ–‡ä»¶å®Œæ•´æ€§
            if (!checkAOFIntegrity(aofFilePath)) {
                log.error("AOFæ–‡ä»¶æŸåï¼Œå°è¯•ä¿®å¤...");
                if (!repairAOFFile(aofFilePath)) {
                    return false;
                }
            }
            
            // 2. åœæ­¢RedisæœåŠ¡å¹¶å¤‡ä»½
            backupCurrentData();
            
            // 3. æ›¿æ¢AOFæ–‡ä»¶
            Path sourcePath = Paths.get(aofFilePath);
            Path targetPath = Paths.get("/var/lib/redis/appendonly.aof");
            Files.copy(sourcePath, targetPath, StandardCopyOption.REPLACE_EXISTING);
            
            // 4. å¯åŠ¨Rediså¹¶éªŒè¯
            return validateRecovery();
            
        } catch (Exception e) {
            log.error("AOFæ•°æ®æ¢å¤å¤±è´¥", e);
            return false;
        }
    }
    
    /**
     * æ··åˆæŒä¹…åŒ–æ–‡ä»¶æ¢å¤
     */
    public boolean recoverFromHybrid(String hybridFilePath) {
        try {
            log.info("å¼€å§‹ä»æ··åˆæŒä¹…åŒ–æ–‡ä»¶æ¢å¤æ•°æ®: {}", hybridFilePath);
            
            // æ··åˆæ–‡ä»¶åŒ…å«RDBå¤´éƒ¨å’ŒAOFå°¾éƒ¨
            // Redisä¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ­£ç¡®åŠ è½½
            
            backupCurrentData();
            
            Path sourcePath = Paths.get(hybridFilePath);
            Path targetPath = Paths.get("/var/lib/redis/appendonly.aof");
            Files.copy(sourcePath, targetPath, StandardCopyOption.REPLACE_EXISTING);
            
            return validateRecovery();
            
        } catch (Exception e) {
            log.error("æ··åˆæŒä¹…åŒ–æ•°æ®æ¢å¤å¤±è´¥", e);
            return false;
        }
    }
    
    /**
     * æ£€æŸ¥AOFæ–‡ä»¶å®Œæ•´æ€§
     */
    private boolean checkAOFIntegrity(String aofFilePath) {
        try {
            // ä½¿ç”¨redis-check-aofå·¥å…·æ£€æŸ¥
            Process process = Runtime.getRuntime().exec(
                "redis-check-aof --fix " + aofFilePath);
            int exitCode = process.waitFor();
            return exitCode == 0;
        } catch (Exception e) {
            log.error("AOFå®Œæ•´æ€§æ£€æŸ¥å¤±è´¥", e);
            return false;
        }
    }
    
    /**
     * ä¿®å¤æŸåçš„AOFæ–‡ä»¶
     */
    private boolean repairAOFFile(String aofFilePath) {
        try {
            // åˆ›å»ºå¤‡ä»½
            String backupPath = aofFilePath + ".backup." + System.currentTimeMillis();
            Files.copy(Paths.get(aofFilePath), Paths.get(backupPath));
            
            // ä½¿ç”¨redis-check-aofä¿®å¤
            Process process = Runtime.getRuntime().exec(
                "redis-check-aof --fix " + aofFilePath);
            int exitCode = process.waitFor();
            
            if (exitCode == 0) {
                log.info("AOFæ–‡ä»¶ä¿®å¤æˆåŠŸï¼Œå¤‡ä»½ä¿å­˜åœ¨: {}", backupPath);
                return true;
            } else {
                log.error("AOFæ–‡ä»¶ä¿®å¤å¤±è´¥");
                return false;
            }
        } catch (Exception e) {
            log.error("AOFæ–‡ä»¶ä¿®å¤è¿‡ç¨‹å‡ºé”™", e);
            return false;
        }
    }
    
    /**
     * å¤‡ä»½å½“å‰æ•°æ®
     */
    private void backupCurrentData() {
        try {
            String timestamp = String.valueOf(System.currentTimeMillis());
            
            // æ‰§è¡ŒBGSAVEåˆ›å»ºRDBå¤‡ä»½
            redisTemplate.execute((RedisCallback<Object>) connection -> {
                connection.bgSave();
                return null;
            });
            
            // ç­‰å¾…å¤‡ä»½å®Œæˆ
            Thread.sleep(5000);
            
            // å¤åˆ¶æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•
            String backupDir = "/var/backup/redis/" + timestamp;
            Files.createDirectories(Paths.get(backupDir));
            
            // å¤‡ä»½RDBæ–‡ä»¶
            Files.copy(
                Paths.get("/var/lib/redis/dump.rdb"),
                Paths.get(backupDir + "/dump.rdb"),
                StandardCopyOption.REPLACE_EXISTING
            );
            
            // å¤‡ä»½AOFæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            Path aofPath = Paths.get("/var/lib/redis/appendonly.aof");
            if (Files.exists(aofPath)) {
                Files.copy(
                    aofPath,
                    Paths.get(backupDir + "/appendonly.aof"),
                    StandardCopyOption.REPLACE_EXISTING
                );
            }
            
            log.info("å½“å‰æ•°æ®å·²å¤‡ä»½åˆ°: {}", backupDir);
            
        } catch (Exception e) {
            log.error("æ•°æ®å¤‡ä»½å¤±è´¥", e);
        }
    }
    
    /**
     * éªŒè¯æ•°æ®æ¢å¤ç»“æœ
     */
    private boolean validateRecovery() {
        try {
            // ç­‰å¾…Rediså¯åŠ¨
            Thread.sleep(3000);
            
            // æµ‹è¯•è¿æ¥
            String pong = redisTemplate.execute((RedisCallback<String>) connection -> {
                return connection.ping();
            });
            
            if (!"PONG".equals(pong)) {
                log.error("Redisè¿æ¥æµ‹è¯•å¤±è´¥");
                return false;
            }
            
            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            Long dbSize = redisTemplate.execute((RedisCallback<Long>) connection -> {
                return connection.dbSize();
            });
            
            log.info("æ•°æ®æ¢å¤å®Œæˆï¼Œå½“å‰æ•°æ®åº“å¤§å°: {} keys", dbSize);
            
            // å¯ä»¥æ·»åŠ æ›´å¤šçš„ä¸šåŠ¡æ•°æ®éªŒè¯é€»è¾‘
            return validateBusinessData();
            
        } catch (Exception e) {
            log.error("æ•°æ®æ¢å¤éªŒè¯å¤±è´¥", e);
            return false;
        }
    }
    
    /**
     * éªŒè¯ä¸šåŠ¡æ•°æ®å®Œæ•´æ€§
     */
    private boolean validateBusinessData() {
        try {
            // æ£€æŸ¥å…³é”®ä¸šåŠ¡æ•°æ®æ˜¯å¦å­˜åœ¨
            Boolean userExists = redisTemplate.hasKey("user:1001");
            Boolean configExists = redisTemplate.hasKey("system:config");
            
            if (!userExists || !configExists) {
                log.warn("éƒ¨åˆ†å…³é”®ä¸šåŠ¡æ•°æ®ç¼ºå¤±");
                return false;
            }
            
            // æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
            Object userData = redisTemplate.opsForValue().get("user:1001");
            if (userData == null) {
                log.warn("ç”¨æˆ·æ•°æ®æ ¼å¼å¼‚å¸¸");
                return false;
            }
            
            log.info("ä¸šåŠ¡æ•°æ®éªŒè¯é€šè¿‡");
            return true;
            
        } catch (Exception e) {
            log.error("ä¸šåŠ¡æ•°æ®éªŒè¯å¤±è´¥", e);
            return false;
        }
    }
}
```

### æŒä¹…åŒ–ç›‘æ§ä¸æŠ¥è­¦

```java
/**
 * RedisæŒä¹…åŒ–ç›‘æ§æœåŠ¡
 */
@Service
@Slf4j
public class RedisPersistenceMonitor {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private NotificationService notificationService;
    
    /**
     * ç›‘æ§RDBæŒä¹…åŒ–çŠ¶æ€
     */
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void monitorRDBStatus() {
        try {
            Properties info = redisTemplate.execute((RedisCallback<Properties>) connection -> {
                return connection.info("persistence");
            });
            
            // æ£€æŸ¥æœ€åä¸€æ¬¡RDBä¿å­˜çŠ¶æ€
            String lastSaveStatus = info.getProperty("rdb_last_bgsave_status");
            if (!"ok".equals(lastSaveStatus)) {
                String message = "RDBæŒä¹…åŒ–å¤±è´¥: " + lastSaveStatus;
                log.error(message);
                notificationService.sendAlert("Redis RDB Error", message);
            }
            
            // æ£€æŸ¥RDBä¿å­˜æ—¶é—´é—´éš”
            long lastSaveTime = Long.parseLong(info.getProperty("rdb_last_save_time"));
            long currentTime = System.currentTimeMillis() / 1000;
            long timeSinceLastSave = currentTime - lastSaveTime;
            
            // å¦‚æœè¶…è¿‡2å°æ—¶æ²¡æœ‰ä¿å­˜ï¼Œå‘å‡ºè­¦å‘Š
            if (timeSinceLastSave > 7200) {
                String message = String.format("RDBä¿å­˜é—´éš”è¿‡é•¿: %dç§’", timeSinceLastSave);
                log.warn(message);
                notificationService.sendWarning("Redis RDB Warning", message);
            }
            
        } catch (Exception e) {
            log.error("RDBçŠ¶æ€ç›‘æ§å¤±è´¥", e);
        }
    }
    
    /**
     * ç›‘æ§AOFæŒä¹…åŒ–çŠ¶æ€
     */
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void monitorAOFStatus() {
        try {
            Properties info = redisTemplate.execute((RedisCallback<Properties>) connection -> {
                return connection.info("persistence");
            });
            
            // æ£€æŸ¥AOFæ˜¯å¦å¯ç”¨
            String aofEnabled = info.getProperty("aof_enabled");
            if (!"1".equals(aofEnabled)) {
                return; // AOFæœªå¯ç”¨ï¼Œè·³è¿‡æ£€æŸ¥
            }
            
            // æ£€æŸ¥AOFæœ€åå†™å…¥çŠ¶æ€
            String lastWriteStatus = info.getProperty("aof_last_write_status");
            if (!"ok".equals(lastWriteStatus)) {
                String message = "AOFå†™å…¥å¤±è´¥: " + lastWriteStatus;
                log.error(message);
                notificationService.sendAlert("Redis AOF Error", message);
            }
            
            // æ£€æŸ¥AOFé‡å†™çŠ¶æ€
            String rewriteInProgress = info.getProperty("aof_rewrite_in_progress");
            if ("1".equals(rewriteInProgress)) {
                long rewriteStartTime = Long.parseLong(info.getProperty("aof_rewrite_time_last"));
                long currentTime = System.currentTimeMillis() / 1000;
                long rewriteDuration = currentTime - rewriteStartTime;
                
                // å¦‚æœé‡å†™è¶…è¿‡30åˆ†é’Ÿï¼Œå‘å‡ºè­¦å‘Š
                if (rewriteDuration > 1800) {
                    String message = String.format("AOFé‡å†™æ—¶é—´è¿‡é•¿: %dç§’", rewriteDuration);
                    log.warn(message);
                    notificationService.sendWarning("Redis AOF Rewrite Warning", message);
                }
            }
            
            // æ£€æŸ¥AOFæ–‡ä»¶å¤§å°
            long aofSize = Long.parseLong(info.getProperty("aof_current_size"));
            long baseSize = Long.parseLong(info.getProperty("aof_base_size"));
            
            if (baseSize > 0) {
                double growthRatio = (double) aofSize / baseSize;
                if (growthRatio > 5.0) { // æ–‡ä»¶å¢é•¿è¶…è¿‡5å€
                    String message = String.format("AOFæ–‡ä»¶å¢é•¿è¿‡å¿«: %.2få€", growthRatio);
                    log.warn(message);
                    notificationService.sendWarning("Redis AOF Growth Warning", message);
                }
            }
            
        } catch (Exception e) {
            log.error("AOFçŠ¶æ€ç›‘æ§å¤±è´¥", e);
        }
    }
    
    /**
     * ç£ç›˜ç©ºé—´ç›‘æ§
     */
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void monitorDiskSpace() {
        try {
            File dataDir = new File("/var/lib/redis");
            long freeSpace = dataDir.getFreeSpace();
            long totalSpace = dataDir.getTotalSpace();
            double freePercentage = (double) freeSpace / totalSpace * 100;
            
            if (freePercentage < 10.0) { // å¯ç”¨ç©ºé—´å°‘äº10%
                String message = String.format("Redisæ•°æ®ç›®å½•ç£ç›˜ç©ºé—´ä¸è¶³: %.2f%%", freePercentage);
                log.error(message);
                notificationService.sendAlert("Redis Disk Space Critical", message);
            } else if (freePercentage < 20.0) { // å¯ç”¨ç©ºé—´å°‘äº20%
                String message = String.format("Redisæ•°æ®ç›®å½•ç£ç›˜ç©ºé—´åä½: %.2f%%", freePercentage);
                log.warn(message);
                notificationService.sendWarning("Redis Disk Space Warning", message);
            }
            
        } catch (Exception e) {
            log.error("ç£ç›˜ç©ºé—´ç›‘æ§å¤±è´¥", e);
        }
    }
}
``` 

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜ç²¾è®²

### åŸºç¡€æ¦‚å¿µç±»é—®é¢˜

**Q1: Redisæœ‰å“ªå‡ ç§æŒä¹…åŒ–æ–¹å¼ï¼Ÿå„æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ**

A: Redisæä¾›ä¸‰ç§æŒä¹…åŒ–æ–¹å¼ï¼š

1. **RDBå¿«ç…§æŒä¹…åŒ–**
   - ç‰¹ç‚¹ï¼šå…¨é‡å¤‡ä»½ï¼ŒäºŒè¿›åˆ¶æ ¼å¼ï¼Œæ–‡ä»¶å°ï¼Œæ¢å¤å¿«
   - ä¼˜åŠ¿ï¼šæ€§èƒ½å¥½ï¼Œé€‚åˆå¤‡ä»½å’Œç¾éš¾æ¢å¤
   - åŠ£åŠ¿ï¼šå¯èƒ½ä¸¢å¤±æœ€åä¸€æ¬¡å¿«ç…§åçš„æ•°æ®

2. **AOFæ—¥å¿—æŒä¹…åŒ–**
   - ç‰¹ç‚¹ï¼šå¢é‡å¤‡ä»½ï¼Œè®°å½•å†™å‘½ä»¤ï¼Œæ–‡æœ¬æ ¼å¼
   - ä¼˜åŠ¿ï¼šæ•°æ®å®‰å…¨æ€§é«˜ï¼Œå¯è¯»æ€§å¼º
   - åŠ£åŠ¿ï¼šæ–‡ä»¶å¤§ï¼Œæ¢å¤æ…¢

3. **æ··åˆæŒä¹…åŒ–ï¼ˆRDB+AOFï¼‰**
   - ç‰¹ç‚¹ï¼šç»“åˆä¸¤è€…ä¼˜åŠ¿ï¼ŒRDBå¤´éƒ¨+AOFå°¾éƒ¨
   - ä¼˜åŠ¿ï¼šæ¢å¤å¿«ä¸”æ•°æ®å®‰å…¨
   - åŠ£åŠ¿ï¼šRedis 4.0+æ‰æ”¯æŒ

**Q2: RDBå’ŒAOFçš„è§¦å‘æ—¶æœºåˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

A: 
- **RDBè§¦å‘**ï¼š
  - è‡ªåŠ¨ï¼šæ»¡è¶³saveé…ç½®æ¡ä»¶ï¼ˆå¦‚save 900 1ï¼‰
  - æ‰‹åŠ¨ï¼šSAVE/BGSAVEå‘½ä»¤
  - å…¶ä»–ï¼šFLUSHALLã€ä¸»ä»å¤åˆ¶ã€æ­£å¸¸å…³é—­

- **AOFè§¦å‘**ï¼š
  - æ¯ä¸ªå†™å‘½ä»¤æ‰§è¡Œåç«‹å³è®°å½•åˆ°AOFç¼“å†²åŒº
  - æ ¹æ®appendfsyncç­–ç•¥åŒæ­¥åˆ°ç£ç›˜
  - AOFé‡å†™æ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨è§¦å‘

### å®ç°åŸç†ç±»é—®é¢˜

**Q3: è§£é‡ŠRDBçš„Copy-on-Writeæœºåˆ¶**

A: COWæœºåˆ¶æ˜¯RDBé«˜æ€§èƒ½çš„å…³é”®ï¼š

1. **fork()åˆ›å»ºå­è¿›ç¨‹**ï¼šçˆ¶å­è¿›ç¨‹å…±äº«ç›¸åŒçš„å†…å­˜é¡µ
2. **å†…å­˜é¡µå…±äº«**ï¼šåªè¯»è®¿é—®æ—¶ä¸å¤åˆ¶å†…å­˜
3. **å†™æ—¶å¤åˆ¶**ï¼šå½“çˆ¶è¿›ç¨‹ä¿®æ”¹æ•°æ®æ—¶ï¼Œæ‰å¤åˆ¶ç›¸å…³å†…å­˜é¡µ
4. **ç‹¬ç«‹æ“ä½œ**ï¼šå­è¿›ç¨‹è¯»å–åŸå§‹æ•°æ®ç”ŸæˆRDBï¼Œçˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†è¯·æ±‚

```java
// COWæœºåˆ¶ç¤ºä¾‹
public void demonstrateCOW() {
    /*
     * 1. fork()æ—¶åˆ»ï¼š
     *    çˆ¶è¿›ç¨‹å†…å­˜ï¼š[Page1][Page2][Page3]
     *    å­è¿›ç¨‹å†…å­˜ï¼š[Page1][Page2][Page3] (å…±äº«)
     * 
     * 2. çˆ¶è¿›ç¨‹ä¿®æ”¹Page2ï¼š
     *    çˆ¶è¿›ç¨‹å†…å­˜ï¼š[Page1][Page2'][Page3]
     *    å­è¿›ç¨‹å†…å­˜ï¼š[Page1][Page2][Page3] (Page2æœªå˜)
     * 
     * 3. ç»“æœï¼š
     *    - å­è¿›ç¨‹è¯»å–åŸå§‹Page2ç”ŸæˆRDB
     *    - çˆ¶è¿›ç¨‹ä½¿ç”¨æ–°çš„Page2'å¤„ç†è¯·æ±‚
     *    - ä¸¤è€…äº’ä¸å½±å“
     */
}
```

**Q4: AOFé‡å†™çš„å…·ä½“è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ**

A: AOFé‡å†™åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š

1. **åˆ›å»ºå­è¿›ç¨‹**ï¼šfork()åˆ›å»ºé‡å†™å­è¿›ç¨‹
2. **ç”Ÿæˆæ–°AOF**ï¼šå­è¿›ç¨‹éå†æ•°æ®åº“ï¼Œç”Ÿæˆæœ€å°å‘½ä»¤é›†
3. **ç¼“å†²åŒºæœºåˆ¶**ï¼šçˆ¶è¿›ç¨‹å°†æ–°å‘½ä»¤å†™å…¥é‡å†™ç¼“å†²åŒº
4. **åˆå¹¶æ“ä½œ**ï¼šé‡å†™å®Œæˆåï¼Œå°†ç¼“å†²åŒºå‘½ä»¤è¿½åŠ åˆ°æ–°æ–‡ä»¶
5. **åŸå­æ›¿æ¢**ï¼šrename()åŸå­æ€§æ›¿æ¢æ—§AOFæ–‡ä»¶

### æ€§èƒ½ä¼˜åŒ–ç±»é—®é¢˜

**Q5: å¦‚ä½•ä¼˜åŒ–RedisæŒä¹…åŒ–æ€§èƒ½ï¼Ÿ**

A: ä»å¤šä¸ªç»´åº¦è¿›è¡Œä¼˜åŒ–ï¼š

1. **RDBä¼˜åŒ–**ï¼š
   - åˆç†è®¾ç½®saveå‚æ•°ï¼Œé¿å…é¢‘ç¹å¿«ç…§
   - ä½¿ç”¨SSDå­˜å‚¨ï¼Œæå‡I/Oæ€§èƒ½
   - åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡ŒBGSAVE

2. **AOFä¼˜åŒ–**ï¼š
   - é€‰æ‹©åˆé€‚çš„appendfsyncç­–ç•¥
   - åŠæ—¶è¿›è¡ŒAOFé‡å†™ï¼Œæ§åˆ¶æ–‡ä»¶å¤§å°
   - ä½¿ç”¨no-appendfsync-on-rewriteå‡å°‘é‡å†™æ—¶I/Oå†²çª

3. **ç³»ç»Ÿä¼˜åŒ–**ï¼š
   - è°ƒæ•´vm.overcommit_memory=1
   - å…³é—­THPï¼ˆTransparent Huge Pagesï¼‰
   - ä¼˜åŒ–ç£ç›˜è°ƒåº¦ç®—æ³•

**Q6: ç”Ÿäº§ç¯å¢ƒå¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ**

A: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ï¼š

| ä¸šåŠ¡åœºæ™¯ | æ¨èç­–ç•¥ | é…ç½®å»ºè®® |
|---------|---------|---------|
| é«˜æ€§èƒ½ç¼“å­˜ | RDB | save 900 1, save 300 10 |
| æ•°æ®å®‰å…¨ä¼˜å…ˆ | AOF | appendfsync everysec |
| å¹³è¡¡æ€§èƒ½å®‰å…¨ | æ··åˆæŒä¹…åŒ– | aof-use-rdb-preamble yes |
| è¯»å¤šå†™å°‘ | RDB+å®šæœŸå¤‡ä»½ | é•¿é—´éš”saveé…ç½® |
| å†™å¯†é›†å‹ | AOF+é‡å†™ä¼˜åŒ– | ç§¯æçš„é‡å†™ç­–ç•¥ |

### æ•…éšœå¤„ç†ç±»é—®é¢˜

**Q7: AOFæ–‡ä»¶æŸåå¦‚ä½•å¤„ç†ï¼Ÿ**

A: åˆ†æ­¥éª¤å¤„ç†AOFæŸåï¼š

1. **æ£€æŸ¥æŸåç¨‹åº¦**ï¼šä½¿ç”¨redis-check-aofæ£€æŸ¥
2. **å¤‡ä»½åŸæ–‡ä»¶**ï¼šé˜²æ­¢ä¿®å¤å¤±è´¥
3. **å°è¯•ä¿®å¤**ï¼šredis-check-aof --fix
4. **éªŒè¯ä¿®å¤ç»“æœ**ï¼šæ£€æŸ¥æ•°æ®å®Œæ•´æ€§
5. **å¦‚æœæ— æ³•ä¿®å¤**ï¼šä½¿ç”¨RDBå¤‡ä»½æ¢å¤

```bash
# AOFä¿®å¤æµç¨‹
cp appendonly.aof appendonly.aof.backup
redis-check-aof --fix appendonly.aof
redis-server --appendonly yes
redis-cli ping  # éªŒè¯æœåŠ¡å¯åŠ¨
```

**Q8: å¦‚ä½•å¤„ç†æŒä¹…åŒ–å¯¼è‡´çš„å†…å­˜ä¸è¶³ï¼Ÿ**

A: å¤šç§ç­–ç•¥è§£å†³å†…å­˜é—®é¢˜ï¼š

1. **è°ƒæ•´æŒä¹…åŒ–ç­–ç•¥**ï¼š
   - å»¶é•¿RDBé—´éš”
   - ä½¿ç”¨AOFæ›¿ä»£RDB
   - åœ¨å†…å­˜å……è¶³æ—¶æ‰§è¡ŒæŒä¹…åŒ–

2. **ç³»ç»Ÿé…ç½®ä¼˜åŒ–**ï¼š
   - è®¾ç½®vm.overcommit_memory=1
   - å¢åŠ swapç©ºé—´
   - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

3. **åº”ç”¨å±‚ä¼˜åŒ–**ï¼š
   - æ§åˆ¶æ•°æ®é‡å¢é•¿
   - ä½¿ç”¨æ•°æ®è¿‡æœŸç­–ç•¥
   - åˆ†ç‰‡å‡å°‘å•å®ä¾‹å†…å­˜å‹åŠ›

## âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### æŒä¹…åŒ–æ€§èƒ½è°ƒä¼˜

```java
/**
 * RedisæŒä¹…åŒ–æ€§èƒ½è°ƒä¼˜é…ç½®
 */
public class PersistencePerformanceTuning {
    
    /**
     * RDBæ€§èƒ½ä¼˜åŒ–é…ç½®
     */
    public void optimizeRDBPerformance() {
        /*
         * 1. åˆç†é…ç½®saveå‚æ•°
         * 
         * # é«˜æ€§èƒ½åœºæ™¯ï¼ˆå¯æ¥å—å°‘é‡æ•°æ®ä¸¢å¤±ï¼‰
         * save 3600 1      # 1å°æ—¶å†…æœ‰å˜åŒ–æ‰ä¿å­˜
         * save 1800 100    # 30åˆ†é’Ÿå†…100ä¸ªå˜åŒ–
         * 
         * # å¹³è¡¡åœºæ™¯ï¼ˆæ¨èï¼‰
         * save 900 1       # 15åˆ†é’Ÿå†…æœ‰å˜åŒ–
         * save 300 10      # 5åˆ†é’Ÿå†…10ä¸ªå˜åŒ–
         * save 60 10000    # 1åˆ†é’Ÿå†…10000ä¸ªå˜åŒ–
         * 
         * # é«˜å®‰å…¨åœºæ™¯
         * save 300 1       # 5åˆ†é’Ÿå†…æœ‰å˜åŒ–å°±ä¿å­˜
         * save 60 10       # 1åˆ†é’Ÿå†…10ä¸ªå˜åŒ–
         */
        
        /*
         * 2. ç³»ç»Ÿçº§ä¼˜åŒ–
         * 
         * # Linuxå†…æ ¸å‚æ•°
         * vm.overcommit_memory = 1     # å…è®¸å†…å­˜è¶…é‡åˆ†é…
         * vm.swappiness = 1            # å‡å°‘swapä½¿ç”¨
         * 
         * # ç¦ç”¨é€æ˜å¤§é¡µ
         * echo never > /sys/kernel/mm/transparent_hugepage/enabled
         * 
         * # æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
         * mount -o noatime,nodiratime /dev/sdb1 /var/lib/redis
         */
    }
    
    /**
     * AOFæ€§èƒ½ä¼˜åŒ–é…ç½®
     */
    public void optimizeAOFPerformance() {
        /*
         * 1. åŒæ­¥ç­–ç•¥ä¼˜åŒ–
         * 
         * # é«˜æ€§èƒ½ï¼ˆå¯èƒ½ä¸¢å¤±2ç§’æ•°æ®ï¼‰
         * appendfsync no
         * 
         * # å¹³è¡¡æ€§èƒ½ï¼ˆæ¨èï¼Œæœ€å¤šä¸¢å¤±1ç§’ï¼‰
         * appendfsync everysec
         * 
         * # é«˜å®‰å…¨ï¼ˆæ€§èƒ½è¾ƒä½ï¼‰
         * appendfsync always
         */
        
        /*
         * 2. é‡å†™ä¼˜åŒ–é…ç½®
         * 
         * # ç§¯æé‡å†™ç­–ç•¥
         * auto-aof-rewrite-percentage 50    # 50%å¢é•¿å°±é‡å†™
         * auto-aof-rewrite-min-size 32mb    # æœ€å°32MB
         * 
         * # ä¿å®ˆé‡å†™ç­–ç•¥
         * auto-aof-rewrite-percentage 200   # 200%å¢é•¿æ‰é‡å†™
         * auto-aof-rewrite-min-size 128mb   # æœ€å°128MB
         * 
         * # é‡å†™æœŸé—´ä¸åŒæ­¥ï¼ˆæå‡æ€§èƒ½ï¼‰
         * no-appendfsync-on-rewrite yes
         */
    }
    
    /**
     * æ··åˆæŒä¹…åŒ–ä¼˜åŒ–
     */
    public void optimizeHybridPersistence() {
        /*
         * æ··åˆæŒä¹…åŒ–é…ç½®ï¼ˆRedis 4.0+ï¼‰
         * 
         * # å¯ç”¨æ··åˆæŒä¹…åŒ–
         * aof-use-rdb-preamble yes
         * 
         * # é…åˆä½¿ç”¨çš„å…¶ä»–å‚æ•°
         * appendonly yes
         * appendfsync everysec
         * auto-aof-rewrite-percentage 100
         * auto-aof-rewrite-min-size 64mb
         * 
         * ä¼˜åŠ¿ï¼š
         * - æ¢å¤é€Ÿåº¦ï¼šæ¥è¿‘RDBçš„å¿«é€Ÿæ¢å¤
         * - æ•°æ®å®‰å…¨ï¼šä¿æŒAOFçš„æ•°æ®å®Œæ•´æ€§
         * - æ–‡ä»¶å¤§å°ï¼šæ¯”çº¯AOFå°å¾ˆå¤š
         */
    }
}
```

### ç›‘æ§æŒ‡æ ‡ä¸å‘Šè­¦

```java
/**
 * æŒä¹…åŒ–ç›‘æ§æŒ‡æ ‡
 */
public class PersistenceMetrics {
    
    /**
     * å…³é”®ç›‘æ§æŒ‡æ ‡
     */
    public void defineKeyMetrics() {
        /*
         * RDBç›‘æ§æŒ‡æ ‡ï¼š
         * - rdb_last_save_time: æœ€åä¿å­˜æ—¶é—´
         * - rdb_last_bgsave_status: æœ€åä¿å­˜çŠ¶æ€
         * - rdb_last_bgsave_time_sec: æœ€åä¿å­˜è€—æ—¶
         * - rdb_current_bgsave_time_sec: å½“å‰ä¿å­˜è€—æ—¶
         * - rdb_saves: æ€»ä¿å­˜æ¬¡æ•°
         * - rdb_bgsave_in_progress: æ˜¯å¦æ­£åœ¨ä¿å­˜
         * 
         * AOFç›‘æ§æŒ‡æ ‡ï¼š
         * - aof_enabled: AOFæ˜¯å¦å¯ç”¨
         * - aof_rewrite_in_progress: æ˜¯å¦æ­£åœ¨é‡å†™
         * - aof_last_rewrite_time_sec: æœ€åé‡å†™è€—æ—¶
         * - aof_current_rewrite_time_sec: å½“å‰é‡å†™è€—æ—¶
         * - aof_last_bgrewrite_status: æœ€åé‡å†™çŠ¶æ€
         * - aof_current_size: å½“å‰AOFæ–‡ä»¶å¤§å°
         * - aof_base_size: AOFåŸºç¡€å¤§å°
         * 
         * ç³»ç»Ÿç›‘æ§æŒ‡æ ‡ï¼š
         * - used_memory: å†…å­˜ä½¿ç”¨é‡
         * - used_memory_rss: ç‰©ç†å†…å­˜ä½¿ç”¨é‡
         * - mem_fragmentation_ratio: å†…å­˜ç¢ç‰‡ç‡
         * - total_commands_processed: æ€»å‘½ä»¤æ•°
         * - instantaneous_ops_per_sec: æ¯ç§’æ“ä½œæ•°
         */
    }
    
    /**
     * å‘Šè­¦é˜ˆå€¼è®¾ç½®
     */
    public void defineAlertThresholds() {
        /*
         * ä¸¥é‡å‘Šè­¦ï¼ˆCriticalï¼‰ï¼š
         * - RDBä¿å­˜å¤±è´¥
         * - AOFå†™å…¥å¤±è´¥
         * - ç£ç›˜ç©ºé—´ä¸è¶³ï¼ˆ<10%ï¼‰
         * - å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼ˆ>90%ï¼‰
         * 
         * è­¦å‘Šå‘Šè­¦ï¼ˆWarningï¼‰ï¼š
         * - RDBä¿å­˜é—´éš”è¿‡é•¿ï¼ˆ>2å°æ—¶ï¼‰
         * - AOFé‡å†™æ—¶é—´è¿‡é•¿ï¼ˆ>30åˆ†é’Ÿï¼‰
         * - AOFæ–‡ä»¶å¢é•¿è¿‡å¿«ï¼ˆ>5å€ï¼‰
         * - ç£ç›˜ç©ºé—´åä½ï¼ˆ<20%ï¼‰
         * 
         * ä¿¡æ¯å‘Šè­¦ï¼ˆInfoï¼‰ï¼š
         * - æŒä¹…åŒ–æ“ä½œå¼€å§‹/å®Œæˆ
         * - é…ç½®å˜æ›´
         * - æ€§èƒ½æŒ‡æ ‡å¼‚å¸¸
         */
    }
}
```

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

```java
/**
 * æŒä¹…åŒ–å¸¸è§é—®é¢˜å¤„ç†
 */
public class PersistenceIssueHandler {
    
    /**
     * é—®é¢˜1ï¼šforkå¤±è´¥å¯¼è‡´æŒä¹…åŒ–æ— æ³•è¿›è¡Œ
     */
    public void handleForkFailure() {
        /*
         * ç°è±¡ï¼š
         * - BGSAVEå¤±è´¥
         * - AOFé‡å†™å¤±è´¥
         * - æ—¥å¿—æ˜¾ç¤º"Cannot allocate memory"
         * 
         * åŸå› ï¼š
         * - å¯ç”¨å†…å­˜ä¸è¶³
         * - vm.overcommit_memoryè®¾ç½®ä¸å½“
         * - å†…å­˜ç¢ç‰‡è¿‡å¤š
         * 
         * è§£å†³æ–¹æ¡ˆï¼š
         * 1. è®¾ç½®vm.overcommit_memory=1
         * 2. å¢åŠ swapç©ºé—´
         * 3. é‡å¯Rediså‡å°‘å†…å­˜ç¢ç‰‡
         * 4. å‡çº§æœåŠ¡å™¨å†…å­˜
         */
        
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
        Runtime runtime = Runtime.getRuntime();
        long maxMemory = runtime.maxMemory();
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        long usedMemory = totalMemory - freeMemory;
        
        double memoryUsage = (double) usedMemory / maxMemory * 100;
        if (memoryUsage > 80) {
            log.warn("å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {}%", memoryUsage);
        }
    }
    
    /**
     * é—®é¢˜2ï¼šAOFæ–‡ä»¶è¿‡å¤§å½±å“æ€§èƒ½
     */
    public void handleLargeAOFFile() {
        /*
         * ç°è±¡ï¼š
         * - AOFæ–‡ä»¶å‡ GBç”šè‡³å‡ åGB
         * - é‡å¯æ¢å¤æ—¶é—´å¾ˆé•¿
         * - ç£ç›˜ç©ºé—´ä¸è¶³
         * 
         * åŸå› ï¼š
         * - AOFé‡å†™é…ç½®ä¸å½“
         * - å†™å…¥é‡å¤§ä½†é‡å†™ä¸åŠæ—¶
         * - é‡å†™å¤±è´¥å¯¼è‡´æ–‡ä»¶æŒç»­å¢é•¿
         * 
         * è§£å†³æ–¹æ¡ˆï¼š
         * 1. æ‰‹åŠ¨æ‰§è¡ŒBGREWRITEAOF
         * 2. è°ƒæ•´auto-aof-rewriteå‚æ•°
         * 3. è€ƒè™‘ä½¿ç”¨æ··åˆæŒä¹…åŒ–
         * 4. å®šæœŸæ¸…ç†å†å²æ•°æ®
         */
        
        // æ£€æŸ¥AOFæ–‡ä»¶å¤§å°
        File aofFile = new File("/var/lib/redis/appendonly.aof");
        if (aofFile.exists()) {
            long fileSizeGB = aofFile.length() / (1024 * 1024 * 1024);
            if (fileSizeGB > 5) {
                log.warn("AOFæ–‡ä»¶è¿‡å¤§: {}GB", fileSizeGB);
                // è§¦å‘é‡å†™
                // BGREWRITEAOF
            }
        }
    }
    
    /**
     * é—®é¢˜3ï¼šæŒä¹…åŒ–å¯¼è‡´æ€§èƒ½æŠ–åŠ¨
     */
    public void handlePerformanceJitter() {
        /*
         * ç°è±¡ï¼š
         * - å®šæœŸå‡ºç°å“åº”æ—¶é—´é£™å‡
         * - QPSå‘¨æœŸæ€§ä¸‹é™
         * - å®¢æˆ·ç«¯è¶…æ—¶å¢åŠ 
         * 
         * åŸå› ï¼š
         * - RDBä¿å­˜æ—¶forké˜»å¡
         * - AOFåŒæ­¥ç­–ç•¥ä¸å½“
         * - ç£ç›˜I/Oç“¶é¢ˆ
         * 
         * è§£å†³æ–¹æ¡ˆï¼š
         * 1. ä½¿ç”¨SSDæ›¿ä»£æœºæ¢°ç¡¬ç›˜
         * 2. è°ƒæ•´æŒä¹…åŒ–ç­–ç•¥
         * 3. é”™å³°æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œ
         * 4. å¯ç”¨å¤šçº¿ç¨‹I/Oï¼ˆRedis 6.0+ï¼‰
         */
    }
}
```

## ğŸ“š æ€»ç»“ä¸æŠ€æœ¯å¯¹æ¯”

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

1. **RDBå¿«ç…§æŒä¹…åŒ–**é€‚åˆå¤‡ä»½å’Œç¾éš¾æ¢å¤ï¼Œæ€§èƒ½å¥½ä½†å¯èƒ½ä¸¢å¤±æ•°æ®
2. **AOFæ—¥å¿—æŒä¹…åŒ–**æä¾›æ›´å¥½çš„æ•°æ®å®‰å…¨æ€§ï¼Œä½†æ–‡ä»¶å¤§æ¢å¤æ…¢
3. **æ··åˆæŒä¹…åŒ–**ç»“åˆä¸¤è€…ä¼˜åŠ¿ï¼Œæ˜¯ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³é€‰æ‹©
4. **Copy-on-Writeæœºåˆ¶**æ˜¯RedisæŒä¹…åŒ–é«˜æ€§èƒ½çš„å…³é”®æŠ€æœ¯
5. **æŒä¹…åŒ–ç­–ç•¥é€‰æ‹©**éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§

### RedisæŒä¹…åŒ– vs å…¶ä»–æ•°æ®åº“å¯¹æ¯”

| ç‰¹æ€§ | Redis RDB | Redis AOF | MySQL Binlog | MongoDB Journal |
|------|-----------|-----------|--------------|-----------------|
| æ•°æ®æ ¼å¼ | äºŒè¿›åˆ¶å¿«ç…§ | æ–‡æœ¬å‘½ä»¤ | äºŒè¿›åˆ¶æ—¥å¿— | äºŒè¿›åˆ¶æ—¥å¿— |
| æ¢å¤é€Ÿåº¦ | å¿« | æ…¢ | ä¸­ç­‰ | ä¸­ç­‰ |
| æ–‡ä»¶å¤§å° | å° | å¤§ | ä¸­ç­‰ | ä¸­ç­‰ |
| æ•°æ®å®‰å…¨ | ä¸€èˆ¬ | é«˜ | é«˜ | é«˜ |
| å¯è¯»æ€§ | å·® | å¥½ | å·® | å·® |
| å¢é‡å¤‡ä»½ | å¦ | æ˜¯ | æ˜¯ | æ˜¯ |

### æœ€ä½³å®è·µå»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
   - å¯ç”¨æ··åˆæŒä¹…åŒ–ï¼š`aof-use-rdb-preamble yes`
   - åˆç†è®¾ç½®AOFåŒæ­¥ï¼š`appendfsync everysec`
   - é…ç½®è‡ªåŠ¨é‡å†™ï¼š`auto-aof-rewrite-percentage 100`

2. **ç›‘æ§å’Œè¿ç»´**ï¼š
   - ç›‘æ§æŒä¹…åŒ–çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
   - å®šæœŸå¤‡ä»½å’ŒéªŒè¯æ¢å¤æµç¨‹
   - å»ºç«‹å®Œå–„çš„å‘Šè­¦æœºåˆ¶

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨SSDå­˜å‚¨æå‡I/Oæ€§èƒ½
   - ä¼˜åŒ–ç³»ç»Ÿå†…æ ¸å‚æ•°
   - åˆç†è§„åˆ’æŒä¹…åŒ–æ—¶é—´çª—å£

4. **æ•…éšœå¤„ç†**ï¼š
   - åˆ¶å®šæ•°æ®æ¢å¤é¢„æ¡ˆ
   - å®šæœŸæ¼”ç»ƒæ•…éšœæ¢å¤æµç¨‹
   - ä¿æŒå¤šä»½å¤‡ä»½å’Œå¼‚åœ°å®¹ç¾

### æŒç»­å­¦ä¹ æ–¹å‘

1. **æ·±å…¥æºç ç ”ç©¶**ï¼šç†è§£RDBå’ŒAOFçš„åº•å±‚å®ç°ç»†èŠ‚
2. **æ€§èƒ½è°ƒä¼˜å®è·µ**ï¼šåœ¨ä¸åŒåœºæ™¯ä¸‹ä¼˜åŒ–æŒä¹…åŒ–é…ç½®
3. **æ–°ç‰¹æ€§è·Ÿè¸ª**ï¼šå…³æ³¨Redisæ–°ç‰ˆæœ¬çš„æŒä¹…åŒ–æ”¹è¿›
4. **äº‘åŸç”Ÿé€‚é…**ï¼šæŒæ¡å®¹å™¨ç¯å¢ƒä¸‹çš„æŒä¹…åŒ–æœ€ä½³å®è·µ

---

**ä¸‹ä¸€ç¯‡é¢„å‘Š**ï¼šã€ŠRedisé›†ç¾¤æ¶æ„ä¸é«˜å¯ç”¨æ–¹æ¡ˆæ·±åº¦è§£æã€‹å°†è¯¦ç»†æ¢è®¨Redis Sentinelå“¨å…µæ¨¡å¼ã€Redis Clusteré›†ç¾¤æ–¹æ¡ˆå’Œåˆ†å¸ƒå¼æ¶æ„è®¾è®¡ã€‚ 