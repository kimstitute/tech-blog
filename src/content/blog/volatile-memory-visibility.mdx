---
title: "volatileå…³é”®å­—ä¸å†…å­˜å¯è§æ€§æ·±åº¦è§£æ"
description: "æ·±å…¥æ¢è®¨Java volatileå…³é”®å­—çš„å†…å­˜å¯è§æ€§ä¿è¯ã€happens-beforeå…³ç³»å’ŒæŒ‡ä»¤é‡æ’åºæœºåˆ¶ã€‚ç»“åˆJMMå†…å­˜æ¨¡å‹åˆ†ævolatileçš„å®ç°åŸç†ï¼Œæä¾›å®æˆ˜æ¡ˆä¾‹å’Œé¢è¯•è¦ç‚¹ï¼ŒæŒæ¡é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•ã€‚"
pubDate: 2024-12-06
updatedDate: 2024-12-06
tags: ["java", "volatile", "memory-model", "jmm", "happens-before", "visibility", "interview"]
categories: ["java-core"]
subject: "å¹¶å‘ç¼–ç¨‹"
draft: false
featured: true
author: "Gerrad Zhang"
location: "æ­¦æ±‰ï¼Œä¸­å›½"
---

## ğŸ¤” é—®é¢˜èƒŒæ™¯ä¸æŠ€æœ¯æ¼”è¿›

### æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨å¤šæ ¸CPUæ¶æ„ä¸‹ï¼Œæ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ç³»ç»Ÿï¼Œè¿™å¸¦æ¥äº†**å†…å­˜å¯è§æ€§é—®é¢˜**ï¼š

- **ç¼“å­˜ä¸ä¸€è‡´**ï¼šçº¿ç¨‹ä¿®æ”¹çš„å˜é‡å¯èƒ½åªå­˜åœ¨äºCPUç¼“å­˜ä¸­ï¼Œå…¶ä»–çº¿ç¨‹çœ‹ä¸åˆ°æœ€æ–°å€¼
- **æŒ‡ä»¤é‡æ’åº**ï¼šç¼–è¯‘å™¨å’ŒCPUä¸ºäº†ä¼˜åŒ–æ€§èƒ½ä¼šé‡æ–°æ’åˆ—æŒ‡ä»¤æ‰§è¡Œé¡ºåº
- **å†…å­˜å±éšœç¼ºå¤±**ï¼šæ²¡æœ‰åˆé€‚çš„åŒæ­¥æœºåˆ¶ç¡®ä¿å†…å­˜æ“ä½œçš„é¡ºåºæ€§

```java
// å…¸å‹çš„å†…å­˜å¯è§æ€§é—®é¢˜
public class VisibilityProblem {
    private boolean flag = false;
    private int count = 0;
    
    // çº¿ç¨‹1æ‰§è¡Œ
    public void writer() {
        count = 42;        // æ­¥éª¤1
        flag = true;       // æ­¥éª¤2
    }
    
    // çº¿ç¨‹2æ‰§è¡Œ
    public void reader() {
        if (flag) {        // å¯èƒ½çœ‹åˆ°flag=true
            // ä½†countå¯èƒ½è¿˜æ˜¯0ï¼ï¼ˆå¯è§æ€§é—®é¢˜ï¼‰
            System.out.println(count);
        }
    }
}
```

### æ²¡æœ‰è¿™ä¸ªæŠ€æœ¯æ—¶æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

åœ¨volatileå…³é”®å­—å‡ºç°ä¹‹å‰ï¼Œå¼€å‘è€…ä¸»è¦ä¾é ä»¥ä¸‹æ–¹å¼å¤„ç†å†…å­˜å¯è§æ€§ï¼š

**1. å®Œå…¨ä¾èµ–synchronized**
- æ‰€æœ‰å…±äº«å˜é‡è®¿é—®éƒ½åŠ é”
- **é—®é¢˜**ï¼šæ€§èƒ½å¼€é”€å¤§ï¼Œå³ä½¿æ˜¯ç®€å•çš„è¯»æ“ä½œä¹Ÿéœ€è¦åŒæ­¥

**2. æ‰‹å·¥å†…å­˜å±éšœ**
- ç›´æ¥ä½¿ç”¨CPUæä¾›çš„å†…å­˜å±éšœæŒ‡ä»¤
- **é—®é¢˜**ï¼šå¹³å°ç›¸å…³ã€ä½¿ç”¨å¤æ‚ã€å®¹æ˜“å‡ºé”™

**3. è½®è¯¢æ£€æŸ¥**
- é€šè¿‡ä¸æ–­è½®è¯¢æ£€æŸ¥å˜é‡çŠ¶æ€
- **é—®é¢˜**ï¼šCPUèµ„æºæµªè´¹ã€å“åº”å»¶è¿Ÿé«˜

**4. åŸå­æ“ä½œåº“**
- ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„åŸå­æ“ä½œ
- **é—®é¢˜**ï¼šAPIå¤æ‚ã€è·¨å¹³å°å›°éš¾

### æŠ€æœ¯æ¼”è¿›çš„å†å²è„‰ç»œ

**JDK 1.0-1.4 (1996-2002)**ï¼švolatileè¯­ä¹‰ä¸æ˜ç¡®
- volatileä»…ä¿è¯å¯è§æ€§ï¼Œä¸ä¿è¯æœ‰åºæ€§
- å­˜åœ¨æŒ‡ä»¤é‡æ’åºé—®é¢˜
- æ— æ³•æ„å»ºå¯é çš„å¹¶å‘ç¨‹åº

**JDK 1.5 (2004)**ï¼šJSR-133é‡æ–°å®šä¹‰volatileè¯­ä¹‰
- å¼•å…¥happens-beforeå…³ç³»
- ç¦æ­¢ç‰¹å®šçš„æŒ‡ä»¤é‡æ’åº
- æä¾›æ›´å¼ºçš„å†…å­˜è¯­ä¹‰ä¿è¯

**JDK 1.6åŠä»¥å**ï¼šæŒç»­ä¼˜åŒ–
- æ”¹è¿›volatileè¯»å†™çš„æ€§èƒ½
- ä¼˜åŒ–å†…å­˜å±éšœçš„å®ç°
- ä¸JUCåŒ…å½¢æˆå®Œæ•´çš„å¹¶å‘ç¼–ç¨‹ä½“ç³»

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µä¸åŸç†

### åŸºç¡€æ¦‚å¿µå®šä¹‰

**volatile**æ˜¯Javaæä¾›çš„è½»é‡çº§åŒæ­¥æœºåˆ¶ï¼Œä¸»è¦è§£å†³**å†…å­˜å¯è§æ€§**å’Œ**æœ‰åºæ€§**é—®é¢˜ï¼Œä½†ä¸èƒ½ä¿è¯**åŸå­æ€§**ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **å¯è§æ€§**ï¼šå¯¹volatileå˜é‡çš„å†™æ“ä½œå¯¹æ‰€æœ‰çº¿ç¨‹ç«‹å³å¯è§
- **æœ‰åºæ€§**ï¼šç¦æ­¢ç¼–è¯‘å™¨å’ŒCPUå¯¹volatileå˜é‡ç›¸å…³çš„æŒ‡ä»¤é‡æ’åº
- **è½»é‡çº§**ï¼šç›¸æ¯”synchronizedï¼Œæ€§èƒ½å¼€é”€æ›´å°

### Javaå†…å­˜æ¨¡å‹(JMM)åŸºç¡€

åœ¨æ·±å…¥ç†è§£volatileä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£Javaå†…å­˜æ¨¡å‹çš„åŸºç¡€æ¦‚å¿µã€‚

> ğŸ’¡ **æ·±åº¦å­¦ä¹ å»ºè®®**ï¼šå…³äºJMMçš„è¯¦ç»†åŸç†å’Œ8ç§å†…å­˜äº¤äº’æ“ä½œï¼Œè¯·å‚è€ƒï¼š[Javaå†…å­˜æ¨¡å‹(JMM)åº•å±‚åŸç†ä¸å†…å­˜äº¤äº’æ“ä½œè¯¦è§£](/blog/jmm-memory-model-deep-dive)

**JMMçš„æ ¸å¿ƒæ¶æ„**ï¼š

```java
/**
 * JMMå†…å­˜æ¨¡å‹åœ¨volatileä¸­çš„åº”ç”¨
 */
public class JMMVolatileDemo {
    // ä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡
    private volatile boolean ready = false;
    private int data = 0;  // æ™®é€šå˜é‡
    
    // çº¿ç¨‹1ï¼šç”Ÿäº§è€…
    public void producer() {
        data = 42;           // 1. æ™®é€šå†™ï¼šassign â†’ store â†’ writeï¼ˆå¯èƒ½å»¶è¿Ÿï¼‰
        ready = true;        // 2. volatileå†™ï¼šç«‹å³ assign â†’ store â†’ write
    }
    
    // çº¿ç¨‹2ï¼šæ¶ˆè´¹è€…
    public void consumer() {
        if (ready) {         // 3. volatileè¯»ï¼šç«‹å³ read â†’ load â†’ use
            // ç”±äºhappens-beforeå…³ç³»ï¼Œæ­¤æ—¶dataä¸€å®šæ˜¯42
            System.out.println("Data: " + data);
        }
    }
}
```

**volatileä¸å†…å­˜äº¤äº’æ“ä½œçš„å…³ç³»**ï¼š
- **æ™®é€šå˜é‡**ï¼šå†…å­˜æ“ä½œå¯èƒ½è¢«å»¶è¿Ÿæˆ–é‡æ’åº
- **volatileå˜é‡**ï¼šå†…å­˜æ“ä½œç«‹å³æ‰§è¡Œï¼Œä¸å…è®¸é‡æ’åº
- **å†…å­˜å±éšœ**ï¼švolatileæ“ä½œä¼šæ’å…¥ç‰¹å®šçš„å†…å­˜å±éšœæŒ‡ä»¤

### happens-beforeå…³ç³»

**happens-beforeè§„åˆ™**ç¡®ä¿äº†ç¨‹åºæ‰§è¡Œçš„æœ‰åºæ€§ï¼š

```java
/**
 * happens-beforeå…³ç³»æ¼”ç¤º
 */
public class HappensBeforeDemo {
    private volatile boolean initialized = false;
    private String message = "";
    
    // çº¿ç¨‹Aæ‰§è¡Œ
    public void init() {
        message = "Hello World";    // 1. æ™®é€šå†™
        initialized = true;         // 2. volatileå†™
        // happens-before: 1 happens-before 2
    }
    
    // çº¿ç¨‹Bæ‰§è¡Œ
    public void process() {
        if (initialized) {          // 3. volatileè¯»
            System.out.println(message); // 4. æ™®é€šè¯»
            // happens-before: 3 happens-before 4
            // ä¼ é€’æ€§: 1 happens-before 4
        }
    }
}
```

**8ä¸ªhappens-beforeè§„åˆ™**ï¼š
1. **ç¨‹åºæ¬¡åºè§„åˆ™**ï¼šå•çº¿ç¨‹å†…æŒ‰ç¨‹åºä»£ç é¡ºåº
2. **ç®¡ç¨‹é”å®šè§„åˆ™**ï¼šunlock happens-before lock
3. **volatileå˜é‡è§„åˆ™**ï¼švolatileå†™ happens-before volatileè¯»
4. **çº¿ç¨‹å¯åŠ¨è§„åˆ™**ï¼šThread.start() happens-before çº¿ç¨‹å†…æ“ä½œ
5. **çº¿ç¨‹ç»ˆæ­¢è§„åˆ™**ï¼šçº¿ç¨‹å†…æ“ä½œ happens-before Thread.join()
6. **çº¿ç¨‹ä¸­æ–­è§„åˆ™**ï¼šinterrupt() happens-before æ£€æµ‹ä¸­æ–­
7. **å¯¹è±¡ç»ˆç»“è§„åˆ™**ï¼šæ„é€ å‡½æ•° happens-before finalize()
8. **ä¼ é€’æ€§è§„åˆ™**ï¼šA happens-before B, B happens-before C âŸ¹ A happens-before C

## ğŸ”§ å®ç°åŸç†ä¸æºç åˆ†æ

### åº•å±‚å®ç°æœºåˆ¶

volatileåœ¨å­—èŠ‚ç å’ŒCPUå±‚é¢çš„å®ç°ï¼š

```java
public class VolatileImplementation {
    private volatile int value = 0;
    
    public void setValue(int newValue) {
        this.value = newValue;  // volatileå†™
    }
    
    public int getValue() {
        return this.value;      // volatileè¯»
    }
}
```

**å­—èŠ‚ç å±‚é¢**ï¼š
```
// volatileå†™
putfield volatile_field
// åœ¨x86æ¶æ„ä¸Šä¼šæ’å…¥lockå‰ç¼€æŒ‡ä»¤

// volatileè¯»  
getfield volatile_field
// ç¡®ä¿è¯»å–æœ€æ–°å€¼
```

### å†…å­˜å±éšœè¯¦è§£

**å››ç§å†…å­˜å±éšœç±»å‹**ï¼š

```java
/**
 * å†…å­˜å±éšœç¤ºä¾‹ï¼ˆæ¦‚å¿µæ€§ä»£ç ï¼‰
 */
public class MemoryBarrierDemo {
    private volatile boolean flag = false;
    private int data = 0;
    
    public void writer() {
        data = 42;              // æ™®é€šå†™
        // StoreStoreå±éšœ
        flag = true;            // volatileå†™
        // StoreLoadå±éšœ
    }
    
    public void reader() {
        // LoadLoadå±éšœ
        if (flag) {             // volatileè¯»
            // LoadStoreå±éšœ
            System.out.println(data); // æ™®é€šè¯»
        }
    }
}
```

**å†…å­˜å±éšœç±»å‹**ï¼š
1. **LoadLoadå±éšœ**ï¼šç¡®ä¿å±éšœå‰çš„è¯»æ“ä½œå…ˆäºå±éšœåçš„è¯»æ“ä½œ
2. **StoreStoreå±éšœ**ï¼šç¡®ä¿å±éšœå‰çš„å†™æ“ä½œå…ˆäºå±éšœåçš„å†™æ“ä½œ
3. **LoadStoreå±éšœ**ï¼šç¡®ä¿å±éšœå‰çš„è¯»æ“ä½œå…ˆäºå±éšœåçš„å†™æ“ä½œ
4. **StoreLoadå±éšœ**ï¼šç¡®ä¿å±éšœå‰çš„å†™æ“ä½œå…ˆäºå±éšœåçš„è¯»æ“ä½œ

### volatileçš„å†…å­˜è¯­ä¹‰

**volatileå†™çš„å†…å­˜è¯­ä¹‰**ï¼š
- å°†å·¥ä½œå†…å­˜ä¸­çš„å˜é‡å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜
- ç¦æ­¢volatileå†™ä¸ä¹‹å‰çš„è¯»å†™æ“ä½œé‡æ’åº

**volatileè¯»çš„å†…å­˜è¯­ä¹‰**ï¼š
- ä»ä¸»å†…å­˜ä¸­è¯»å–å˜é‡çš„æœ€æ–°å€¼åˆ°å·¥ä½œå†…å­˜
- ç¦æ­¢volatileè¯»ä¸ä¹‹åçš„è¯»å†™æ“ä½œé‡æ’åº

```java
/**
 * volatileå†…å­˜è¯­ä¹‰æ¼”ç¤º
 */
public class VolatileSemantics {
    private int a = 0;
    private int b = 0;
    private volatile int c = 0;
    
    public void writer() {
        a = 1;                  // 1
        b = 2;                  // 2
        c = 3;                  // 3. volatileå†™
        // 1,2ä¸èƒ½é‡æ’åºåˆ°3ä¹‹å
    }
    
    public void reader() {
        int temp = c;           // 4. volatileè¯»
        int x = a;              // 5
        int y = b;              // 6
        // 5,6ä¸èƒ½é‡æ’åºåˆ°4ä¹‹å‰
        // ç”±äºhappens-beforeä¼ é€’æ€§ï¼Œä¿è¯çœ‹åˆ°a=1, b=2
    }
}
```

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ä¸ä»£ç ç¤ºä¾‹

### å…·ä½“é¡¹ç›®åº”ç”¨

**åœºæ™¯1ï¼šå•ä¾‹æ¨¡å¼çš„åŒé‡æ£€æŸ¥é”å®š**

```java
/**
 * çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼å®ç°
 */
public class Singleton {
    // å¿…é¡»ä½¿ç”¨volatileç¡®ä¿å¯è§æ€§å’Œæœ‰åºæ€§
    private static volatile Singleton instance;
    
    private Singleton() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }
    
    public static Singleton getInstance() {
        if (instance == null) {                    // ç¬¬ä¸€æ¬¡æ£€æŸ¥
            synchronized (Singleton.class) {       // åŒæ­¥å—
                if (instance == null) {            // ç¬¬äºŒæ¬¡æ£€æŸ¥
                    instance = new Singleton();    // åˆ›å»ºå®ä¾‹
                }
            }
        }
        return instance;
    }
}

/**
 * ä¸ä½¿ç”¨volatileçš„é”™è¯¯ç¤ºä¾‹
 */
class BrokenSingleton {
    private static BrokenSingleton instance; // æ²¡æœ‰volatile
    
    public static BrokenSingleton getInstance() {
        if (instance == null) {
            synchronized (BrokenSingleton.class) {
                if (instance == null) {
                    // é—®é¢˜ï¼šè¿™ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ï¼ŒåŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š
                    // 1. åˆ†é…å†…å­˜ç©ºé—´
                    // 2. åˆå§‹åŒ–å¯¹è±¡
                    // 3. å°†instanceæŒ‡å‘å†…å­˜ç©ºé—´
                    // 
                    // ç”±äºæŒ‡ä»¤é‡æ’åºï¼Œå¯èƒ½å˜æˆ1->3->2çš„é¡ºåº
                    // å…¶ä»–çº¿ç¨‹å¯èƒ½çœ‹åˆ°æœªåˆå§‹åŒ–çš„å¯¹è±¡
                    instance = new BrokenSingleton();
                }
            }
        }
        return instance;
    }
}
```

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜ç²¾è®²

### æ ¸å¿ƒé¢è¯•é—®é¢˜è§£æ

#### 1. volatileçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä¸synchronizedæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
volatileä¸»è¦è§£å†³å†…å­˜å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š
- **å¯è§æ€§**ï¼šå¯¹volatileå˜é‡çš„ä¿®æ”¹å¯¹æ‰€æœ‰çº¿ç¨‹ç«‹å³å¯è§
- **æœ‰åºæ€§**ï¼šç¦æ­¢æŒ‡ä»¤é‡æ’åº
- **è½»é‡çº§**ï¼šä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œæ€§èƒ½å¼€é”€å°äºsynchronized

**ä¸synchronizedçš„åŒºåˆ«**ï¼š
| ç‰¹æ€§ | volatile | synchronized |
|------|----------|-------------|
| åŸå­æ€§ | âŒ ä¸ä¿è¯ | âœ… ä¿è¯ |
| å¯è§æ€§ | âœ… ä¿è¯ | âœ… ä¿è¯ |
| æœ‰åºæ€§ | âœ… éƒ¨åˆ†ä¿è¯ | âœ… å®Œå…¨ä¿è¯ |
| é˜»å¡æ€§ | ä¸é˜»å¡ | å¯èƒ½é˜»å¡ |
| é€‚ç”¨åœºæ™¯ | çŠ¶æ€æ ‡å¿—ã€å•æ¬¡å‘å¸ƒ | å¤åˆæ“ä½œã€ä¸´ç•ŒåŒº |

#### 2. ä¸ºä»€ä¹ˆåŒé‡æ£€æŸ¥é”å®šå¿…é¡»ä½¿ç”¨volatileï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
å› ä¸ºå¯¹è±¡åˆ›å»ºä¸æ˜¯åŸå­æ“ä½œï¼ŒåŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š
1. åˆ†é…å†…å­˜ç©ºé—´
2. åˆå§‹åŒ–å¯¹è±¡
3. å°†å¼•ç”¨æŒ‡å‘å†…å­˜ç©ºé—´

**volatileçš„ä½œç”¨**ï¼š
- ç¦æ­¢æ­¥éª¤2å’Œ3çš„é‡æ’åº
- ç¡®ä¿å¯¹è±¡å®Œå…¨åˆå§‹åŒ–åæ‰å¯¹å…¶ä»–çº¿ç¨‹å¯è§

#### 3. volatileèƒ½å¦ä¿è¯åŸå­æ€§ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
volatile**ä¸èƒ½**ä¿è¯åŸå­æ€§ï¼Œåªèƒ½ä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§ã€‚

**åŸå› åˆ†æ**ï¼š
```java
private volatile int count = 0;

public void increment() {
    count++; // è¿™æ˜¯ä¸‰ä¸ªæ“ä½œï¼šè¯»å–ã€è®¡ç®—ã€å†™å›
}
// å¤šçº¿ç¨‹å¯èƒ½åŒæ—¶è¯»å–åˆ°ç›¸åŒå€¼ï¼Œå¯¼è‡´æ›´æ–°ä¸¢å¤±
```

**æ­£ç¡®åšæ³•**ï¼š
```java
private final AtomicInteger count = new AtomicInteger(0);
public void increment() {
    count.incrementAndGet(); // åŸå­æ“ä½œ
}
```

#### 4. ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨volatileï¼Ÿ

**é€‚ç”¨åœºæ™¯**ï¼š
- **çŠ¶æ€æ ‡å¿—**ï¼š`volatile boolean shutdown = false;`
- **å•æ¬¡å‘å¸ƒ**ï¼š`volatile Configuration config;`
- **ç‹¬ç«‹è§‚å¯Ÿ**ï¼š`volatile long lastUpdateTime;`

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- å¤åˆæ“ä½œï¼ˆå¦‚è®¡æ•°å™¨ï¼‰
- ä¾èµ–å½“å‰å€¼çš„æ“ä½œ
- éœ€è¦åŸå­æ€§ä¿è¯çš„åœºæ™¯

## âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### å¸¸è§å‘ç‚¹è§„é¿

**1. volatileæ•°ç»„çš„é™·é˜±**
```java
// âŒ åªæœ‰æ•°ç»„å¼•ç”¨æ˜¯volatileçš„ï¼Œæ•°ç»„å…ƒç´ ä¸æ˜¯
private volatile int[] array = new int[10];

public void updateElement(int index, int value) {
    array[index] = value; // è¿™ä¸ªå†™æ“ä½œä¸æ˜¯volatileçš„ï¼
}

// âœ… æ­£ç¡®çš„åšæ³•
private final AtomicIntegerArray atomicArray = new AtomicIntegerArray(10);

public void atomicUpdateElement(int index, int value) {
    atomicArray.set(index, value); // åŸå­æ“ä½œ
}
```

**2. volatileä¸finalçš„é…åˆ**
```java
/**
 * volatileä¸finalçš„æœ€ä½³å®è·µ
 */
public class VolatileFinalBestPractice {
    // âœ… ä¸å¯å˜å¯¹è±¡ + volatileå¼•ç”¨
    private volatile ImmutableConfig config;
    
    public void updateConfig(Map<String, String> newSettings) {
        config = new ImmutableConfig(newSettings);
    }
    
    public String getSetting(String key) {
        return config.getValue(key); // å®‰å…¨çš„è¯»å–
    }
    
    private static class ImmutableConfig {
        private final Map<String, String> settings;
        
        public ImmutableConfig(Map<String, String> settings) {
            this.settings = Collections.unmodifiableMap(new HashMap<>(settings));
        }
        
        public String getValue(String key) {
            return settings.get(key);
        }
    }
}
```

## ğŸ“š æ€»ç»“ä¸æŠ€æœ¯å¯¹æ¯”

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

1. **volatileè§£å†³å†…å­˜å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜**ï¼Œä½†ä¸ä¿è¯åŸå­æ€§
2. **åŸºäºJMMå’Œhappens-beforeå…³ç³»**æä¾›å†…å­˜è¯­ä¹‰ä¿è¯
3. **é€šè¿‡å†…å­˜å±éšœ**ç¦æ­¢ç‰¹å®šçš„æŒ‡ä»¤é‡æ’åº
4. **è½»é‡çº§åŒæ­¥æœºåˆ¶**ï¼Œæ€§èƒ½å¼€é”€å°äºsynchronized
5. **é€‚ç”¨äºçŠ¶æ€æ ‡å¿—ã€å•æ¬¡å‘å¸ƒç­‰ç‰¹å®šåœºæ™¯**

### ä¸ç›¸å…³æŠ€æœ¯å¯¹æ¯”

| åŒæ­¥æœºåˆ¶ | åŸå­æ€§ | å¯è§æ€§ | æœ‰åºæ€§ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|-------|-------|-------|------|----------|
| volatile | âŒ | âœ… | éƒ¨åˆ† | é«˜ | çŠ¶æ€æ ‡å¿—ã€å‘å¸ƒå¯¹è±¡ |
| synchronized | âœ… | âœ… | âœ… | ä¸­ | ä¸´ç•ŒåŒºä¿æŠ¤ |
| AtomicXXX | âœ… | âœ… | âœ… | é«˜ | æ— é”æ•°æ®ç»“æ„ |
| Lockæ¥å£ | âœ… | âœ… | âœ… | ä¸­-é«˜ | å¤æ‚åŒæ­¥åœºæ™¯ |

### é€‰æ‹©æŒ‡å—

**ä½¿ç”¨volatileçš„æ¡ä»¶**ï¼š
1. å†™å…¥æ“ä½œä¸ä¾èµ–å½“å‰å€¼
2. å˜é‡ä¸éœ€è¦ä¸å…¶ä»–å˜é‡å‚ä¸ä¸å˜çº¦æŸ
3. è®¿é—®å˜é‡æ—¶ä¸éœ€è¦åŠ é”

**å…¸å‹åº”ç”¨æ¨¡å¼**ï¼š
- **çŠ¶æ€æ ‡å¿—**ï¼š`volatile boolean flag`
- **å•æ¬¡å‘å¸ƒ**ï¼š`volatile Object instance`
- **è§‚å¯Ÿè€…æ¨¡å¼**ï¼š`volatile long timestamp`

### æŒç»­å­¦ä¹ å»ºè®®

1. **æ·±å…¥ç†è§£JMM**ï¼šå­¦ä¹ Javaå†…å­˜æ¨¡å‹çš„å®Œæ•´è§„èŒƒ
2. **ç ”ç©¶CPUæ¶æ„**ï¼šäº†è§£ä¸åŒæ¶æ„ä¸‹çš„å†…å­˜æ¨¡å‹å·®å¼‚
3. **å®è·µå¹¶å‘ç¼–ç¨‹**ï¼šåœ¨é¡¹ç›®ä¸­ç§¯ç´¯volatileä½¿ç”¨ç»éªŒ
4. **å…³æ³¨æ€§èƒ½ä¼˜åŒ–**ï¼šå­¦ä¹ ç¼“å­˜è¡Œã€ä¼ªå…±äº«ç­‰é«˜çº§è¯é¢˜
5. **è·Ÿè¸ªæŠ€æœ¯å‘å±•**ï¼šå…³æ³¨Project Loomç­‰å¹¶å‘ç¼–ç¨‹æ–°ç‰¹æ€§

---

**ä¸‹ä¸€ç¯‡é¢„å‘Š**ï¼šã€ŠThreadLocalåŸç†ä¸å†…å­˜æ³„æ¼é˜²èŒƒã€‹å°†æ·±å…¥æ¢è®¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„å®ç°æœºåˆ¶ã€åº”ç”¨åœºæ™¯å’Œå†…å­˜ç®¡ç†æœ€ä½³å®è·µã€‚
```