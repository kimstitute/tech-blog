---
title: "synchronizedå…³é”®å­—æ·±åº¦å‰–æä¸å®æˆ˜"
description: "æ·±å…¥æ¢è®¨Java synchronizedå…³é”®å­—çš„æ ¸å¿ƒåŸç†ã€Monitoræœºåˆ¶å’Œé”ä¼˜åŒ–ç­–ç•¥ï¼Œç»“åˆå®é™…é¡¹ç›®ç»éªŒåˆ†äº«é¢è¯•è¦ç‚¹å’Œæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆã€‚æ¶µç›–åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”çš„å®Œæ•´å‡çº§è¿‡ç¨‹ã€‚"
pubDate: 2024-12-06
updatedDate: 2024-12-06
tags: ["java", "synchronized", "concurrent", "multithreading", "interview", "best-practices"]
categories: ["java-core"]
subject: "å¹¶å‘ç¼–ç¨‹"
draft: false
featured: true
author: "Gerrad Zhang"
location: "æ­¦æ±‰ï¼Œä¸­å›½"
---

## ğŸ¤” é—®é¢˜èƒŒæ™¯ä¸æŠ€æœ¯æ¼”è¿›

### æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œ**çº¿ç¨‹å®‰å…¨é—®é¢˜**æ˜¯æ ¸å¿ƒæŒ‘æˆ˜ã€‚å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

- **ç«æ€æ¡ä»¶**ï¼šç¨‹åºçš„æœ€ç»ˆç»“æœä¾èµ–äºçº¿ç¨‹æ‰§è¡Œçš„æ—¶åºï¼Œå¯¼è‡´ç»“æœä¸å¯é¢„æµ‹
- **æ•°æ®ä¸ä¸€è‡´**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«å˜é‡ï¼Œé€ æˆæ•°æ®çŠ¶æ€æ··ä¹±
- **åŸå­æ€§é—®é¢˜**ï¼šå¤åˆæ“ä½œæ— æ³•ä¿è¯ä¸€æ¬¡æ€§å®Œæˆï¼Œä¸­é—´çŠ¶æ€å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹è§‚å¯Ÿåˆ°

```java
// å…¸å‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ç¤ºä¾‹
public class CounterProblem {
    private int count = 0;
    
    // éçº¿ç¨‹å®‰å…¨çš„é€’å¢æ“ä½œ
    public void increment() {
        count++;  // è¿™å®é™…ä¸Šæ˜¯ä¸‰ä¸ªæ­¥éª¤ï¼šè¯»å–ã€è®¡ç®—ã€å†™å…¥
    }
}
```

### æ²¡æœ‰è¿™ä¸ªæŠ€æœ¯æ—¶æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

åœ¨synchronizedå…³é”®å­—å‡ºç°ä¹‹å‰ï¼ŒJavaå¼€å‘è€…ä¸»è¦ä¾é ä»¥ä¸‹æ–¹å¼å¤„ç†å¹¶å‘é—®é¢˜ï¼š

**1. å•çº¿ç¨‹ç¼–ç¨‹**
- å®Œå…¨é¿å…å¤šçº¿ç¨‹ï¼Œç¨‹åºæŒ‰é¡ºåºæ‰§è¡Œ
- **é—®é¢˜**ï¼šæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸CPUæ€§èƒ½ï¼Œå“åº”æ€§å·®

**2. æ‰‹å·¥åŒæ­¥æœºåˆ¶**
- ä½¿ç”¨å¤æ‚çš„æ ‡å¿—ä½å’Œè½®è¯¢æœºåˆ¶
- é€šè¿‡volatileå˜é‡å’Œwhileå¾ªç¯å®ç°äº’æ–¥
- **é—®é¢˜**ï¼šä»£ç å¤æ‚ã€å®¹æ˜“å‡ºé”™ã€æ€§èƒ½ä½ä¸‹

**3. æ“ä½œç³»ç»Ÿçº§åˆ«çš„äº’æ–¥é‡**
- ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿæä¾›çš„äº’æ–¥åŸè¯­
- **é—®é¢˜**ï¼šå¹³å°ç›¸å…³ã€ä½¿ç”¨å¤æ‚ã€éš¾ä»¥è°ƒè¯•

### æŠ€æœ¯æ¼”è¿›çš„å†å²è„‰ç»œ

**JDK 1.0 (1996)**ï¼šsynchronizedå…³é”®å­—é¦–æ¬¡å¼•å…¥
- åŸºäºMonitoræ¦‚å¿µå®ç°
- æä¾›ç®€å•æ˜“ç”¨çš„åŒæ­¥æœºåˆ¶
- æ€§èƒ½è¾ƒå·®ï¼Œæ‰€æœ‰åŒæ­¥éƒ½æ˜¯é‡é‡çº§æ“ä½œ

**JDK 1.6 (2006)**ï¼šé”ä¼˜åŒ–çš„é‡å¤§çªç ´
- å¼•å…¥åå‘é”(Biased Locking)
- å®ç°è½»é‡çº§é”(Lightweight Locking)
- é”æ¶ˆé™¤å’Œé”ç²—åŒ–ä¼˜åŒ–

**JDK 1.8åŠä»¥å**ï¼šæŒç»­ä¼˜åŒ–
- æ”¹å–„é”ç«äº‰æ£€æµ‹ç®—æ³•
- ä¼˜åŒ–Monitorå®ç°
- ä¸å…¶ä»–å¹¶å‘å·¥å…·å½¢æˆå®Œæ•´ä½“ç³»

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µä¸åŸç†

### åŸºç¡€æ¦‚å¿µå®šä¹‰

**Synchronized**æ˜¯Javaæä¾›çš„å†…ç½®åŒæ­¥æœºåˆ¶ï¼Œç”¨äºç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œè¢«ä¿æŠ¤çš„ä»£ç æ®µã€‚å®ƒåŸºäº**å¯¹è±¡ç›‘è§†å™¨(Object Monitor)**çš„æ¦‚å¿µå®ç°ã€‚

**æ ¸å¿ƒæœ¯è¯­**ï¼š
- **Monitor**ï¼šæ¯ä¸ªJavaå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„ç›‘è§†å™¨
- **ä¸´ç•ŒåŒº**ï¼šè¢«synchronizedä¿æŠ¤çš„ä»£ç åŒºåŸŸ
- **é”å¯¹è±¡**ï¼šæä¾›ç›‘è§†å™¨çš„å¯¹è±¡å®ä¾‹

### å·¥ä½œåŸç†è¯¦è§£

synchronizedçš„æ ¸å¿ƒå·¥ä½œæœºåˆ¶åŸºäº**Monitoræ¨¡å¼**ï¼š

```java
// åŒæ­¥æ–¹æ³•
public synchronized void syncMethod() {
    // ä¸´ç•ŒåŒºä»£ç 
}

// åŒæ­¥ä»£ç å—
public void syncBlock() {
    synchronized(this) {  // è·å–thiså¯¹è±¡çš„ç›‘è§†å™¨
        // ä¸´ç•ŒåŒºä»£ç 
    }  // è‡ªåŠ¨é‡Šæ”¾ç›‘è§†å™¨
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. **è¿›å…¥ç›‘è§†å™¨**ï¼šçº¿ç¨‹å°è¯•è·å–å¯¹è±¡çš„ç›‘è§†å™¨é”
2. **æ‰§è¡Œä¸´ç•ŒåŒº**ï¼šæˆåŠŸè·å–é”çš„çº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç 
3. **é‡Šæ”¾ç›‘è§†å™¨**ï¼šä»£ç æ‰§è¡Œå®Œæ¯•æˆ–å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾é”
4. **å”¤é†’ç­‰å¾…çº¿ç¨‹**ï¼šå…¶ä»–ç­‰å¾…çš„çº¿ç¨‹è¢«å”¤é†’é‡æ–°ç«äº‰

### æŠ€æœ¯ç‰¹ç‚¹å’Œä¼˜åŠ¿

**synchronizedçš„æ ¸å¿ƒç‰¹æ€§**ï¼š
- **äº’æ–¥æ€§**ï¼šç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®
- **å¯è§æ€§**ï¼šä¿è¯çº¿ç¨‹é—´çš„å†…å­˜å¯è§æ€§
- **å¯é‡å…¥æ€§**ï¼šåŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”
- **è‡ªåŠ¨é‡Šæ”¾**ï¼šå¼‚å¸¸æˆ–æ­£å¸¸é€€å‡ºéƒ½ä¼šè‡ªåŠ¨é‡Šæ”¾é”

**ç›¸æ¯”æ‰‹å·¥åŒæ­¥çš„ä¼˜åŠ¿**ï¼š
- è¯­æ³•ç®€æ´ï¼Œæ˜“äºä½¿ç”¨å’Œç†è§£
- è‡ªåŠ¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾
- JVMå±‚é¢ä¼˜åŒ–ï¼Œæ€§èƒ½ä¸æ–­æ”¹å–„
- ä¸Javaå¼‚å¸¸å¤„ç†æœºåˆ¶è‰¯å¥½é›†æˆ

## ğŸ”§ å®ç°åŸç†ä¸æºç åˆ†æ

### åº•å±‚å®ç°æœºåˆ¶

synchronizedåœ¨å­—èŠ‚ç å±‚é¢é€šè¿‡**monitorenter**å’Œ**monitorexit**æŒ‡ä»¤å®ç°ï¼š

```java
public void syncMethod() {
    synchronized(lock) {
        count++;
    }
}
```

å¯¹åº”çš„å­—èŠ‚ç ï¼š
```
monitorenter    // è·å–ç›‘è§†å™¨é”
aload_0         // åŠ è½½thiså¼•ç”¨
getfield        // è·å–countå­—æ®µ
aload_0         // åŠ è½½thiså¼•ç”¨  
dup             // å¤åˆ¶å¼•ç”¨
getfield        // è·å–countå­—æ®µ
iconst_1        // å¸¸é‡1
iadd            // æ‰§è¡ŒåŠ æ³•
putfield        // å­˜å‚¨ç»“æœ
monitorexit     // é‡Šæ”¾ç›‘è§†å™¨é”
```

### é”å‡çº§æœºåˆ¶è¯¦è§£

**é”å‡çº§çš„æ¸è¿›ç­–ç•¥**ï¼š
synchronizedé‡‡ç”¨**æ¸è¿›å¼é”å‡çº§**çš„è®¾è®¡æ€æƒ³ï¼Œæ ¹æ®ç«äº‰ç¨‹åº¦åŠ¨æ€è°ƒæ•´ï¼š

```java
/**
 * é”å‡çº§æ¼”ç¤º
 */
public class LockUpgradeDemo {
    private int count = 0;
    
    public synchronized void increment() {
        count++;
    }
    
    public static void main(String[] args) throws InterruptedException {
        LockUpgradeDemo demo = new LockUpgradeDemo();
        
        // é˜¶æ®µ1ï¼šåå‘é”ï¼ˆå•çº¿ç¨‹è®¿é—®ï¼‰
        System.out.println("=== åå‘é”é˜¶æ®µ ===");
        for (int i = 0; i < 1000; i++) {
            demo.increment();
        }
        
        // é˜¶æ®µ2ï¼šè½»é‡çº§é”ï¼ˆå°‘é‡çº¿ç¨‹äº¤æ›¿ï¼‰
        System.out.println("=== è½»é‡çº§é”é˜¶æ®µ ===");
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                demo.increment();
            }
        });
        
        t1.start();
        t1.join();
        
        System.out.println("æœ€ç»ˆç»“æœ: " + demo.count);
    }
}
```

**ä¸‰ç§é”çŠ¶æ€è¯¦è§£**ï¼š

1. **åå‘é”**ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç 
   - åœ¨å¯¹è±¡å¤´è®°å½•çº¿ç¨‹ID
   - åç»­è®¿é—®ç›´æ¥æ£€æŸ¥çº¿ç¨‹IDï¼Œæ— éœ€CASæ“ä½œ
   - é€‚åˆå•çº¿ç¨‹é‡å¤è¿›å…¥çš„åœºæ™¯

2. **è½»é‡çº§é”**ï¼šå¤šä¸ªçº¿ç¨‹äº¤æ›¿è®¿é—®ï¼Œæ— æ¿€çƒˆç«äº‰
   - ä½¿ç”¨CASæ“ä½œè·å–é”
   - åœ¨æ ˆå¸§ä¸­å­˜å‚¨é”è®°å½•
   - é€‚åˆçº¿ç¨‹äº¤æ›¿æ‰§è¡Œçš„åœºæ™¯

3. **é‡é‡çº§é”**ï¼šå¤šä¸ªçº¿ç¨‹æ¿€çƒˆç«äº‰
   - åŸºäºæ“ä½œç³»ç»Ÿäº’æ–¥é‡å®ç°
   - çº¿ç¨‹ä¼šè¢«é˜»å¡å’Œå”¤é†’
   - é€‚åˆé«˜ç«äº‰çš„å¹¶å‘åœºæ™¯

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ä¸ä»£ç ç¤ºä¾‹

### å…·ä½“é¡¹ç›®åº”ç”¨

**åœºæ™¯ï¼šç”µå•†ç³»ç»Ÿåº“å­˜æ‰£å‡**

åœ¨ç”µå•†ç³»ç»Ÿä¸­ï¼Œåº“å­˜æ‰£å‡æ˜¯å…¸å‹çš„å¹¶å‘åœºæ™¯ã€‚å¤šä¸ªç”¨æˆ·åŒæ—¶è´­ä¹°å•†å“æ—¶ï¼Œå¿…é¡»ç¡®ä¿åº“å­˜æ•°æ®çš„ä¸€è‡´æ€§ã€‚

```java
/**
 * ç”µå•†åº“å­˜ç®¡ç†ç³»ç»Ÿ
 */
@Service
public class InventoryService {
    
    // å•†å“åº“å­˜æ˜ å°„
    private final Map<Long, Integer> inventory = new ConcurrentHashMap<>();
    
    // ä¸ºæ¯ä¸ªå•†å“åˆ›å»ºç‹¬ç«‹çš„é”å¯¹è±¡ï¼Œå‡å°‘é”ç²’åº¦
    private final Map<Long, Object> productLocks = new ConcurrentHashMap<>();
    
    /**
     * æ‰£å‡åº“å­˜ï¼ˆçº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ï¼‰
     */
    public boolean decreaseStock(Long productId, int quantity) {
        // è·å–å•†å“ä¸“ç”¨é”
        Object lock = productLocks.computeIfAbsent(productId, k -> new Object());
        
        synchronized (lock) {
            Integer currentStock = inventory.get(productId);
            
            // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
            if (currentStock == null || currentStock < quantity) {
                return false;  // åº“å­˜ä¸è¶³
            }
            
            // æ‰£å‡åº“å­˜
            inventory.put(productId, currentStock - quantity);
            
            // è®°å½•åº“å­˜å˜åŒ–æ—¥å¿—ï¼ˆç®€åŒ–ï¼‰
            logStockChange(productId, -quantity, currentStock - quantity);
            
            return true;
        }
    }
    
    /**
     * æ¢å¤åº“å­˜ï¼ˆé€€è´§åœºæ™¯ï¼‰
     */
    public void increaseStock(Long productId, int quantity) {
        Object lock = productLocks.computeIfAbsent(productId, k -> new Object());
        
        synchronized (lock) {
            Integer currentStock = inventory.getOrDefault(productId, 0);
            inventory.put(productId, currentStock + quantity);
            logStockChange(productId, quantity, currentStock + quantity);
        }
    }
    
    /**
     * æŸ¥è¯¢åº“å­˜ï¼ˆåªè¯»æ“ä½œï¼Œæ— éœ€åŒæ­¥ï¼‰
     */
    public Integer getStock(Long productId) {
        return inventory.get(productId);
    }
    
    private void logStockChange(Long productId, int change, int newStock) {
        System.out.printf("å•†å“%dåº“å­˜å˜åŒ–: %+d, å½“å‰åº“å­˜: %d%n", 
                         productId, change, newStock);
    }
}
```

### å®Œæ•´ä»£ç å®ç°

**ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼å®ç°**ï¼š

```java
/**
 * åŸºäºsynchronizedçš„ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°
 */
public class ProducerConsumerDemo {
    
    private final Object lock = new Object();
    private final Queue<String> buffer = new LinkedList<>();
    private final int capacity = 10;
    
    /**
     * ç”Ÿäº§è€…
     */
    class Producer implements Runnable {
        @Override
        public void run() {
            for (int i = 0; i < 20; i++) {
                try {
                    produce("Item-" + i);
                    Thread.sleep(100);  // æ¨¡æ‹Ÿç”Ÿäº§æ—¶é—´
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        private void produce(String item) throws InterruptedException {
            synchronized (lock) {
                // ç­‰å¾…ç¼“å†²åŒºæœ‰ç©ºé—´
                while (buffer.size() >= capacity) {
                    System.out.println("ç¼“å†²åŒºå·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾…...");
                    lock.wait();
                }
                
                // ç”Ÿäº§å•†å“
                buffer.offer(item);
                System.out.println("ç”Ÿäº§: " + item + ", ç¼“å†²åŒºå¤§å°: " + buffer.size());
                
                // é€šçŸ¥æ¶ˆè´¹è€…
                lock.notifyAll();
            }
        }
    }
    
    /**
     * æ¶ˆè´¹è€…
     */
    class Consumer implements Runnable {
        private final String name;
        
        public Consumer(String name) {
            this.name = name;
        }
        
        @Override
        public void run() {
            try {
                while (true) {
                    String item = consume();
                    if (item == null) break;  // æ²¡æœ‰æ›´å¤šå•†å“
                    
                    // æ¨¡æ‹Ÿæ¶ˆè´¹æ—¶é—´
                    Thread.sleep(150);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
        
        private String consume() throws InterruptedException {
            synchronized (lock) {
                // ç­‰å¾…ç¼“å†²åŒºæœ‰å•†å“
                while (buffer.isEmpty()) {
                    System.out.println(name + " ç­‰å¾…å•†å“...");
                    lock.wait(1000);  // è¶…æ—¶ç­‰å¾…
                    if (buffer.isEmpty()) {
                        return null;  // è¶…æ—¶é€€å‡º
                    }
                }
                
                // æ¶ˆè´¹å•†å“
                String item = buffer.poll();
                System.out.println(name + " æ¶ˆè´¹: " + item + ", ç¼“å†²åŒºå¤§å°: " + buffer.size());
                
                // é€šçŸ¥ç”Ÿäº§è€…
                lock.notifyAll();
                
                return item;
            }
        }
    }
}
```

### æœ€ä½³å®è·µæ€»ç»“

**1. é”ç²’åº¦æ§åˆ¶**
```java
// âŒ é”™è¯¯ï¼šé”ç²’åº¦è¿‡ç²—
public synchronized void processAllUsers() {
    for (User user : users) {
        updateUser(user);  // æ•´ä¸ªå¾ªç¯éƒ½è¢«é”ä½
    }
}

// âœ… æ­£ç¡®ï¼šé”ç²’åº¦ç»†åŒ–
public void processAllUsers() {
    for (User user : users) {
        synchronized(user) {  // åªé”å®šå•ä¸ªç”¨æˆ·
            updateUser(user);
        }
    }
}
```

**2. é¿å…é”åµŒå¥—**

```java
// âŒ é”™è¯¯ï¼šå¯èƒ½å¯¼è‡´æ­»é”
public synchronized void methodA() {
    synchronized(lockB) {
        // ä¸šåŠ¡é€»è¾‘
    }
}

// âœ… æ­£ç¡®ï¼šç»Ÿä¸€åŠ é”é¡ºåº
public void methodA() {
    synchronized(lockA) {
        synchronized(lockB) {
            // ä¸šåŠ¡é€»è¾‘
        }
    }
}
```

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜ç²¾è®²

### æ ¸å¿ƒé¢è¯•é—®é¢˜è§£æ

#### 1. synchronizedçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
synchronizedåŸºäºJVMçš„Monitoræœºåˆ¶å®ç°ã€‚åœ¨å­—èŠ‚ç å±‚é¢ï¼ŒåŒæ­¥ä»£ç å—ä½¿ç”¨monitorenterå’ŒmonitorexitæŒ‡ä»¤ï¼ŒåŒæ­¥æ–¹æ³•é€šè¿‡æ–¹æ³•è®¿é—®æ ‡å¿—ACC_SYNCHRONIZEDå®ç°ã€‚

**æ‰©å±•è¦ç‚¹**ï¼š
- æ¯ä¸ªJavaå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„Monitor
- MonitoråŒ…å«ownerã€countã€waitersç­‰å…³é”®å­—æ®µ
- é€šè¿‡CASæ“ä½œå’Œæ“ä½œç³»ç»Ÿäº’æ–¥é‡ä¿è¯åŸå­æ€§

**é¢è¯•æŠ€å·§**ï¼šç»“åˆå…·ä½“çš„å­—èŠ‚ç ç¤ºä¾‹è¯´æ˜ï¼Œå±•ç°å¯¹åº•å±‚æœºåˆ¶çš„æ·±å…¥ç†è§£ã€‚

#### 2. synchronizedçš„é”å‡çº§è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
JDK 1.6å¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼šåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”

- **åå‘é”**ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œåœ¨å¯¹è±¡å¤´è®°å½•çº¿ç¨‹ID
- **è½»é‡çº§é”**ï¼šå¤šä¸ªçº¿ç¨‹äº¤æ›¿è®¿é—®ï¼Œä½¿ç”¨CASæ“ä½œ
- **é‡é‡çº§é”**ï¼šå¤šä¸ªçº¿ç¨‹æ¿€çƒˆç«äº‰ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡

**æ‰©å±•è¦ç‚¹**ï¼š
- é”å‡çº§æ˜¯ä¸å¯é€†çš„ï¼ˆé™¤äº†GCæ—¶é‡ç½®ï¼‰
- å‡çº§æ¡ä»¶ï¼šç«äº‰ç¨‹åº¦è¾¾åˆ°é˜ˆå€¼
- æ¯ç§é”éƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯

#### 3. synchronizedå’Œvolatileçš„åŒºåˆ«ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
| ç‰¹æ€§ | synchronized | volatile |
|------|-------------|----------|
| åŸå­æ€§ | âœ… ä¿è¯ | âŒ ä¸ä¿è¯ |
| å¯è§æ€§ | âœ… ä¿è¯ | âœ… ä¿è¯ |
| æœ‰åºæ€§ | âœ… ä¿è¯ | âœ… ä¿è¯ |
| é˜»å¡æ€§ | ä¼šé˜»å¡ | ä¸ä¼šé˜»å¡ |
| é€‚ç”¨åœºæ™¯ | å¤åˆæ“ä½œ | çŠ¶æ€æ ‡å¿— |

#### 4. synchronizedå’ŒReentrantLockçš„åŒºåˆ«ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **è·å–æ–¹å¼**ï¼šsynchronizedè‡ªåŠ¨è·å–ï¼ŒReentrantLockæ‰‹åŠ¨è·å–
- **é‡Šæ”¾æ–¹å¼**ï¼šsynchronizedè‡ªåŠ¨é‡Šæ”¾ï¼ŒReentrantLockéœ€è¦æ‰‹åŠ¨é‡Šæ”¾
- **ä¸­æ–­æ€§**ï¼šsynchronizedä¸å¯ä¸­æ–­ï¼ŒReentrantLockå¯ä¸­æ–­
- **å…¬å¹³æ€§**ï¼šsynchronizedéå…¬å¹³ï¼ŒReentrantLockå¯é€‰æ‹©
- **æ€§èƒ½**ï¼šé«˜å¹¶å‘ä¸‹ReentrantLockæ€§èƒ½æ›´å¥½

#### 5. ä»€ä¹ˆæ˜¯é”æ¶ˆé™¤å’Œé”ç²—åŒ–ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼š
- **é”æ¶ˆé™¤**ï¼šJITç¼–è¯‘å™¨æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨ç«äº‰çš„åŒæ­¥ä»£ç ï¼Œè‡ªåŠ¨æ¶ˆé™¤é”
- **é”ç²—åŒ–**ï¼šå°†å¤šä¸ªè¿ç»­çš„åŒæ­¥æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§èŒƒå›´çš„åŒæ­¥

```java
// é”æ¶ˆé™¤ç¤ºä¾‹
public void method() {
    StringBuffer sb = new StringBuffer();  // å±€éƒ¨å˜é‡ï¼Œæ— ç«äº‰
    sb.append("a");  // é”ä¼šè¢«æ¶ˆé™¤
    sb.append("b");  // é”ä¼šè¢«æ¶ˆé™¤
}

// é”ç²—åŒ–ç¤ºä¾‹
for (int i = 0; i < 1000; i++) {
    synchronized(lock) {  // ä¼šè¢«ç²—åŒ–ä¸ºä¸€ä¸ªå¤§é”
        // æ“ä½œ
    }
}
```

### æŠ€æœ¯å¯¹æ¯”ç±»é—®é¢˜

**synchronized vs. å…¶ä»–åŒæ­¥æœºåˆ¶é€‰æ‹©**ï¼š
- **ç®€å•äº’æ–¥**ï¼šä¼˜å…ˆä½¿ç”¨synchronized
- **éœ€è¦è¶…æ—¶**ï¼šä½¿ç”¨ReentrantLock
- **è¯»å¤šå†™å°‘**ï¼šä½¿ç”¨ReadWriteLock
- **æ— é”ç¼–ç¨‹**ï¼šä½¿ç”¨Atomicç±»
- **å¼‚æ­¥ç¼–ç¨‹**ï¼šä½¿ç”¨CompletableFuture

## âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### æ€§èƒ½ç“¶é¢ˆåˆ†æ

**synchronizedçš„æ€§èƒ½å¼€é”€ä¸»è¦æ¥æº**ï¼š

```java
/**
 * æ€§èƒ½æµ‹è¯•å¯¹æ¯”
 */
public class SynchronizedPerformanceTest {
    private volatile int volatileCounter = 0;
    private int syncCounter = 0;
    private AtomicInteger atomicCounter = new AtomicInteger(0);
    
    public synchronized void syncIncrement() {
        syncCounter++;
    }
    
    public void atomicIncrement() {
        atomicCounter.incrementAndGet();
    }
    
    // æ€§èƒ½æµ‹è¯•æ–¹æ³•
    public static void performanceTest() {
        SynchronizedPerformanceTest test = new SynchronizedPerformanceTest();
        int iterations = 1000000;
        
        // æµ‹è¯•synchronized
        long start = System.nanoTime();
        for (int i = 0; i < iterations; i++) {
            test.syncIncrement();
        }
        long syncTime = System.nanoTime() - start;
        
        // æµ‹è¯•AtomicInteger
        start = System.nanoTime();
        for (int i = 0; i < iterations; i++) {
            test.atomicIncrement();
        }
        long atomicTime = System.nanoTime() - start;
        
        System.out.println("Synchronized: " + syncTime / 1000000 + "ms");
        System.out.println("AtomicInteger: " + atomicTime / 1000000 + "ms");
    }
}
```

### ä¼˜åŒ–ç­–ç•¥æ–¹æ¡ˆ

**1. å‡å°‘åŒæ­¥èŒƒå›´**
```java
// âŒ åŒæ­¥èŒƒå›´è¿‡å¤§
public synchronized void process() {
    String data = prepareData();  // è€—æ—¶æ“ä½œ
    updateSharedResource(data);   // çœŸæ­£éœ€è¦åŒæ­¥çš„æ“ä½œ
    sendNotification();          // è€—æ—¶æ“ä½œ
}

// âœ… æœ€å°åŒ–åŒæ­¥èŒƒå›´
public void process() {
    String data = prepareData();  // ä¸éœ€è¦åŒæ­¥
    
    synchronized(this) {          // åªåŒæ­¥å¿…è¦éƒ¨åˆ†
        updateSharedResource(data);
    }
    
    sendNotification();          // ä¸éœ€è¦åŒæ­¥
}
```

**2. ä½¿ç”¨ä¸åŒçš„é”å¯¹è±¡**
```java
public class OptimizedLocking {
    private final Object readLock = new Object();
    private final Object writeLock = new Object();
    
    private volatile String data = "";
    
    public String readData() {
        synchronized(readLock) {
            return data;
        }
    }
    
    public void writeData(String newData) {
        synchronized(writeLock) {
            this.data = newData;
        }
    }
}
```

### å¸¸è§å‘ç‚¹è§„é¿

**1. æ­»é”é¢„é˜²**
```java
/**
 * æ­»é”é¢„é˜²ç¤ºä¾‹
 */
public class DeadlockPrevention {
    private static final Object lock1 = new Object();
    private static final Object lock2 = new Object();
    
    // âœ… æ­£ç¡®ï¼šç»Ÿä¸€åŠ é”é¡ºåº
    public void method1() {
        synchronized(lock1) {
            synchronized(lock2) {
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
    
    public void method2() {
        synchronized(lock1) {  // ç›¸åŒçš„åŠ é”é¡ºåº
            synchronized(lock2) {
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
}
```

**2. å­—ç¬¦ä¸²å¸¸é‡é”çš„å‘**
```java
// âŒ å±é™©ï¼šå­—ç¬¦ä¸²å¸¸é‡å¯èƒ½è¢«å…¶ä»–ä»£ç é”å®š
synchronized("LOCK_STRING") {
    // å¯èƒ½äº§ç”Ÿæ„å¤–çš„é”ç«äº‰
}

// âœ… å®‰å…¨ï¼šä½¿ç”¨ä¸“ç”¨çš„é”å¯¹è±¡
private static final Object LOCK = new Object();
synchronized(LOCK) {
    // å®‰å…¨çš„åŒæ­¥
}
```

## ğŸ“š æ€»ç»“ä¸æŠ€æœ¯å¯¹æ¯”

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

1. **synchronizedæ˜¯Javaå†…ç½®çš„åŒæ­¥æœºåˆ¶**ï¼ŒåŸºäºMonitoræ¨¡å¼å®ç°
2. **é”å‡çº§æœºåˆ¶**æå‡äº†æ€§èƒ½ï¼šåå‘é”â†’è½»é‡çº§é”â†’é‡é‡çº§é”
3. **ä½¿ç”¨ç®€å•ä½†åŠŸèƒ½æœ‰é™**ï¼Œé€‚åˆåŸºç¡€çš„åŒæ­¥éœ€æ±‚
4. **JVMå±‚é¢ä¼˜åŒ–**åŒ…æ‹¬é”æ¶ˆé™¤ã€é”ç²—åŒ–ç­‰æŠ€æœ¯
5. **æ­£ç¡®ä½¿ç”¨éœ€è¦æ³¨æ„**é”ç²’åº¦ã€æ­»é”é¢„é˜²ç­‰é—®é¢˜

### ä¸ç›¸å…³æŠ€æœ¯å¯¹æ¯”

| åŒæ­¥æœºåˆ¶ | æ€§èƒ½ | åŠŸèƒ½ | ä½¿ç”¨å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|-----------|----------|
| synchronized | ä¸­ç­‰ | åŸºç¡€ | ç®€å• | åŸºæœ¬åŒæ­¥éœ€æ±‚ |
| ReentrantLock | é«˜ | ä¸°å¯Œ | ä¸­ç­‰ | å¤æ‚åŒæ­¥åœºæ™¯ |
| ReadWriteLock | é«˜ | ä¸“ç”¨ | ä¸­ç­‰ | è¯»å¤šå†™å°‘ |
| StampedLock | æœ€é«˜ | é«˜çº§ | å¤æ‚ | é«˜æ€§èƒ½è¯»å†™ |
| Atomicç±» | æœ€é«˜ | ä¸“ç”¨ | ç®€å• | æ— é”ç¼–ç¨‹ |

### æŒç»­å­¦ä¹ å»ºè®®

1. **æ·±å…¥JUCåŒ…**ï¼šå­¦ä¹ ReentrantLockã€Semaphoreç­‰é«˜çº§åŒæ­¥å·¥å…·
2. **ç†è§£JVMä¼˜åŒ–**ï¼šç ”ç©¶HotSpotçš„é”ä¼˜åŒ–ç­–ç•¥
3. **å®è·µé¡¹ç›®åº”ç”¨**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­ç§¯ç´¯åŒæ­¥è®¾è®¡ç»éªŒ
4. **å…³æ³¨æ–°ç‰¹æ€§**ï¼šè·Ÿè¸ªæ–°ç‰ˆæœ¬JDKçš„å¹¶å‘æ”¹è¿›
5. **å­¦ä¹ æ— é”ç¼–ç¨‹**ï¼šæŒæ¡CASå’ŒåŸå­æ“ä½œçš„ä½¿ç”¨

---

**ä¸‹ä¸€ç¯‡é¢„å‘Š**ï¼šã€Švolatileå…³é”®å­—ä¸å†…å­˜å¯è§æ€§ã€‹å°†æ·±å…¥æ¢è®¨Javaå†…å­˜æ¨¡å‹ã€happens-beforeå…³ç³»å’ŒæŒ‡ä»¤é‡æ’åºçš„æ ¸å¿ƒæœºåˆ¶ã€‚
```
