---
title: "MySQLåˆ†åº“åˆ†è¡¨ç­–ç•¥ä¸å®è·µæ·±åº¦è§£æ"
description: "æ·±å…¥æ¢è®¨MySQLåˆ†åº“åˆ†è¡¨çš„è®¾è®¡åŸç†ã€åˆ†ç‰‡ç­–ç•¥ã€æ•°æ®è¿ç§»å’Œè·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–ï¼Œç»“åˆShardingSphereç­‰ä¸­é—´ä»¶å®æˆ˜åˆ†äº«å¤§è§„æ¨¡æ•°æ®åº“æ¶æ„è®¾è®¡ç»éªŒã€‚"
pubDate: 2024-12-28
updatedDate: 2024-12-28
tags: ["mysql", "sharding", "partitioning", "distributed-database", "shardingsphere", "database", "interview", "best-practices"]
categories: ["database"]
subject: "MySQLåˆ†å¸ƒå¼æ¶æ„"
draft: false
featured: true
author: "Gerrad Zhang"
location: "æ­¦æ±‰ï¼Œä¸­å›½"
---

## ğŸ¤” é—®é¢˜èƒŒæ™¯ä¸æŠ€æœ¯æ¼”è¿›

### æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

éšç€äº’è”ç½‘ä¸šåŠ¡çš„å¿«é€Ÿå‘å±•ï¼Œå•ä¸€MySQLå®ä¾‹é¢ä¸´ç€ä¸¥å³»çš„æŒ‘æˆ˜ã€‚å½“æ•°æ®é‡è¾¾åˆ°åƒä¸‡ç”šè‡³äº¿çº§è§„æ¨¡æ—¶ï¼Œä¼ ç»Ÿçš„å•åº“å•è¡¨æ¶æ„ä¼šé‡åˆ°å¤šé‡ç“¶é¢ˆï¼š

**å­˜å‚¨å®¹é‡ç“¶é¢ˆ**ï¼šå•è¡¨æ•°æ®é‡è¿‡å¤§ï¼Œå½±å“æŸ¥è¯¢æ€§èƒ½å’Œç»´æŠ¤æ•ˆç‡ã€‚**å¹¶å‘æ€§èƒ½ç“¶é¢ˆ**ï¼šå•å®ä¾‹æ— æ³•æ‰¿å—é«˜å¹¶å‘çš„è¯»å†™å‹åŠ›ã€‚**å¯ç”¨æ€§é£é™©**ï¼šå•ç‚¹æ•…éšœå¯èƒ½å¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ã€‚**æ‰©å±•æ€§é™åˆ¶**ï¼šå‚ç›´æ‰©å±•æˆæœ¬é«˜æ˜‚ä¸”æœ‰ä¸Šé™ã€‚

å…·ä½“è¡¨ç°ä¸ºï¼šæŸ¥è¯¢å“åº”æ—¶é—´æ€¥å‰§å¢é•¿ã€ç´¢å¼•æ•ˆç‡ä¸‹é™ã€å¤‡ä»½æ¢å¤æ—¶é—´è¿‡é•¿ã€DDLæ“ä½œå½±å“ä¸šåŠ¡ã€å•æœºèµ„æºè¾¾åˆ°æé™ç­‰é—®é¢˜ã€‚è¿™äº›é—®é¢˜åœ¨ç”µå•†ã€ç¤¾äº¤ã€é‡‘èç­‰æ•°æ®å¯†é›†å‹åº”ç”¨ä¸­å°¤ä¸ºçªå‡ºã€‚

### æ²¡æœ‰è¿™ä¸ªæŠ€æœ¯æ—¶æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

åœ¨åˆ†åº“åˆ†è¡¨æŠ€æœ¯æˆç†Ÿä¹‹å‰ï¼Œä¼ä¸šä¸»è¦é‡‡ç”¨ä»¥ä¸‹æ–¹æ¡ˆåº”å¯¹å¤§æ•°æ®é‡æŒ‘æˆ˜ï¼š

**å‚ç›´æ‰©å±•ï¼ˆScale Upï¼‰**ï¼šé€šè¿‡å‡çº§ç¡¬ä»¶é…ç½®æ¥æå‡æ•°æ®åº“æ€§èƒ½ï¼Œä½†æˆæœ¬é«˜æ˜‚ä¸”æœ‰å¤©èŠ±æ¿ã€‚**è¯»å†™åˆ†ç¦»**ï¼šé€šè¿‡ä¸»ä»å¤åˆ¶åˆ†ç¦»è¯»å†™æ“ä½œï¼Œä½†å†™æ“ä½œä»ç„¶é›†ä¸­åœ¨ä¸»åº“ã€‚**ä¸šåŠ¡æ‹†åˆ†**ï¼šå°†ä¸åŒä¸šåŠ¡æ¨¡å—çš„æ•°æ®å­˜å‚¨åœ¨ä¸åŒæ•°æ®åº“ä¸­ï¼Œä½†å•ä¸ªä¸šåŠ¡çš„æ•°æ®é‡é—®é¢˜ä¾ç„¶å­˜åœ¨ã€‚**å†·çƒ­æ•°æ®åˆ†ç¦»**ï¼šå°†å†å²æ•°æ®è¿ç§»åˆ°å½’æ¡£åº“ï¼Œä½†çƒ­æ•°æ®å¢é•¿é—®é¢˜æœªæ ¹æœ¬è§£å†³ã€‚

è¿™äº›ä¼ ç»Ÿæ–¹æ¡ˆè™½ç„¶èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£å‹åŠ›ï¼Œä½†éƒ½æ— æ³•ä»æ ¹æœ¬ä¸Šè§£å†³å•åº“å•è¡¨çš„å®¹é‡å’Œæ€§èƒ½ç“¶é¢ˆé—®é¢˜ã€‚

### æŠ€æœ¯æ¼”è¿›çš„å†å²è„‰ç»œ

æ•°æ®åº“åˆ†ç‰‡æŠ€æœ¯çš„å‘å±•ç»å†äº†å‡ ä¸ªé‡è¦é˜¶æ®µï¼š

**æ—©æœŸæ‰‹å·¥åˆ†ç‰‡ï¼ˆ2000sï¼‰**ï¼šå¼€å‘è€…åœ¨åº”ç”¨å±‚æ‰‹åŠ¨å®ç°æ•°æ®åˆ†ç‰‡é€»è¾‘ï¼Œå¤æ‚ä¸”å®¹æ˜“å‡ºé”™ã€‚**ä¸­é—´ä»¶æ—¶ä»£ï¼ˆ2010sï¼‰**ï¼šå‡ºç°äº†Cobarã€MyCATç­‰åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ï¼Œç®€åŒ–äº†åˆ†ç‰‡å®ç°ã€‚**äº‘åŸç”Ÿæ—¶ä»£ï¼ˆ2015+ï¼‰**ï¼šShardingSphereã€Vitessç­‰ç°ä»£åˆ†ç‰‡è§£å†³æ–¹æ¡ˆæä¾›äº†æ›´å®Œå–„çš„åŠŸèƒ½ã€‚**NewSQLæ—¶ä»£ï¼ˆ2020+ï¼‰**ï¼šTiDBã€CockroachDBç­‰åˆ†å¸ƒå¼æ•°æ®åº“åŸç”Ÿæ”¯æŒæ°´å¹³æ‰©å±•ã€‚

MySQLè‡ªèº«ä¹Ÿåœ¨æ¼”è¿›ï¼š**MySQL 5.1å¼•å…¥äº†åˆ†åŒºè¡¨**ã€**MySQL 5.6æ”¹è¿›äº†åˆ†åŒºæ€§èƒ½**ã€**MySQL 8.0å¢å¼ºäº†åˆ†åŒºç®¡ç†åŠŸèƒ½**ã€‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µä¸åŸç†

### åŸºç¡€æ¦‚å¿µå®šä¹‰

**åˆ†åº“åˆ†è¡¨ï¼ˆShardingï¼‰**æ˜¯ä¸€ç§æ•°æ®åº“æ°´å¹³æ‰©å±•æŠ€æœ¯ï¼Œé€šè¿‡å°†æ•°æ®åˆ†æ•£å­˜å‚¨åˆ°å¤šä¸ªæ•°æ®åº“å®ä¾‹å’Œè¡¨ä¸­ï¼Œå®ç°å­˜å‚¨å®¹é‡å’Œå¤„ç†èƒ½åŠ›çš„çº¿æ€§æ‰©å±•ã€‚

**æ°´å¹³åˆ†ç‰‡ï¼ˆHorizontal Shardingï¼‰**ï¼šæŒ‰ç…§æŸç§è§„åˆ™å°†åŒä¸€å¼ è¡¨çš„æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“æˆ–è¡¨ä¸­ï¼Œæ¯ä¸ªåˆ†ç‰‡åŒ…å«è¡¨çš„éƒ¨åˆ†è¡Œæ•°æ®ã€‚

**å‚ç›´åˆ†ç‰‡ï¼ˆVertical Shardingï¼‰**ï¼šå°†ä¸€ä¸ªæ•°æ®åº“æŒ‰ç…§ä¸šåŠ¡åŠŸèƒ½æˆ–è¡¨çš„å…³è”åº¦æ‹†åˆ†æˆå¤šä¸ªæ•°æ®åº“ï¼Œæ¯ä¸ªæ•°æ®åº“åŒ…å«éƒ¨åˆ†è¡¨ã€‚

**åˆ†ç‰‡é”®ï¼ˆShard Keyï¼‰**ï¼šç”¨äºç¡®å®šæ•°æ®åˆ†å¸ƒåˆ°å“ªä¸ªåˆ†ç‰‡çš„å­—æ®µï¼Œæ˜¯åˆ†åº“åˆ†è¡¨è®¾è®¡çš„æ ¸å¿ƒã€‚

### å·¥ä½œåŸç†è¯¦è§£

åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒå·¥ä½œæµç¨‹åŒ…æ‹¬ï¼š

**1. è·¯ç”±è®¡ç®—**ï¼š
- æ ¹æ®åˆ†ç‰‡é”®å’Œåˆ†ç‰‡ç®—æ³•ç¡®å®šç›®æ ‡åˆ†ç‰‡
- æ”¯æŒèŒƒå›´åˆ†ç‰‡ã€å“ˆå¸Œåˆ†ç‰‡ã€ä¸€è‡´æ€§å“ˆå¸Œç­‰ç®—æ³•
- è€ƒè™‘æ•°æ®å€¾æ–œå’Œçƒ­ç‚¹é—®é¢˜

**2. SQLæ”¹å†™**ï¼š
- å°†é€»è¾‘SQLæ”¹å†™ä¸ºé’ˆå¯¹å…·ä½“åˆ†ç‰‡çš„ç‰©ç†SQL
- å¤„ç†è·¨åˆ†ç‰‡æŸ¥è¯¢çš„JOINå’Œèšåˆæ“ä½œ
- ä¼˜åŒ–æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’

**3. ç»“æœåˆå¹¶**ï¼š
- æ”¶é›†å„åˆ†ç‰‡çš„æŸ¥è¯¢ç»“æœ
- è¿›è¡Œæ’åºã€åˆ†é¡µã€èšåˆç­‰æ“ä½œ
- è¿”å›æœ€ç»ˆç»“æœç»™åº”ç”¨

**4. äº‹åŠ¡ç®¡ç†**ï¼š
- å¤„ç†å•åˆ†ç‰‡äº‹åŠ¡å’Œè·¨åˆ†ç‰‡åˆ†å¸ƒå¼äº‹åŠ¡
- æ”¯æŒä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ç­‰åˆ†å¸ƒå¼äº‹åŠ¡åè®®
- ä¿è¯æ•°æ®ä¸€è‡´æ€§

### æŠ€æœ¯ç‰¹ç‚¹å’Œä¼˜åŠ¿

åˆ†åº“åˆ†è¡¨æŠ€æœ¯å…·æœ‰ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š

**æ°´å¹³æ‰©å±•èƒ½åŠ›**ï¼šé€šè¿‡å¢åŠ åˆ†ç‰‡æ•°é‡å®ç°è¿‘ä¼¼çº¿æ€§çš„å®¹é‡å’Œæ€§èƒ½æ‰©å±•ã€‚**é«˜å¯ç”¨æ€§**ï¼šå•ä¸ªåˆ†ç‰‡æ•…éšœä¸å½±å“å…¶ä»–åˆ†ç‰‡çš„æ­£å¸¸æœåŠ¡ã€‚**æ€§èƒ½æå‡**ï¼šå¹¶è¡Œå¤„ç†æé«˜æŸ¥è¯¢å’Œå†™å…¥æ€§èƒ½ã€‚**æˆæœ¬æ•ˆç›Š**ï¼šä½¿ç”¨æ™®é€šç¡¬ä»¶å®ç°å¤§è§„æ¨¡æ•°æ®å¤„ç†ã€‚**çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§åˆ†ç‰‡ç­–ç•¥é€‚åº”ä¸åŒä¸šåŠ¡åœºæ™¯ã€‚

## ğŸ”§ å®ç°åŸç†ä¸æºç åˆ†æ

### åº•å±‚å®ç°æœºåˆ¶

ä»¥ShardingSphereä¸ºä¾‹ï¼Œåˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒå®ç°åŒ…æ‹¬ï¼š

**SQLè§£æå¼•æ“**ï¼š
- åŸºäºAntlr4æ„å»ºSQLè§£æå™¨
- æ”¯æŒMySQLã€PostgreSQLç­‰å¤šç§æ•°æ®åº“æ–¹è¨€
- ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ç”¨äºåç»­å¤„ç†

**è·¯ç”±å¼•æ“**ï¼š
- å®ç°å¤šç§åˆ†ç‰‡ç®—æ³•ï¼šç²¾ç¡®åˆ†ç‰‡ã€èŒƒå›´åˆ†ç‰‡ã€å¤åˆåˆ†ç‰‡
- æ”¯æŒåˆ†ç‰‡ç®—æ³•çš„çƒ­æ’æ‹”å’Œè‡ªå®šä¹‰æ‰©å±•
- ä¼˜åŒ–è·¨åˆ†ç‰‡æŸ¥è¯¢çš„è·¯ç”±ç­–ç•¥

**æ”¹å†™å¼•æ“**ï¼š
- å°†é€»è¾‘SQLæ”¹å†™ä¸ºç›®æ ‡æ•°æ®æºçš„ç‰©ç†SQL
- å¤„ç†åˆ†é¡µã€æ’åºã€èšåˆç­‰å¤æ‚æŸ¥è¯¢
- æ”¯æŒSQLä¼˜åŒ–å’Œæ‰§è¡Œè®¡åˆ’è°ƒæ•´

### å…³é”®æºç è§£è¯»

ä»¥ä¸‹æ˜¯ShardingSphereçš„æ ¸å¿ƒä»£ç ç»“æ„ï¼š

```java
// åˆ†ç‰‡è·¯ç”±æ ¸å¿ƒé€»è¾‘
public class ShardingRouteEngine {
    
    public RouteResult route(LogicSQL logicSQL, ShardingRule shardingRule) {
        // 1. è§£æSQLè·å–åˆ†ç‰‡æ¡ä»¶
        ShardingConditions shardingConditions = getShardingConditions(logicSQL);
        
        // 2. è®¡ç®—è·¯ç”±ç»“æœ
        Collection<RouteUnit> routeUnits = route(shardingConditions, shardingRule);
        
        // 3. æ„å»ºè·¯ç”±ç»“æœ
        return new RouteResult(routeUnits);
    }
    
    private Collection<RouteUnit> route(ShardingConditions conditions, 
                                       ShardingRule shardingRule) {
        Collection<RouteUnit> result = new ArrayList<>();
        
        for (ShardingCondition condition : conditions.getConditions()) {
            // æ•°æ®åº“åˆ†ç‰‡è®¡ç®—
            Collection<String> dataSourceNames = 
                shardingRule.getDatabaseShardingStrategy()
                          .doSharding(condition.getDataSourceShardingValues());
            
            // è¡¨åˆ†ç‰‡è®¡ç®—  
            for (String dataSourceName : dataSourceNames) {
                Collection<String> tableNames = 
                    shardingRule.getTableShardingStrategy()
                              .doSharding(condition.getTableShardingValues());
                
                for (String tableName : tableNames) {
                    result.add(new RouteUnit(dataSourceName, tableName));
                }
            }
        }
        
        return result;
    }
}

// åˆ†ç‰‡ç®—æ³•æ¥å£
public interface ShardingAlgorithm {
    /**
     * åˆ†ç‰‡è®¡ç®—
     * @param availableTargetNames å¯ç”¨ç›®æ ‡åç§°
     * @param shardingValues åˆ†ç‰‡å€¼
     * @return åˆ†ç‰‡ç»“æœ
     */
    Collection<String> doSharding(Collection<String> availableTargetNames,
                                 Collection<ShardingValue> shardingValues);
}

// å“ˆå¸Œåˆ†ç‰‡ç®—æ³•å®ç°
public class HashShardingAlgorithm implements ShardingAlgorithm {
    
    @Override
    public Collection<String> doSharding(Collection<String> availableTargetNames,
                                        Collection<ShardingValue> shardingValues) {
        Collection<String> result = new ArrayList<>();
        
        for (ShardingValue shardingValue : shardingValues) {
            if (shardingValue instanceof ListShardingValue) {
                ListShardingValue listValue = (ListShardingValue) shardingValue;
                for (Comparable<?> value : listValue.getValues()) {
                    String targetName = getTargetName(value, availableTargetNames);
                    result.add(targetName);
                }
            }
        }
        
        return result;
    }
    
    private String getTargetName(Comparable<?> shardingValue, 
                                Collection<String> availableTargetNames) {
        int hash = shardingValue.hashCode();
        int index = Math.abs(hash) % availableTargetNames.size();
        return availableTargetNames.toArray(new String[0])[index];
    }
}
```

### è®¾è®¡æ€æƒ³åˆ†æ

åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶çš„è®¾è®¡ä½“ç°äº†å‡ ä¸ªé‡è¦åŸåˆ™ï¼š

**é€æ˜åŒ–åŸåˆ™**ï¼šå¯¹åº”ç”¨å±‚é€æ˜ï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç å³å¯å®ç°åˆ†åº“åˆ†è¡¨ã€‚

**å¯æ‰©å±•æ€§åŸåˆ™**ï¼šæ”¯æŒåˆ†ç‰‡ç®—æ³•ã€æ•°æ®æºã€SQLæ–¹è¨€çš„æ’ä»¶åŒ–æ‰©å±•ã€‚

**é«˜æ€§èƒ½åŸåˆ™**ï¼šæœ€å°åŒ–ä¸­é—´ä»¶å¼€é”€ï¼Œä¼˜åŒ–SQLè§£æå’Œè·¯ç”±æ€§èƒ½ã€‚

**ä¸€è‡´æ€§åŸåˆ™**ï¼šä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ACIDç‰¹æ€§ï¼Œæä¾›å¤šç§ä¸€è‡´æ€§çº§åˆ«é€‰æ‹©ã€‚

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ä¸ä»£ç ç¤ºä¾‹

### å…·ä½“é¡¹ç›®åº”ç”¨

åœ¨ä¸€ä¸ªå¤§å‹ç”µå•†é¡¹ç›®ä¸­ï¼Œè®¢å•è¡¨é¢ä¸´ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆã€‚å•è¡¨æ•°æ®é‡è¶…è¿‡5000ä¸‡ï¼ŒæŸ¥è¯¢å“åº”æ—¶é—´è¶…è¿‡10ç§’ï¼Œä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒã€‚

**ä¸šåŠ¡åœºæ™¯åˆ†æ**ï¼š
- è®¢å•æ•°æ®æŒ‰æ—¶é—´æŒç»­å¢é•¿
- æŸ¥è¯¢ä¸»è¦åŸºäºç”¨æˆ·IDå’Œè®¢å•æ—¶é—´
- éœ€è¦æ”¯æŒå¤æ‚çš„ç»Ÿè®¡æŸ¥è¯¢
- è¦æ±‚é«˜å¯ç”¨å’Œæ•°æ®ä¸€è‡´æ€§

**åˆ†ç‰‡ç­–ç•¥è®¾è®¡**ï¼š
- æŒ‰ç”¨æˆ·IDè¿›è¡Œå“ˆå¸Œåˆ†åº“ï¼ˆ16ä¸ªåº“ï¼‰
- æŒ‰è®¢å•æ—¶é—´è¿›è¡ŒèŒƒå›´åˆ†è¡¨ï¼ˆæ¯æœˆä¸€å¼ è¡¨ï¼‰
- ä½¿ç”¨å¤åˆåˆ†ç‰‡é”®ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### å®Œæ•´ä»£ç å®ç°

**æ­¥éª¤1ï¼šShardingSphereé…ç½®**

```yaml
# application-sharding.yml
spring:
  shardingsphere:
    datasource:
      names: ds0,ds1,ds2,ds3,ds4,ds5,ds6,ds7,ds8,ds9,ds10,ds11,ds12,ds13,ds14,ds15
      # é…ç½®16ä¸ªæ•°æ®æº
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://192.168.1.100:3306/ecommerce_0
        username: root
        password: password
      # ... å…¶ä»–æ•°æ®æºé…ç½®ç±»ä¼¼
      
    sharding:
      tables:
        t_order:
          # åˆ†ç‰‡èŠ‚ç‚¹é…ç½®
          actual-data-nodes: ds$->{0..15}.t_order_$->{2024..2025}$->{01..12}
          
          # åˆ†åº“ç­–ç•¥
          database-strategy:
            inline:
              sharding-column: user_id
              algorithm-expression: ds$->{user_id % 16}
          
          # åˆ†è¡¨ç­–ç•¥  
          table-strategy:
            inline:
              sharding-column: order_time
              algorithm-expression: t_order_$->{order_time.format('yyyy')}$->{order_time.format('MM')}
              
          # ä¸»é”®ç”Ÿæˆç­–ç•¥
          key-generator:
            column: order_id
            type: SNOWFLAKE
            
        t_order_item:
          actual-data-nodes: ds$->{0..15}.t_order_item_$->{2024..2025}$->{01..12}
          database-strategy:
            inline:
              sharding-column: user_id  
              algorithm-expression: ds$->{user_id % 16}
          table-strategy:
            inline:
              sharding-column: order_time
              algorithm-expression: t_order_item_$->{order_time.format('yyyy')}$->{order_time.format('MM')}
              
      # ç»‘å®šè¡¨é…ç½®
      binding-tables:
        - t_order,t_order_item
        
      # å¹¿æ’­è¡¨é…ç½®
      broadcast-tables:
        - t_config
        - t_dict
        
    props:
      # æ˜¾ç¤ºSQL
      sql.show: true
      # å…è®¸èŒƒå›´æŸ¥è¯¢
      allow.range.query.with.inline.sharding: true
```

**æ­¥éª¤2ï¼šè‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•**

```java
// è‡ªå®šä¹‰æ—¶é—´èŒƒå›´åˆ†ç‰‡ç®—æ³•
@Component
public class TimeRangeShardingAlgorithm implements RangeShardingAlgorithm<Date> {
    
    @Override
    public Collection<String> doSharding(Collection<String> availableTargetNames,
                                        RangeShardingValue<Date> shardingValue) {
        Collection<String> result = new ArrayList<>();
        
        Range<Date> valueRange = shardingValue.getValueRange();
        Date lowerEndpoint = valueRange.lowerEndpoint();
        Date upperEndpoint = valueRange.upperEndpoint();
        
        // æŒ‰æœˆä»½ç”Ÿæˆè¡¨å
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(lowerEndpoint);
        
        while (!calendar.getTime().after(upperEndpoint)) {
            String tableName = String.format("t_order_%04d%02d", 
                calendar.get(Calendar.YEAR),
                calendar.get(Calendar.MONTH) + 1);
                
            if (availableTargetNames.contains(tableName)) {
                result.add(tableName);
            }
            
            calendar.add(Calendar.MONTH, 1);
        }
        
        return result;
    }
}

// ä¸€è‡´æ€§å“ˆå¸Œåˆ†ç‰‡ç®—æ³•
@Component  
public class ConsistentHashShardingAlgorithm implements StandardShardingAlgorithm<Long> {
    
    private final ConsistentHash<String> consistentHash;
    
    public ConsistentHashShardingAlgorithm() {
        this.consistentHash = new ConsistentHash<>(3, Collections.emptyList());
    }
    
    @Override
    public String doSharding(Collection<String> availableTargetNames,
                           PreciseShardingValue<Long> shardingValue) {
        // åˆå§‹åŒ–ä¸€è‡´æ€§å“ˆå¸Œç¯
        if (consistentHash.isEmpty()) {
            for (String targetName : availableTargetNames) {
                consistentHash.add(targetName);
            }
        }
        
        return consistentHash.get(shardingValue.getValue().toString());
    }
    
    @Override
    public Collection<String> doSharding(Collection<String> availableTargetNames,
                                        RangeShardingValue<Long> shardingValue) {
        // èŒƒå›´æŸ¥è¯¢è¿”å›æ‰€æœ‰åˆ†ç‰‡
        return availableTargetNames;
    }
}
```

**æ­¥éª¤3ï¼šæ•°æ®è®¿é—®å±‚å®ç°**

```java
// è®¢å•æœåŠ¡å®ç°
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private OrderItemMapper orderItemMapper;
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆå•åˆ†ç‰‡äº‹åŠ¡ï¼‰
     */
    public void createOrder(Order order, List<OrderItem> orderItems) {
        // æ’å…¥è®¢å•ä¸»è¡¨
        orderMapper.insert(order);
        
        // æ’å…¥è®¢å•æ˜ç»†ï¼ˆç»‘å®šè¡¨ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°åŒä¸€åˆ†ç‰‡ï¼‰
        for (OrderItem item : orderItems) {
            item.setOrderId(order.getOrderId());
            item.setUserId(order.getUserId());
            item.setOrderTime(order.getOrderTime());
            orderItemMapper.insert(item);
        }
    }
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·è®¢å•ï¼ˆå¼ºåˆ¶è·¯ç”±ï¼‰
     */
    public List<Order> getUserOrders(Long userId, Date startTime, Date endTime) {
        return orderMapper.selectByUserIdAndTimeRange(userId, startTime, endTime);
    }
    
    /**
     * è®¢å•ç»Ÿè®¡ï¼ˆè·¨åˆ†ç‰‡æŸ¥è¯¢ï¼‰
     */
    @ShardingTransactionType(TransactionType.BASE)
    public OrderStatistics getOrderStatistics(Date startTime, Date endTime) {
        // è·¨åˆ†ç‰‡èšåˆæŸ¥è¯¢
        return orderMapper.selectOrderStatistics(startTime, endTime);
    }
}

// MyBatis Mapper
@Mapper
public interface OrderMapper {
    
    @Insert("INSERT INTO t_order (order_id, user_id, order_time, total_amount, status) " +
            "VALUES (#{orderId}, #{userId}, #{orderTime}, #{totalAmount}, #{status})")
    void insert(Order order);
    
    @Select("SELECT * FROM t_order WHERE user_id = #{userId} " +
            "AND order_time BETWEEN #{startTime} AND #{endTime} " +
            "ORDER BY order_time DESC")
    List<Order> selectByUserIdAndTimeRange(@Param("userId") Long userId,
                                          @Param("startTime") Date startTime,
                                          @Param("endTime") Date endTime);
    
    @Select("SELECT COUNT(*) as order_count, SUM(total_amount) as total_amount " +
            "FROM t_order WHERE order_time BETWEEN #{startTime} AND #{endTime}")
    OrderStatistics selectOrderStatistics(@Param("startTime") Date startTime,
                                         @Param("endTime") Date endTime);
}
```

### æœ€ä½³å®è·µæ€»ç»“

**æ•°æ®è¿ç§»ç­–ç•¥**ï¼š

```java
// æ•°æ®è¿ç§»å·¥å…·
@Component
public class ShardingMigrationTool {
    
    @Autowired
    private DataSource oldDataSource;
    
    @Autowired
    private DataSource newShardingDataSource;
    
    /**
     * åœ¨çº¿æ•°æ®è¿ç§»
     */
    public void migrateData(String tableName, int batchSize) {
        JdbcTemplate oldTemplate = new JdbcTemplate(oldDataSource);
        JdbcTemplate newTemplate = new JdbcTemplate(newShardingDataSource);
        
        // 1. è·å–æ€»è®°å½•æ•°
        int totalCount = oldTemplate.queryForObject(
            "SELECT COUNT(*) FROM " + tableName, Integer.class);
        
        // 2. åˆ†æ‰¹è¿ç§»æ•°æ®
        int offset = 0;
        while (offset < totalCount) {
            List<Map<String, Object>> batch = oldTemplate.queryForList(
                "SELECT * FROM " + tableName + " LIMIT ?, ?", 
                offset, batchSize);
            
            // 3. æ’å…¥åˆ°åˆ†ç‰‡è¡¨
            for (Map<String, Object> row : batch) {
                StringBuilder sql = new StringBuilder("INSERT INTO " + tableName + " (");
                StringBuilder values = new StringBuilder(" VALUES (");
                
                for (String column : row.keySet()) {
                    sql.append(column).append(",");
                    values.append("?,");
                }
                
                sql.setLength(sql.length() - 1);
                values.setLength(values.length() - 1);
                sql.append(")").append(values).append(")");
                
                newTemplate.update(sql.toString(), row.values().toArray());
            }
            
            offset += batchSize;
            
            // 4. è¿›åº¦æ—¥å¿—
            log.info("Migration progress: {}/{}", offset, totalCount);
        }
    }
    
    /**
     * æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
     */
    public boolean verifyDataConsistency(String tableName) {
        JdbcTemplate oldTemplate = new JdbcTemplate(oldDataSource);
        JdbcTemplate newTemplate = new JdbcTemplate(newShardingDataSource);
        
        // æ¯”è¾ƒæ€»è®°å½•æ•°
        int oldCount = oldTemplate.queryForObject(
            "SELECT COUNT(*) FROM " + tableName, Integer.class);
        int newCount = newTemplate.queryForObject(
            "SELECT COUNT(*) FROM " + tableName, Integer.class);
        
        if (oldCount != newCount) {
            log.error("Data count mismatch: old={}, new={}", oldCount, newCount);
            return false;
        }
        
        // æ¯”è¾ƒæ•°æ®æ ¡éªŒå’Œ
        String oldChecksum = oldTemplate.queryForObject(
            "SELECT MD5(GROUP_CONCAT(id ORDER BY id)) FROM " + tableName, String.class);
        String newChecksum = newTemplate.queryForObject(
            "SELECT MD5(GROUP_CONCAT(id ORDER BY id)) FROM " + tableName, String.class);
        
        return Objects.equals(oldChecksum, newChecksum);
    }
}
```

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜ç²¾è®²

### 1. åˆ†åº“åˆ†è¡¨å’Œåˆ†åŒºè¡¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šåˆ†åº“åˆ†è¡¨å’Œåˆ†åŒºè¡¨æ˜¯ä¸¤ç§ä¸åŒçš„æ•°æ®åˆ†ç‰‡æŠ€æœ¯ï¼š

**åˆ†åŒºè¡¨ï¼ˆPartitioningï¼‰**ï¼š
- MySQLå†…ç½®åŠŸèƒ½ï¼Œåœ¨å•ä¸ªå®ä¾‹å†…å°†è¡¨åˆ†æˆå¤šä¸ªåˆ†åŒº
- å¯¹åº”ç”¨é€æ˜ï¼ŒSQLè¯­æ³•ä¸å˜
- é€‚åˆå•æœºå®¹é‡ä¼˜åŒ–ï¼Œæ— æ³•è§£å†³å¹¶å‘ç“¶é¢ˆ
- æ”¯æŒèŒƒå›´ã€å“ˆå¸Œã€åˆ—è¡¨ç­‰åˆ†åŒºç±»å‹

**åˆ†åº“åˆ†è¡¨ï¼ˆShardingï¼‰**ï¼š
- è·¨å¤šä¸ªæ•°æ®åº“å®ä¾‹çš„æ°´å¹³æ‰©å±•
- éœ€è¦ä¸­é—´ä»¶æ”¯æŒï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹SQL
- èƒ½è§£å†³å®¹é‡å’Œå¹¶å‘åŒé‡ç“¶é¢ˆ
- æ”¯æŒæ›´å¤æ‚çš„åˆ†ç‰‡ç­–ç•¥

**é€‰æ‹©å»ºè®®**ï¼šæ•°æ®é‡åœ¨åƒä¸‡çº§ä»¥ä¸‹å¯è€ƒè™‘åˆ†åŒºè¡¨ï¼Œäº¿çº§ä»¥ä¸Šå»ºè®®åˆ†åº“åˆ†è¡¨ã€‚

### 2. å¦‚ä½•é€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šåˆ†ç‰‡é”®é€‰æ‹©æ˜¯åˆ†åº“åˆ†è¡¨è®¾è®¡çš„æ ¸å¿ƒï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š

**ä¸šåŠ¡ç‰¹å¾**ï¼š
- æŸ¥è¯¢é¢‘ç‡æœ€é«˜çš„å­—æ®µ
- æ•°æ®åˆ†å¸ƒç›¸å¯¹å‡åŒ€çš„å­—æ®µ
- ä¸šåŠ¡é€»è¾‘ä¸Šæœ‰æ„ä¹‰çš„å­—æ®µ

**æŠ€æœ¯è¦æ±‚**ï¼š
- æ•°æ®åˆ†å¸ƒå‡åŒ€ï¼Œé¿å…çƒ­ç‚¹
- æŸ¥è¯¢è·¯ç”±é«˜æ•ˆï¼Œå‡å°‘è·¨åˆ†ç‰‡
- æ‰©å®¹æ—¶æ•°æ®è¿ç§»æˆæœ¬ä½

**å¸¸è§é€‰æ‹©**ï¼š
```sql
-- ç”¨æˆ·ç»´åº¦åˆ†ç‰‡ï¼ˆé€‚åˆCç«¯ä¸šåŠ¡ï¼‰
user_id % 16

-- æ—¶é—´ç»´åº¦åˆ†ç‰‡ï¼ˆé€‚åˆæ—¥å¿—ç±»æ•°æ®ï¼‰  
DATE_FORMAT(create_time, '%Y%m')

-- å¤åˆåˆ†ç‰‡é”®ï¼ˆå¹³è¡¡æŸ¥è¯¢æ•ˆç‡å’Œæ•°æ®åˆ†å¸ƒï¼‰
HASH(user_id, order_time)
```

**é¢è¯•æŠ€å·§**ï¼šå¼ºè°ƒè¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯é€‰æ‹©ï¼Œæ²¡æœ‰ä¸‡èƒ½çš„åˆ†ç‰‡é”®ã€‚

### 3. å¦‚ä½•å¤„ç†è·¨åˆ†ç‰‡æŸ¥è¯¢å’Œäº‹åŠ¡ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šè·¨åˆ†ç‰‡æ“ä½œæ˜¯åˆ†åº“åˆ†è¡¨çš„æŠ€æœ¯éš¾ç‚¹ï¼š

**è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–**ï¼š
```java
// 1. å°½é‡é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢
// å¥½çš„è®¾è®¡ï¼šæŒ‰åˆ†ç‰‡é”®æŸ¥è¯¢
SELECT * FROM t_order WHERE user_id = 12345;

// ä¸å¥½çš„è®¾è®¡ï¼šå…¨è¡¨æ‰«æ
SELECT * FROM t_order WHERE status = 'PAID';

// 2. ä½¿ç”¨ç»‘å®šè¡¨ä¼˜åŒ–å…³è”æŸ¥è¯¢
// è®¢å•è¡¨å’Œè®¢å•æ˜ç»†è¡¨ä½¿ç”¨ç›¸åŒåˆ†ç‰‡é”®
```

**è·¨åˆ†ç‰‡äº‹åŠ¡å¤„ç†**ï¼š
- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥è¡¥å¿
- **ä¸¤é˜¶æ®µæäº¤**ï¼šXAäº‹åŠ¡ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½è¾ƒå·®
- **æŸ”æ€§äº‹åŠ¡**ï¼šSagaã€TCCç­‰æ¨¡å¼å¹³è¡¡ä¸€è‡´æ€§å’Œæ€§èƒ½

**å®é™…å»ºè®®**ï¼šä¼˜å…ˆé€šè¿‡ä¸šåŠ¡è®¾è®¡é¿å…è·¨åˆ†ç‰‡æ“ä½œï¼Œå¿…è¦æ—¶é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§æ–¹æ¡ˆã€‚

### 4. åˆ†åº“åˆ†è¡¨åå¦‚ä½•è¿›è¡Œæ•°æ®è¿ç§»ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šæ•°æ®è¿ç§»æ˜¯åˆ†åº“åˆ†è¡¨å®æ–½çš„å…³é”®ç¯èŠ‚ï¼š

**è¿ç§»ç­–ç•¥**ï¼š
1. **åœæœºè¿ç§»**ï¼šä¸šåŠ¡åœæ­¢ï¼Œå…¨é‡è¿ç§»ï¼Œé€‚åˆå°æ•°æ®é‡
2. **åœ¨çº¿è¿ç§»**ï¼šåŒå†™+æ•°æ®æ ¡éªŒï¼Œé€‚åˆå¤§æ•°æ®é‡
3. **ç°åº¦è¿ç§»**ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—é€æ­¥è¿ç§»

**åœ¨çº¿è¿ç§»æ­¥éª¤**ï¼š
```java
// 1. æ­å»ºåˆ†ç‰‡ç¯å¢ƒ
// 2. å†å²æ•°æ®å…¨é‡åŒæ­¥
// 3. å¼€å¯åŒå†™æ¨¡å¼
// 4. å¢é‡æ•°æ®åŒæ­¥
// 5. æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
// 6. åˆ‡æ¢è¯»æµé‡
// 7. åœæ­¢åŒå†™ï¼Œå®Œæˆè¿ç§»
```

**é£é™©æ§åˆ¶**ï¼š
- å……åˆ†çš„æµ‹è¯•å’Œæ¼”ç»ƒ
- å®Œå–„çš„å›æ»šæ–¹æ¡ˆ
- å®æ—¶çš„æ•°æ®æ ¡éªŒ
- åˆ†æ­¥éª¤çš„æµé‡åˆ‡æ¢

### 5. å¦‚ä½•è§£å†³åˆ†åº“åˆ†è¡¨çš„æ•°æ®å€¾æ–œé—®é¢˜ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šæ•°æ®å€¾æ–œæ˜¯åˆ†åº“åˆ†è¡¨å¸¸è§é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š

**é¢„é˜²æªæ–½**ï¼š
- é€‰æ‹©åˆ†å¸ƒå‡åŒ€çš„åˆ†ç‰‡é”®
- ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•
- é¿å…ä½¿ç”¨æ—¶é—´ç­‰é€’å¢å­—æ®µä½œä¸ºå”¯ä¸€åˆ†ç‰‡é”®

**æ£€æµ‹æ–¹æ³•**ï¼š
```sql
-- æ£€æŸ¥å„åˆ†ç‰‡æ•°æ®é‡åˆ†å¸ƒ
SELECT 
    table_schema,
    table_name,
    table_rows,
    data_length
FROM information_schema.tables 
WHERE table_name LIKE 't_order_%'
ORDER BY table_rows DESC;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **é‡æ–°åˆ†ç‰‡**ï¼šè°ƒæ•´åˆ†ç‰‡ç®—æ³•é‡æ–°åˆ†å¸ƒæ•°æ®
- **çƒ­ç‚¹åˆ†ç‰‡æ‹†åˆ†**ï¼šå°†çƒ­ç‚¹åˆ†ç‰‡è¿›ä¸€æ­¥ç»†åˆ†
- **å¤åˆåˆ†ç‰‡é”®**ï¼šå¢åŠ é¢å¤–çš„åˆ†ç‰‡ç»´åº¦
- **åŠ¨æ€æ‰©å®¹**ï¼šå¢åŠ åˆ†ç‰‡èŠ‚ç‚¹åˆ†æ•£çƒ­ç‚¹

### 6. ShardingSphereå’ŒMyCatæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šä¸¤è€…éƒ½æ˜¯æµè¡Œçš„åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ï¼Œä½†æœ‰ä¸åŒç‰¹ç‚¹ï¼š

| ç‰¹æ€§ | ShardingSphere | MyCat |
|------|----------------|-------|
| æ¶æ„æ¨¡å¼ | Clientç«¯ã€Proxyç«¯ | Proxyç«¯ |
| æ€§èƒ½å½±å“ | è¾ƒå°ï¼ˆClientç«¯ï¼‰ | ä¸­ç­‰ |
| è¿ç»´å¤æ‚åº¦ | ä½ | é«˜ |
| åŠŸèƒ½ä¸°å¯Œåº¦ | ä¸°å¯Œ | ä¸­ç­‰ |
| ç¤¾åŒºæ´»è·ƒåº¦ | é«˜ | ä¸­ç­‰ |
| å­¦ä¹ æˆæœ¬ | ä½ | é«˜ |

**ShardingSphereä¼˜åŠ¿**ï¼š
- Apacheé¡¶çº§é¡¹ç›®ï¼Œç¤¾åŒºæ´»è·ƒ
- æ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼
- åŠŸèƒ½å…¨é¢ï¼Œç”Ÿæ€å®Œå–„
- æ–‡æ¡£å®Œå–„ï¼Œå­¦ä¹ æˆæœ¬ä½

**é€‰æ‹©å»ºè®®**ï¼šæ–°é¡¹ç›®æ¨èShardingSphereï¼Œå·²æœ‰MyCaté¡¹ç›®å¯ç»§ç»­ä½¿ç”¨ã€‚

### 7. åˆ†åº“åˆ†è¡¨åå¦‚ä½•ä¿è¯ä¸»é”®å”¯ä¸€æ€§ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¸»é”®ç”Ÿæˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼š

**å¸¸è§æ–¹æ¡ˆ**ï¼š

1. **æ•°æ®åº“è‡ªå¢ID + æ­¥é•¿**ï¼š
```sql
-- æ•°æ®åº“1ï¼šèµ·å§‹å€¼1ï¼Œæ­¥é•¿3
-- æ•°æ®åº“2ï¼šèµ·å§‹å€¼2ï¼Œæ­¥é•¿3  
-- æ•°æ®åº“3ï¼šèµ·å§‹å€¼3ï¼Œæ­¥é•¿3
```

2. **UUID**ï¼š
```java
String id = UUID.randomUUID().toString();
// ä¼˜ç‚¹ï¼šç®€å•ï¼Œç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå­˜å‚¨ç©ºé—´å¤§
```

3. **é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰**ï¼š
```java
// 64ä½ï¼š1ä½ç¬¦å· + 41ä½æ—¶é—´æˆ³ + 10ä½æœºå™¨ID + 12ä½åºåˆ—å·
long id = snowflakeIdGenerator.nextId();
```

4. **Redisç”Ÿæˆ**ï¼š
```java
Long id = redisTemplate.opsForValue().increment("order_id_seq");
```

**æ¨èæ–¹æ¡ˆ**ï¼šç”Ÿäº§ç¯å¢ƒæ¨èé›ªèŠ±ç®—æ³•ï¼Œå…¼é¡¾æ€§èƒ½å’Œå”¯ä¸€æ€§ã€‚

### 8. å¦‚ä½•ç›‘æ§åˆ†åº“åˆ†è¡¨çš„æ€§èƒ½ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šåˆ†åº“åˆ†è¡¨ç›‘æ§éœ€è¦å…³æ³¨å¤šä¸ªç»´åº¦ï¼š

**å…³é”®æŒ‡æ ‡**ï¼š
```java
// 1. åˆ†ç‰‡åˆ†å¸ƒå‡åŒ€åº¦
// 2. è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹
// 3. å„åˆ†ç‰‡å“åº”æ—¶é—´
// 4. æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
// 5. ä¸­é—´ä»¶æ€§èƒ½æŒ‡æ ‡
```

**ç›‘æ§å®ç°**ï¼š
```java
@Component
public class ShardingMonitor {
    
    @EventListener
    public void onSQLExecute(SQLExecuteEvent event) {
        // è®°å½•SQLæ‰§è¡Œæ—¶é—´
        long duration = event.getDuration();
        
        // ç»Ÿè®¡è·¨åˆ†ç‰‡æŸ¥è¯¢
        if (event.getRouteUnits().size() > 1) {
            crossShardQueryCounter.increment();
        }
        
        // è®°å½•æ…¢æŸ¥è¯¢
        if (duration > slowQueryThreshold) {
            logSlowQuery(event);
        }
    }
}
```

**å‘Šè­¦ç­–ç•¥**ï¼š
- åˆ†ç‰‡æ•°æ®å€¾æ–œè¶…è¿‡é˜ˆå€¼
- è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹è¿‡é«˜
- å•åˆ†ç‰‡å“åº”æ—¶é—´å¼‚å¸¸
- è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜

## âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### æ€§èƒ½ç“¶é¢ˆåˆ†æ

**åˆ†åº“åˆ†è¡¨å¸¸è§æ€§èƒ½ç“¶é¢ˆ**ï¼š

1. **è·¯ç”±è®¡ç®—å¼€é”€**ï¼šå¤æ‚åˆ†ç‰‡ç®—æ³•å½±å“è·¯ç”±æ€§èƒ½
2. **è·¨åˆ†ç‰‡æŸ¥è¯¢**ï¼šéœ€è¦åˆå¹¶å¤šä¸ªåˆ†ç‰‡ç»“æœï¼Œæ€§èƒ½å·®
3. **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šä¸¤é˜¶æ®µæäº¤ç­‰æœºåˆ¶å½±å“æ€§èƒ½
4. **è¿æ¥æ± ç®¡ç†**ï¼šå¤šæ•°æ®æºè¿æ¥æ± é…ç½®ä¸å½“
5. **æ•°æ®å€¾æ–œ**ï¼šçƒ­ç‚¹åˆ†ç‰‡æˆä¸ºç“¶é¢ˆ

**æ€§èƒ½ç›‘æ§æ–¹æ³•**ï¼š
```java
// ä½¿ç”¨Micrometerç›‘æ§åˆ†ç‰‡æ€§èƒ½
@Component
public class ShardingMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Timer.Sample routeTimer;
    
    public void recordRouteTime(String shardingKey, long duration) {
        Timer.builder("sharding.route.time")
             .tag("shard.key", shardingKey)
             .register(meterRegistry)
             .record(duration, TimeUnit.MILLISECONDS);
    }
    
    public void recordCrossShardQuery(int shardCount) {
        Counter.builder("sharding.cross.shard.query")
               .tag("shard.count", String.valueOf(shardCount))
               .register(meterRegistry)
               .increment();
    }
}
```

### ä¼˜åŒ–ç­–ç•¥æ–¹æ¡ˆ

**SQLä¼˜åŒ–ç­–ç•¥**ï¼š
```java
// 1. å¼ºåˆ¶è·¯ç”±ä¼˜åŒ–
@ShardingHint
public List<Order> getOrdersByUserId(Long userId) {
    // é€šè¿‡Hintå¼ºåˆ¶è·¯ç”±åˆ°æŒ‡å®šåˆ†ç‰‡
    HintManager.getInstance().addDatabaseShardingValue("t_order", userId);
    return orderMapper.selectByUserId(userId);
}

// 2. ç»‘å®šè¡¨ä¼˜åŒ–
// è®¢å•è¡¨å’Œè®¢å•æ˜ç»†è¡¨ä½¿ç”¨ç›¸åŒåˆ†ç‰‡é”®ï¼Œé¿å…è·¨åˆ†ç‰‡JOIN

// 3. å¹¿æ’­è¡¨ä¼˜åŒ–  
// å­—å…¸è¡¨ç­‰å°è¡¨é…ç½®ä¸ºå¹¿æ’­è¡¨ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½æœ‰å®Œæ•´æ•°æ®
```

**è¿æ¥æ± ä¼˜åŒ–**ï¼š
```yaml
# è¿æ¥æ± é…ç½®ä¼˜åŒ–
spring:
  shardingsphere:
    datasource:
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        maximum-pool-size: 20        # è¿æ¥æ± å¤§å°
        minimum-idle: 5              # æœ€å°ç©ºé—²è¿æ¥
        connection-timeout: 30000    # è¿æ¥è¶…æ—¶
        idle-timeout: 600000         # ç©ºé—²è¶…æ—¶
        max-lifetime: 1800000        # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
```

### å¸¸è§å‘ç‚¹è§„é¿

**åˆ†ç‰‡é”®è®¾è®¡é™·é˜±**ï¼š
```java
// é”™è¯¯ï¼šä½¿ç”¨è‡ªå¢IDä½œä¸ºåˆ†ç‰‡é”®
// é—®é¢˜ï¼šæ•°æ®åˆ†å¸ƒä¸å‡ï¼Œæ–°æ•°æ®éƒ½åœ¨æœ€åå‡ ä¸ªåˆ†ç‰‡
sharding-column: id
algorithm-expression: ds$->{id % 16}

// æ­£ç¡®ï¼šä½¿ç”¨ä¸šåŠ¡ç›¸å…³çš„å‡åŒ€åˆ†å¸ƒå­—æ®µ
sharding-column: user_id  
algorithm-expression: ds$->{user_id % 16}
```

**è·¨åˆ†ç‰‡æŸ¥è¯¢é™·é˜±**ï¼š
```sql
-- é”™è¯¯ï¼šæ²¡æœ‰åˆ†ç‰‡é”®çš„æŸ¥è¯¢å¯¼è‡´å…¨åˆ†ç‰‡æ‰«æ
SELECT * FROM t_order WHERE status = 'PAID';

-- æ­£ç¡®ï¼šåŒ…å«åˆ†ç‰‡é”®çš„æŸ¥è¯¢
SELECT * FROM t_order WHERE user_id = 12345 AND status = 'PAID';
```

**äº‹åŠ¡è¾¹ç•Œé™·é˜±**ï¼š
```java
// é”™è¯¯ï¼šè·¨åˆ†ç‰‡æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­
@Transactional
public void updateUserAndOrder(Long userId, Long orderId) {
    userService.updateUser(userId);    // å¯èƒ½åœ¨ä¸åŒåˆ†ç‰‡
    orderService.updateOrder(orderId); // å¯èƒ½åœ¨ä¸åŒåˆ†ç‰‡
}

// æ­£ç¡®ï¼šæ‹†åˆ†äº‹åŠ¡æˆ–ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡
public void updateUserAndOrder(Long userId, Long orderId) {
    userService.updateUser(userId);
    // ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†è®¢å•æ›´æ–°
    messageQueue.send(new UpdateOrderMessage(orderId));
}
```

## ğŸ“š æ€»ç»“ä¸æŠ€æœ¯å¯¹æ¯”

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³å¤§è§„æ¨¡æ•°æ®å­˜å‚¨å’Œé«˜å¹¶å‘è®¿é—®çš„é‡è¦æŠ€æœ¯ï¼Œæ ¸å¿ƒè¦ç‚¹åŒ…æ‹¬ï¼š

**è®¾è®¡åŸåˆ™æŒæ¡**ï¼šç†è§£æ°´å¹³åˆ†ç‰‡ã€å‚ç›´åˆ†ç‰‡çš„é€‚ç”¨åœºæ™¯ï¼ŒæŒæ¡åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™ã€‚**ä¸­é—´ä»¶ä½¿ç”¨**ï¼šç†Ÿç»ƒä½¿ç”¨ShardingSphereç­‰åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ï¼Œç†è§£å…¶å·¥ä½œåŸç†ã€‚**æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Œåˆç†è®¾è®¡ç»‘å®šè¡¨å’Œå¹¿æ’­è¡¨ï¼Œä¼˜åŒ–SQLæ‰§è¡Œæ•ˆç‡ã€‚**æ•°æ®è¿ç§»**ï¼šæŒæ¡åœ¨çº¿è¿ç§»ç­–ç•¥ï¼Œä¿è¯ä¸šåŠ¡è¿ç»­æ€§å’Œæ•°æ®ä¸€è‡´æ€§ã€‚**ç›‘æ§è¿ç»´**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³æ•°æ®å€¾æ–œç­‰é—®é¢˜ã€‚

### ä¸ç›¸å…³æŠ€æœ¯å¯¹æ¯”

| ç‰¹æ€§ | åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ | åˆ†å¸ƒå¼æ•°æ®åº“ | NoSQLæ•°æ®åº“ | åˆ†åŒºè¡¨ |
|------|---------------|-------------|------------|--------|
| æ‰©å±•æ€§ | æ°´å¹³æ‰©å±• | æ°´å¹³æ‰©å±• | æ°´å¹³æ‰©å±• | å‚ç›´æ‰©å±• |
| ä¸€è‡´æ€§ | å¯è°ƒèŠ‚ | å¼ºä¸€è‡´æ€§ | æœ€ç»ˆä¸€è‡´æ€§ | å¼ºä¸€è‡´æ€§ |
| å¤æ‚åº¦ | ä¸­ç­‰ | ä½ | ä½ | ä½ |
| ç”Ÿæ€å…¼å®¹ | é«˜ï¼ˆå…¼å®¹MySQLï¼‰ | ä¸­ç­‰ | ä½ | é«˜ |
| è¿ç»´æˆæœ¬ | ä¸­ç­‰ | ä½ | ä¸­ç­‰ | ä½ |
| é€‚ç”¨åœºæ™¯ | ä¼ ç»Ÿåº”ç”¨æ”¹é€  | æ–°åº”ç”¨å¼€å‘ | ç‰¹å®šåœºæ™¯ | å•æœºä¼˜åŒ– |

**åˆ†åº“åˆ†è¡¨çš„ä¼˜åŠ¿**ï¼š
- å…¼å®¹ç°æœ‰MySQLç”Ÿæ€
- æ¸è¿›å¼æ”¹é€ ï¼Œé£é™©å¯æ§
- æŠ€æœ¯æˆç†Ÿï¼Œæ¡ˆä¾‹ä¸°å¯Œ
- æˆæœ¬ç›¸å¯¹è¾ƒä½

**åˆ†åº“åˆ†è¡¨çš„å±€é™**ï¼š
- è·¨åˆ†ç‰‡æ“ä½œå¤æ‚
- è¿ç»´å¤æ‚åº¦å¢åŠ 
- æ•°æ®è¿ç§»æˆæœ¬é«˜
- éœ€è¦æ”¹é€ åº”ç”¨ä»£ç 

### æŒç»­å­¦ä¹ å»ºè®®

**æ·±å…¥å­¦ä¹ æ–¹å‘**ï¼š
1. **åˆ†å¸ƒå¼æ•°æ®åº“**ï¼šå­¦ä¹ TiDBã€CockroachDBç­‰æ–°ä¸€ä»£åˆ†å¸ƒå¼æ•°æ®åº“
2. **æ•°æ®åº“ä¸­é—´ä»¶**ï¼šæ·±å…¥ç ”ç©¶ShardingSphereã€Vitessç­‰ä¸­é—´ä»¶æºç 
3. **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šæŒæ¡Sagaã€TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼
4. **æ•°æ®æ²»ç†**ï¼šå­¦ä¹ æ•°æ®è¡€ç¼˜ã€æ•°æ®è´¨é‡ç­‰æ•°æ®æ²»ç†æŠ€æœ¯

**å­¦ä¹ èµ„æºæ¨è**ï¼š
- ã€Šåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»ŸåŸç†ã€‹- ç†è®ºåŸºç¡€
- ShardingSphereå®˜æ–¹æ–‡æ¡£ - å®è·µæŒ‡å—
- ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹- æ¶æ„è®¾è®¡
- å„å¤§å…¬å¸çš„åˆ†åº“åˆ†è¡¨å®è·µåˆ†äº«

**å®è·µå»ºè®®**ï¼š
ä»å°è§„æ¨¡å¼€å§‹å®è·µåˆ†åº“åˆ†è¡¨ï¼Œé€æ­¥ç§¯ç´¯ç»éªŒã€‚é‡ç‚¹å…³æ³¨ä¸šåŠ¡åœºæ™¯åˆ†æã€åˆ†ç‰‡ç­–ç•¥è®¾è®¡ã€æ€§èƒ½ç›‘æ§ç­‰å…³é”®ç¯èŠ‚ã€‚åŒæ—¶è¦å…³æ³¨æ–°æŠ€æœ¯å‘å±•ï¼Œé€‚æ—¶å¼•å…¥æ›´å…ˆè¿›çš„è§£å†³æ–¹æ¡ˆã€‚

è®°ä½ï¼Œåˆ†åº“åˆ†è¡¨ä¸æ˜¯é“¶å¼¹ï¼Œéœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆã€‚åœ¨è¿½æ±‚æŠ€æœ¯å…ˆè¿›æ€§çš„åŒæ—¶ï¼Œä¹Ÿè¦è€ƒè™‘å›¢é˜ŸæŠ€æœ¯æ°´å¹³ã€è¿ç»´èƒ½åŠ›ã€æˆæœ¬é¢„ç®—ç­‰ç°å®å› ç´ ã€‚ 