---
title: "RabbitMQæ¶ˆæ¯å¯é æ€§ä¿è¯æœºåˆ¶æ·±åº¦è§£æ"
description: "æ·±å…¥æ¢è®¨RabbitMQæ¶ˆæ¯å¯é æ€§ä¿è¯çš„æ ¸å¿ƒæœºåˆ¶ï¼ŒåŒ…æ‹¬ç”Ÿäº§è€…ç¡®è®¤ã€æ¶ˆè´¹è€…ç¡®è®¤ã€æ¶ˆæ¯æŒä¹…åŒ–å’Œäº‹åŠ¡å¤„ç†ï¼Œç»“åˆå®é™…é¡¹ç›®ç»éªŒåˆ†äº«é«˜å¯é æ¶ˆæ¯ç³»ç»Ÿè®¾è®¡ã€‚"
pubDate: 2024-12-28
updatedDate: 2024-12-28
tags: ["rabbitmq", "message-queue", "reliability", "transaction", "durability", "distributed-system", "interview", "best-practices"]
categories: ["middleware"]
subject: "æ¶ˆæ¯é˜Ÿåˆ—å¯é æ€§"
draft: false
featured: true
author: "Gerrad Zhang"
location: "æ­¦æ±‰ï¼Œä¸­å›½"
---

## ğŸ¤” é—®é¢˜èƒŒæ™¯ä¸æŠ€æœ¯æ¼”è¿›

### æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡é—´é€šä¿¡çš„å¯é æ€§è‡³å…³é‡è¦ã€‚æ¶ˆæ¯ä¸¢å¤±å¯èƒ½å¯¼è‡´ï¼š**æ•°æ®ä¸ä¸€è‡´**ã€**ä¸šåŠ¡æµç¨‹ä¸­æ–­**ã€**ç”¨æˆ·ä½“éªŒä¸‹é™**ã€**è´¢åŠ¡æŸå¤±**ç­‰ä¸¥é‡åæœã€‚

RabbitMQæ¶ˆæ¯å¯é æ€§è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š**æ¶ˆæ¯ä¸ä¸¢å¤±**ã€**æ¶ˆæ¯ä¸é‡å¤**ã€**æ¶ˆæ¯æœ‰åºæ€§**ã€**æ•…éšœæ¢å¤**ã€‚

### æ²¡æœ‰è¿™ä¸ªæŠ€æœ¯æ—¶æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

æ—©æœŸåˆ†å¸ƒå¼ç³»ç»Ÿä¸»è¦é€šè¿‡ï¼š**åŒæ­¥è°ƒç”¨**ã€**æ•°æ®åº“è½®è¯¢**ã€**æ–‡ä»¶ä¼ è¾“**ç­‰æ–¹å¼å®ç°æœåŠ¡é—´é€šä¿¡ï¼Œå­˜åœ¨è€¦åˆåº¦é«˜ã€æ€§èƒ½å·®ã€å¯é æ€§ä¸è¶³ç­‰é—®é¢˜ã€‚

### æŠ€æœ¯æ¼”è¿›çš„å†å²è„‰ç»œ

æ¶ˆæ¯é˜Ÿåˆ—ä»**ç‚¹å¯¹ç‚¹æ¨¡å¼** â†’ **å‘å¸ƒè®¢é˜…æ¨¡å¼** â†’ **é«˜å¯é æ¶ˆæ¯é˜Ÿåˆ—** â†’ **æµå¼å¤„ç†å¹³å°**ä¸æ–­æ¼”è¿›ï¼ŒRabbitMQä½œä¸ºAMQPåè®®çš„å®ç°ï¼Œæä¾›äº†å®Œå–„çš„å¯é æ€§ä¿è¯æœºåˆ¶ã€‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µä¸åŸç†

### åŸºç¡€æ¦‚å¿µå®šä¹‰

**æ¶ˆæ¯å¯é æ€§**ï¼šä¿è¯æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„å®Œæ•´ä¼ é€’ï¼ŒåŒ…æ‹¬æ¶ˆæ¯ä¸ä¸¢å¤±ã€ä¸é‡å¤ã€æœ‰åºæ€§ç­‰ç‰¹æ€§ã€‚

**ç”Ÿäº§è€…ç¡®è®¤**ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼Œæ¥æ”¶æ¥è‡ªRabbitMQçš„ç¡®è®¤åº”ç­”ï¼Œç¡®ä¿æ¶ˆæ¯å·²è¢«æ­£ç¡®æ¥æ”¶ã€‚

**æ¶ˆè´¹è€…ç¡®è®¤**ï¼šæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯åï¼Œå‘RabbitMQå‘é€ç¡®è®¤åº”ç­”ï¼Œç¡®ä¿æ¶ˆæ¯å·²è¢«æ­£ç¡®å¤„ç†ã€‚

**æ¶ˆæ¯æŒä¹…åŒ–**ï¼šå°†æ¶ˆæ¯å­˜å‚¨åˆ°ç£ç›˜ï¼Œç¡®ä¿RabbitMQé‡å¯åæ¶ˆæ¯ä¸ä¸¢å¤±ã€‚

### å·¥ä½œåŸç†è¯¦è§£

RabbitMQå¯é æ€§æœºåˆ¶åŒ…æ‹¬ï¼š**ç”Ÿäº§è€…åˆ°äº¤æ¢æœºçš„ç¡®è®¤**ã€**äº¤æ¢æœºåˆ°é˜Ÿåˆ—çš„ç¡®è®¤**ã€**é˜Ÿåˆ—çš„æŒä¹…åŒ–å­˜å‚¨**ã€**æ¶ˆè´¹è€…çš„ç¡®è®¤æœºåˆ¶**ã€‚

### æŠ€æœ¯ç‰¹ç‚¹å’Œä¼˜åŠ¿

RabbitMQæä¾›ï¼š**å¤šå±‚çº§ç¡®è®¤æœºåˆ¶**ã€**çµæ´»çš„æŒä¹…åŒ–ç­–ç•¥**ã€**äº‹åŠ¡æ”¯æŒ**ã€**é«˜å¯ç”¨é›†ç¾¤**ã€**å®Œå–„çš„ç›‘æ§ä½“ç³»**ã€‚

## ğŸ”§ å®ç°åŸç†ä¸æºç åˆ†æ

### åº•å±‚å®ç°æœºåˆ¶

**ç¡®è®¤æœºåˆ¶å®ç°**ï¼š
- Publisher Confirmsï¼šç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶
- Consumer Acknowledgmentsï¼šæ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶
- Mandatory/Immediateï¼šæ¶ˆæ¯è·¯ç”±ç¡®è®¤

**æŒä¹…åŒ–å®ç°**ï¼š
- ExchangeæŒä¹…åŒ–ï¼šäº¤æ¢æœºå…ƒæ•°æ®æŒä¹…åŒ–
- QueueæŒä¹…åŒ–ï¼šé˜Ÿåˆ—å…ƒæ•°æ®æŒä¹…åŒ–  
- MessageæŒä¹…åŒ–ï¼šæ¶ˆæ¯å†…å®¹æŒä¹…åŒ–

### å…³é”®æºç è§£è¯»

```erlang
%% ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶æ ¸å¿ƒå®ç°
handle_method(#'confirm.select'{}, _, State) ->
    State1 = State#ch{confirm_enabled = true},
    {reply, #'confirm.select_ok'{}, State1};

%% æ¶ˆæ¯ç¡®è®¤å¤„ç†
confirm_messages(MsgSeqNos, State = #ch{confirmed = C}) ->
    State#ch{confirmed = gb_sets:union(C, gb_sets:from_list(MsgSeqNos))}.

%% æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶
handle_method(#'basic.ack'{delivery_tag = DeliveryTag,
                          multiple = Multiple}, _, State) ->
    case ack(DeliveryTag, Multiple, State) of
        {ok, State1} -> {noreply, State1};
        {error, Reason} -> {error, Reason}
    end.
```

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ä¸ä»£ç ç¤ºä¾‹

### å…·ä½“é¡¹ç›®åº”ç”¨

åœ¨ç”µå•†è®¢å•ç³»ç»Ÿä¸­ï¼Œéœ€è¦ä¿è¯è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜å¤„ç†ç­‰æ­¥éª¤çš„æ¶ˆæ¯å¯é ä¼ é€’ã€‚é€šè¿‡RabbitMQçš„å¯é æ€§æœºåˆ¶ï¼Œå®ç°äº†99.99%çš„æ¶ˆæ¯æŠ•é€’æˆåŠŸç‡ã€‚

### å®Œæ•´ä»£ç å®ç°

**ç”Ÿäº§è€…å¯é æ€§é…ç½®**ï¼š

```java
@Configuration
public class RabbitConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å¼€å¯ç”Ÿäº§è€…ç¡®è®¤
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                log.info("æ¶ˆæ¯å‘é€æˆåŠŸ: {}", correlationData);
            } else {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥: {}, åŸå› : {}", correlationData, cause);
                // é‡è¯•æˆ–è®°å½•å¤±è´¥æ¶ˆæ¯
                handleFailedMessage(correlationData);
            }
        });
        
        // å¼€å¯æ¶ˆæ¯è¿”å›ç¡®è®¤
        template.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -> {
            log.error("æ¶ˆæ¯è·¯ç”±å¤±è´¥: exchange={}, routingKey={}, replyCode={}, replyText={}", 
                exchange, routingKey, replyCode, replyText);
            // å¤„ç†è·¯ç”±å¤±è´¥çš„æ¶ˆæ¯
            handleReturnedMessage(message, exchange, routingKey);
        });
        
        // å¼€å¯å¼ºåˆ¶æ¨¡å¼
        template.setMandatory(true);
        
        return template;
    }
    
    private void handleFailedMessage(CorrelationData correlationData) {
        // é‡è¯•é€»è¾‘æˆ–è®°å½•åˆ°å¤±è´¥è¡¨
        String messageId = correlationData.getId();
        // ä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–åŸå§‹æ¶ˆæ¯è¿›è¡Œé‡è¯•
        retryService.retryMessage(messageId);
    }
    
    private void handleReturnedMessage(Message message, String exchange, String routingKey) {
        // è®°å½•è·¯ç”±å¤±è´¥çš„æ¶ˆæ¯
        String messageBody = new String(message.getBody());
        log.error("è·¯ç”±å¤±è´¥æ¶ˆæ¯: {}", messageBody);
        // å¯ä»¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—æˆ–å‘Šè­¦
    }
}
```

**å¯é æ¶ˆæ¯å‘é€æœåŠ¡**ï¼š

```java
@Service
public class ReliableMessageService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private MessageLogService messageLogService;
    
    /**
     * å¯é æ¶ˆæ¯å‘é€
     */
    public void sendReliableMessage(String exchange, String routingKey, Object message) {
        // 1. ç”Ÿæˆæ¶ˆæ¯ID
        String messageId = UUID.randomUUID().toString();
        
        // 2. è®°å½•æ¶ˆæ¯æ—¥å¿—
        MessageLog messageLog = new MessageLog();
        messageLog.setMessageId(messageId);
        messageLog.setExchange(exchange);
        messageLog.setRoutingKey(routingKey);
        messageLog.setMessage(JSON.toJSONString(message));
        messageLog.setStatus(MessageStatus.SENDING);
        messageLog.setCreateTime(new Date());
        messageLogService.save(messageLog);
        
        try {
            // 3. å‘é€æ¶ˆæ¯
            CorrelationData correlationData = new CorrelationData(messageId);
            rabbitTemplate.convertAndSend(exchange, routingKey, message, correlationData);
            
            // 4. æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå·²å‘é€
            messageLogService.updateStatus(messageId, MessageStatus.SENT);
            
        } catch (Exception e) {
            // 5. å‘é€å¤±è´¥ï¼Œæ›´æ–°çŠ¶æ€
            messageLogService.updateStatus(messageId, MessageStatus.FAILED);
            log.error("æ¶ˆæ¯å‘é€å¼‚å¸¸: messageId={}", messageId, e);
            throw e;
        }
    }
    
    /**
     * é‡è¯•å¤±è´¥æ¶ˆæ¯
     */
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void retryFailedMessages() {
        List<MessageLog> failedMessages = messageLogService.getFailedMessages();
        
        for (MessageLog messageLog : failedMessages) {
            try {
                // é‡è¯•æ¬¡æ•°é™åˆ¶
                if (messageLog.getRetryCount() >= 3) {
                    messageLogService.updateStatus(messageLog.getMessageId(), MessageStatus.DEAD);
                    continue;
                }
                
                // é‡æ–°å‘é€æ¶ˆæ¯
                CorrelationData correlationData = new CorrelationData(messageLog.getMessageId());
                rabbitTemplate.convertAndSend(
                    messageLog.getExchange(),
                    messageLog.getRoutingKey(),
                    JSON.parseObject(messageLog.getMessage()),
                    correlationData
                );
                
                // æ›´æ–°é‡è¯•æ¬¡æ•°
                messageLogService.incrementRetryCount(messageLog.getMessageId());
                
            } catch (Exception e) {
                log.error("é‡è¯•æ¶ˆæ¯å¤±è´¥: messageId={}", messageLog.getMessageId(), e);
            }
        }
    }
}
```

**æ¶ˆè´¹è€…å¯é æ€§é…ç½®**ï¼š

```java
@Component
public class OrderMessageConsumer {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private MessageIdempotentService idempotentService;
    
    @RabbitListener(
        queues = "order.create.queue",
        ackMode = "MANUAL" // æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼
    )
    public void handleOrderCreate(
        @Payload OrderCreateMessage message,
        @Header Map<String, Object> headers,
        Channel channel,
        @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag
    ) {
        
        String messageId = (String) headers.get("messageId");
        
        try {
            // 1. å¹‚ç­‰æ€§æ£€æŸ¥
            if (idempotentService.isProcessed(messageId)) {
                log.info("æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: messageId={}", messageId);
                channel.basicAck(deliveryTag, false);
                return;
            }
            
            // 2. ä¸šåŠ¡å¤„ç†
            orderService.createOrder(message);
            
            // 3. è®°å½•å¤„ç†çŠ¶æ€
            idempotentService.markProcessed(messageId);
            
            // 4. æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯
            channel.basicAck(deliveryTag, false);
            
            log.info("è®¢å•åˆ›å»ºæ¶ˆæ¯å¤„ç†æˆåŠŸ: messageId={}", messageId);
            
        } catch (Exception e) {
            log.error("è®¢å•åˆ›å»ºæ¶ˆæ¯å¤„ç†å¤±è´¥: messageId={}", messageId, e);
            
            try {
                // 5. åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
                if (shouldRetry(e)) {
                    // æ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ
                    channel.basicNack(deliveryTag, false, true);
                } else {
                    // æ‹’ç»æ¶ˆæ¯å¹¶ä¸¢å¼ƒï¼ˆå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼‰
                    channel.basicNack(deliveryTag, false, false);
                }
            } catch (IOException ioException) {
                log.error("æ¶ˆæ¯ç¡®è®¤å¤±è´¥", ioException);
            }
        }
    }
    
    private boolean shouldRetry(Exception e) {
        // æ ¹æ®å¼‚å¸¸ç±»å‹åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•
        return !(e instanceof IllegalArgumentException);
    }
}
```

**äº‹åŠ¡æ¶ˆæ¯å®ç°**ï¼š

```java
@Service
public class TransactionalMessageService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private OrderService orderService;
    
    /**
     * äº‹åŠ¡æ¶ˆæ¯å‘é€
     */
    @Transactional
    public void sendTransactionalMessage(OrderCreateRequest request) {
        try {
            // 1. å¼€å¯RabbitMQäº‹åŠ¡
            rabbitTemplate.execute(channel -> {
                channel.txSelect(); // å¼€å¯äº‹åŠ¡
                
                try {
                    // 2. æ‰§è¡Œæœ¬åœ°ä¸šåŠ¡
                    Order order = orderService.createOrder(request);
                    
                    // 3. å‘é€æ¶ˆæ¯
                    OrderCreateMessage message = new OrderCreateMessage();
                    message.setOrderId(order.getOrderId());
                    message.setUserId(order.getUserId());
                    
                    channel.basicPublish(
                        "order.exchange",
                        "order.create",
                        MessageProperties.PERSISTENT_TEXT_PLAIN,
                        JSON.toJSONString(message).getBytes()
                    );
                    
                    // 4. æäº¤äº‹åŠ¡
                    channel.txCommit();
                    
                    return null;
                    
                } catch (Exception e) {
                    // 5. å›æ»šäº‹åŠ¡
                    channel.txRollback();
                    throw new RuntimeException("äº‹åŠ¡æ¶ˆæ¯å‘é€å¤±è´¥", e);
                }
            });
            
        } catch (Exception e) {
            log.error("äº‹åŠ¡æ¶ˆæ¯å¤„ç†å¤±è´¥", e);
            throw e;
        }
    }
}
```

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜ç²¾è®²

### 1. RabbitMQå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šRabbitMQé€šè¿‡å¤šå±‚æœºåˆ¶ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼š

**ç”Ÿäº§è€…ç«¯**ï¼š
- å¼€å¯Publisher Confirmsç¡®è®¤æœºåˆ¶
- ä½¿ç”¨Mandatoryæ ‡å¿—ç¡®ä¿æ¶ˆæ¯è·¯ç”±æˆåŠŸ
- å®ç°æ¶ˆæ¯é‡è¯•å’Œå¤±è´¥å¤„ç†é€»è¾‘

**RabbitMQç«¯**ï¼š
- äº¤æ¢æœºã€é˜Ÿåˆ—ã€æ¶ˆæ¯æŒä¹…åŒ–
- é›†ç¾¤æ¨¡å¼æä¾›é«˜å¯ç”¨æ€§
- é•œåƒé˜Ÿåˆ—ä¿è¯æ•°æ®å†—ä½™

**æ¶ˆè´¹è€…ç«¯**ï¼š
- æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼ï¼ˆMANUALï¼‰
- ä¸šåŠ¡å¤„ç†æˆåŠŸåå†ç¡®è®¤æ¶ˆæ¯
- å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 2. ä»€ä¹ˆæ˜¯Publisher Confirmsï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šPublisher Confirmsæ˜¯RabbitMQæä¾›çš„ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼š

**å·¥ä½œåŸç†**ï¼š
- ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°RabbitMQ
- RabbitMQæ¥æ”¶æ¶ˆæ¯åå‘é€ç¡®è®¤åº”ç­”
- ç”Ÿäº§è€…æ ¹æ®ç¡®è®¤ç»“æœå†³å®šåç»­å¤„ç†

**ä½¿ç”¨æ–¹å¼**ï¼š
```java
// åŒæ­¥ç¡®è®¤
channel.confirmSelect();
channel.basicPublish(exchange, routingKey, null, message);
if (channel.waitForConfirms()) {
    System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸ");
}

// å¼‚æ­¥ç¡®è®¤
channel.confirmSelect();
channel.addConfirmListener(new ConfirmListener() {
    public void handleAck(long deliveryTag, boolean multiple) {
        // ç¡®è®¤æˆåŠŸå¤„ç†
    }
    public void handleNack(long deliveryTag, boolean multiple) {
        // ç¡®è®¤å¤±è´¥å¤„ç†
    }
});
```

### 3. RabbitMQçš„äº‹åŠ¡æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šRabbitMQæä¾›ä¸¤ç§äº‹åŠ¡æœºåˆ¶ï¼š

**AMQPäº‹åŠ¡**ï¼š
```java
channel.txSelect();   // å¼€å¯äº‹åŠ¡
channel.basicPublish(...);
channel.txCommit();   // æäº¤äº‹åŠ¡
// æˆ– channel.txRollback(); // å›æ»šäº‹åŠ¡
```

**Publisher Confirms**ï¼š
- æ€§èƒ½æ›´å¥½çš„å¼‚æ­¥ç¡®è®¤æœºåˆ¶
- ä¸æ”¯æŒå›æ»šï¼Œä½†æä¾›æ›´é«˜çš„ååé‡

**é€‰æ‹©å»ºè®®**ï¼š
- å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼šä½¿ç”¨Publisher Confirms
- éœ€è¦ä¸¥æ ¼äº‹åŠ¡è¯­ä¹‰ï¼šä½¿ç”¨AMQPäº‹åŠ¡

### 4. å¦‚ä½•å¤„ç†æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šæ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„è§£å†³æ–¹æ¡ˆï¼š

**å¹‚ç­‰æ€§è®¾è®¡**ï¼š
```java
@Service
public class IdempotentService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    public boolean isProcessed(String messageId) {
        return redisTemplate.hasKey("processed:" + messageId);
    }
    
    public void markProcessed(String messageId) {
        redisTemplate.opsForValue().set("processed:" + messageId, "1", 
            Duration.ofHours(24));
    }
}
```

**æ•°æ®åº“å”¯ä¸€çº¦æŸ**ï¼š
```sql
-- åœ¨ä¸šåŠ¡è¡¨ä¸­æ·»åŠ æ¶ˆæ¯IDå­—æ®µå’Œå”¯ä¸€ç´¢å¼•
ALTER TABLE orders ADD COLUMN message_id VARCHAR(64);
CREATE UNIQUE INDEX uk_orders_message_id ON orders(message_id);
```

**ä¸šåŠ¡é€»è¾‘å¹‚ç­‰**ï¼š
- è®¾è®¡å¤©ç„¶å¹‚ç­‰çš„ä¸šåŠ¡æ“ä½œ
- ä½¿ç”¨ç‰ˆæœ¬å·æˆ–çŠ¶æ€æœºæ§åˆ¶

### 5. å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**ï¼šæ¶ˆæ¯é¡ºåºæ€§ä¿è¯ç­–ç•¥ï¼š

**å•é˜Ÿåˆ—å•æ¶ˆè´¹è€…**ï¼š
- å°†éœ€è¦é¡ºåºå¤„ç†çš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€é˜Ÿåˆ—
- ä½¿ç”¨å•ä¸ªæ¶ˆè´¹è€…ä¸²è¡Œå¤„ç†

**åˆ†åŒºé˜Ÿåˆ—**ï¼š
```java
// æ ¹æ®ä¸šåŠ¡keyè·¯ç”±åˆ°ç‰¹å®šé˜Ÿåˆ—
String routingKey = "order." + (orderId % 10);
rabbitTemplate.convertAndSend("order.exchange", routingKey, message);
```

**æ¶ˆè´¹è€…ç«¯æ’åº**ï¼š
- æ¶ˆè´¹è€…ç«¯æ ¹æ®æ—¶é—´æˆ³æˆ–åºå·æ’åº
- é€‚ç”¨äºå¯¹é¡ºåºè¦æ±‚ä¸ä¸¥æ ¼çš„åœºæ™¯

## âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹

### æ€§èƒ½ç“¶é¢ˆåˆ†æ

**å¸¸è§æ€§èƒ½ç“¶é¢ˆ**ï¼š
1. **ç¡®è®¤æœºåˆ¶å¼€é”€**ï¼šåŒæ­¥ç¡®è®¤å½±å“ååé‡
2. **æŒä¹…åŒ–å¼€é”€**ï¼šç£ç›˜IOæˆä¸ºç“¶é¢ˆ
3. **ç½‘ç»œå»¶è¿Ÿ**ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ç½‘ç»œå»¶è¿Ÿ
4. **æ¶ˆæ¯å †ç§¯**ï¼šæ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§é€Ÿåº¦

### ä¼˜åŒ–ç­–ç•¥æ–¹æ¡ˆ

**æ‰¹é‡ç¡®è®¤ä¼˜åŒ–**ï¼š
```java
// æ‰¹é‡å‘é€æ¶ˆæ¯
List<Object> messages = Arrays.asList(msg1, msg2, msg3);
rabbitTemplate.convertAndSend(exchange, routingKey, messages);
```

**å¼‚æ­¥å¤„ç†ä¼˜åŒ–**ï¼š
```java
@Async
public void processMessage(Message message) {
    // å¼‚æ­¥å¤„ç†æ¶ˆæ¯ï¼Œæé«˜ååé‡
}
```

### å¸¸è§å‘ç‚¹è§„é¿

**ç¡®è®¤æœºåˆ¶è¯¯åŒº**ï¼š
- ä¸è¦åœ¨é«˜å¹¶å‘åœºæ™¯ä½¿ç”¨åŒæ­¥ç¡®è®¤
- åˆç†è®¾ç½®ç¡®è®¤è¶…æ—¶æ—¶é—´
- é¿å…ç¡®è®¤æœºåˆ¶ä¸äº‹åŠ¡æ··ç”¨

**æŒä¹…åŒ–é…ç½®è¯¯åŒº**ï¼š
- æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æŒä¹…åŒ–çº§åˆ«
- é¿å…ä¸å¿…è¦çš„æŒä¹…åŒ–å¼€é”€
- åˆç†é…ç½®åˆ·ç›˜ç­–ç•¥

## ğŸ“š æ€»ç»“ä¸æŠ€æœ¯å¯¹æ¯”

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

RabbitMQæ¶ˆæ¯å¯é æ€§éœ€è¦æŒæ¡ï¼š**ç¡®è®¤æœºåˆ¶**ã€**æŒä¹…åŒ–ç­–ç•¥**ã€**äº‹åŠ¡å¤„ç†**ã€**å¹‚ç­‰æ€§è®¾è®¡**ã€**æ€§èƒ½ä¼˜åŒ–**ç­‰æ ¸å¿ƒæŠ€èƒ½ã€‚

### ä¸ç›¸å…³æŠ€æœ¯å¯¹æ¯”

| ç‰¹æ€§ | RabbitMQ | Kafka | RocketMQ | ActiveMQ |
|------|----------|-------|----------|----------|
| ç¡®è®¤æœºåˆ¶ | å®Œå–„ | ç®€å• | å®Œå–„ | å®Œå–„ |
| äº‹åŠ¡æ”¯æŒ | æ”¯æŒ | æœ‰é™æ”¯æŒ | æ”¯æŒ | æ”¯æŒ |
| æ€§èƒ½ | ä¸­ç­‰ | é«˜ | é«˜ | ä¸­ç­‰ |
| å¯é æ€§ | é«˜ | é«˜ | é«˜ | ä¸­ç­‰ |
| å¤æ‚åº¦ | ä¸­ç­‰ | ä½ | ä¸­ç­‰ | ä½ |

### æŒç»­å­¦ä¹ å»ºè®®

**æ·±å…¥å­¦ä¹ æ–¹å‘**ï¼š
1. **AMQPåè®®æ·±å…¥**ï¼šç†è§£åè®®å±‚é¢çš„å¯é æ€§ä¿è¯
2. **é›†ç¾¤æ¶æ„è®¾è®¡**ï¼šå­¦ä¹ é«˜å¯ç”¨é›†ç¾¤æ­å»º
3. **æ€§èƒ½è°ƒä¼˜å®æˆ˜**ï¼šç§¯ç´¯å¤§è§„æ¨¡éƒ¨ç½²ç»éªŒ
4. **æ–°æŠ€æœ¯è¶‹åŠ¿**ï¼šå…³æ³¨æ¶ˆæ¯é˜Ÿåˆ—æŠ€æœ¯å‘å±•

**å®è·µå»ºè®®**ï¼š
ä»åŸºç¡€çš„ç¡®è®¤æœºåˆ¶å¼€å§‹ï¼Œé€æ­¥æŒæ¡å¤æ‚çš„å¯é æ€§ä¿è¯æ–¹æ¡ˆã€‚é‡è§†ç›‘æ§å’Œæ•…éšœæ¼”ç»ƒï¼Œå»ºç«‹å®Œå–„çš„æ¶ˆæ¯ç³»ç»Ÿè¿ç»´ä½“ç³»ã€‚ 